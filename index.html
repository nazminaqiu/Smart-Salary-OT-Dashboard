<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Salary & OT Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <style>
    :root {
      --bg-primary: #1a1a2e;
      --bg-secondary: #161625;
      --card: #24243e;
      --card-hover: #2a2a4a;
      --muted: #8f8f9e;
      --text: #e0e0eb;
      --accent: #ff79c6;
      --accent-hover: #ff92d4;
      --success: #50fa7b;
      --warning: #f1fa8c;
      --danger: #ff5555;
      --border: #3a3a5a;
      --border-light: #4a4a6a;
      --shadow: 0 10px 30px rgba(0,0,0,.3);
      --shadow-light: 0 4px 12px rgba(0,0,0,.15);
      --radius: 12px;
      --radius-sm: 8px;
      --transition: all 0.3s ease;
    }
    
    * { 
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    
    html, body { height: 100% }
    body {
      margin: 0; 
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
      color: var(--text);
      line-height: 1.6;
    }
    
    .wrap { 
      max-width: 1800px; 
      margin: 32px auto; 
      padding: 0 24px;
      animation: fadeIn 0.8s cubic-bezier(0.25, 1, 0.5, 1);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    header { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 20px; 
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }
    
    h1 { 
      font-size: 36px; 
      font-weight: 700;
      margin: 0;
      background: linear-gradient(135deg, var(--accent), var(--success));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .card { 
      background: var(--card); 
      border: 1px solid var(--border); 
      border-radius: var(--radius); 
      box-shadow: var(--shadow-light);
      transition: var(--transition);
      backdrop-filter: blur(10px);
      background: rgba(36, 36, 62, 0.7);
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 24px rgba(0,0,0,.2);
      border-color: var(--border-light);
    }
    
    .panel { padding: 28px }
    
    .grid { display: grid; gap: 24px }
    .grid-2 { grid-template-columns: 1fr 1fr }
    .grid-3 { grid-template-columns: repeat(3, 1fr) }
    .grid-4 { 
      grid-template-columns: repeat(4, 1fr);
      align-items: end; 
    }
    .grid-6 { 
      grid-template-columns: repeat(6, 1fr);
      align-items: end; 
    }
    
    @media (max-width: 1200px) { .grid-4, .grid-6 { grid-template-columns: repeat(3, 1fr) } }
    @media (max-width: 900px) { .grid-2, .grid-3, .grid-4, .grid-6 { grid-template-columns: 1fr } }
    
    label { 
      font-size: 14px; 
      color: var(--muted); 
      display: block; 
      margin-bottom: 8px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    input, select { 
      width: 100%; 
      padding: 12px 16px; 
      border-radius: var(--radius-sm); 
      border: 1px solid var(--border); 
      background: rgba(22, 22, 37, 0.8); 
      color: var(--text); 
      outline: none;
      transition: var(--transition);
      font-size: 14px;
      font-family: 'Poppins', sans-serif;
    }
    
    input[type="number"] { appearance: textfield }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0 }
    
    input:focus, select:focus { 
      border-color: var(--accent); 
      box-shadow: 0 0 0 4px rgba(255, 121, 198, 0.2);
      background: rgba(22, 22, 37, 0.95);
    }
    
    .row { display: flex; gap: 16px; align-items: center; flex-wrap: wrap }
    
    .btn { 
      background: var(--card-hover); 
      color: var(--text); 
      padding: 12px 20px; 
      border-radius: var(--radius-sm); 
      border: 1px solid var(--border); 
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .btn:hover:not(:disabled) { 
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg-primary);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(255, 121, 198, 0.2);
    }
    
    .btn.primary { 
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: var(--bg-primary); 
      border-color: transparent;
    }
    
    .btn.primary:hover:not(:disabled) {
      box-shadow: 0 8px 16px rgba(255, 121, 198, 0.3);
    }
    
    .btn.ghost { 
        background: transparent; 
        border-color: var(--border);
        color: var(--muted);
    }
    .btn.ghost:hover:not(:disabled) { 
        background: var(--card-hover);
        color: var(--text);
        border-color: var(--border-light);
    }
    
    .btn.success {
      background: var(--success);
      color: var(--bg-primary);
      border-color: transparent;
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse;
      font-size: 14px;
    }
    
    th, td { 
      padding: 16px; 
      border-bottom: 1px solid var(--border); 
      text-align: left;
    }
    
    #otTable tbody td, #expensesTable tbody td {
        vertical-align: middle;
    }
    
    th { 
      color: var(--muted); 
      font-weight: 600;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.5px;
      background: rgba(22, 22, 37, 0.5);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    #expensesTable th, #expenseAnalysisTable th {
        cursor: pointer;
        user-select: none;
    }

    #expensesTable th.sort-asc::after, #expensesTable th.sort-desc::after,
    #expenseAnalysisTable th.sort-asc::after, #expenseAnalysisTable th.sort-desc::after {
        content: '';
        display: inline-block;
        margin-left: 8px;
        width: 0;
        height: 0;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
    }
    #expensesTable th.sort-asc::after, #expenseAnalysisTable th.sort-asc::after { border-bottom: 5px solid var(--accent); }
    #expensesTable th.sort-desc::after, #expenseAnalysisTable th.sort-desc::after { border-top: 5px solid var(--accent); }

    
    tbody tr {
        transition: background-color 0.2s ease;
    }

    tbody tr:hover {
      background: rgba(42, 42, 74, 0.5);
    }
    
    tfoot {
      position: sticky;
      bottom: 0;
      z-index: 1;
    }

    tfoot td { 
      font-weight: 700;
      background: var(--card);
      border-top: 2px solid var(--border-light);
    }
    
    .pill { 
      display: inline-flex; 
      align-items: center; 
      gap: 8px; 
      padding: 8px 16px; 
      border: 1px solid var(--border); 
      border-radius: 999px; 
      color: var(--muted);
      background: var(--bg-secondary);
      font-size: 13px;
      font-weight: 500;
    }
    
    .stat { 
      display: flex;
      flex-direction: column;
      gap: 8px; 
      padding: 24px; 
      border-radius: var(--radius); 
      border: 1px solid var(--border); 
      background: linear-gradient(145deg, var(--card), var(--bg-secondary));
      transition: var(--transition);
    }

    .stat.secondary {
        flex-direction: row;
        padding: 16px 20px;
        align-items: center;
        justify-content: space-between;
        background: var(--bg-secondary);
    }
    
    .stat:hover {
      border-color: var(--border-light);
      transform: translateY(-3px);
      box-shadow: var(--shadow-light);
    }
    
    .stat .value { 
      font-size: 28px; 
      font-weight: 700;
      color: var(--accent);
      display: flex;
      align-items: baseline;
      gap: 4px;
    }
    .stat.secondary .value {
        font-size: 22px;
    }
    .stat .value .currency {
        font-size: 18px;
        font-weight: 500;
        color: var(--muted);
    }
    
    .stat .label {
      color: var(--muted);
      font-size: 14px;
      font-weight: 500;
    }
    .stat.secondary .label {
        font-size: 16px;
    }
    
    .muted { color: var(--muted) }
    .split { display: flex; gap: 20px; align-items: center; justify-content: space-between; flex-wrap: wrap }
    .small { font-size: 12px }
    
    .section-title {
      font-size: 22px;
      font-weight: 600;
      margin: 0;
      color: var(--text);
    }
    
    .table-container {
      overflow: auto;
      margin-top: 24px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: rgba(22, 22, 37, 0.3);
    }
    
    .chart-container {
      position: relative;
      height: 250px;
      margin-top: 24px;
    }
    
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    .success-message {
      background: rgba(80, 250, 123, 0.1);
      border: 1px solid rgba(80, 250, 123, 0.3);
      color: var(--success);
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      margin-top: 16px;
      font-size: 14px;
      font-weight: 500;
    }
    
    .footer-tip {
      background: var(--card);
      border: 1px solid var(--border);
      padding: 20px;
      border-radius: var(--radius);
      margin-top: 32px;
      text-align: center;
    }
    
    /* Smart Calculator Specific Styles */
    .tabs {
      display: flex;
      margin-bottom: 24px;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      padding: 4px;
      border: 1px solid var(--border);
    }
    
    .tab {
      flex: 1;
      padding: 12px 20px;
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      border-radius: var(--radius-sm);
      transition: var(--transition);
      font-size: 16px;
      font-weight: 600;
    }
    
    .tab.active {
      color: var(--bg-primary);
      background: var(--accent);
      box-shadow: 0 4px 10px rgba(255, 121, 198, 0.25);
    }
    
    .tab:hover:not(.active) {
      color: var(--text);
      background: var(--card-hover);
    }
    
    .tab-content {
      display: none;
      animation: tabFadeIn 0.5s ease-out;
    }
    
    @keyframes tabFadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .tab-content.active {
      display: block;
    }
    
    .smart-form {
      display: grid;
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .form-section {
      background: rgba(22, 22, 37, 0.4);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
    }
    
    .form-section h4 {
      color: var(--text);
      margin-bottom: 16px;
      font-size: 18px;
      font-weight: 600;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 16px;
    }

    .form-row-custom-pattern {
        display: grid;
        grid-template-columns: repeat(7, 1fr) 1.5fr auto;
        gap: 12px;
        align-items: end;
    }
    
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }
    
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--border);
      transition: .4s;
      border-radius: 28px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: var(--accent);
    }
    
    input:checked + .slider:before {
      transform: translateX(22px);
    }
    
    .toggle-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .toggle-label {
      color: var(--text);
      font-weight: 500;
      cursor: pointer;
      user-select: none;
    }
    
    .holiday-checklist {
      max-height: 200px;
      overflow-y: auto;
      background: rgba(22, 22, 37, 0.8);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
      font-size: 14px;
      line-height: 1.4;
    }
    
    .holiday-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }
    
    .holiday-item:last-child {
      border-bottom: none;
    }
    
    .holiday-checkbox-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      margin-bottom: 4px;
      background: rgba(36, 36, 62, 0.3);
      font-size: 14px;
      font-weight: 500;
      transition: background-color 0.2s ease;
    }
    
    .holiday-checkbox-item:hover {
      background: rgba(255, 255, 255, 0.08);
    }
    
    .holiday-checkbox-item label {
      flex-grow: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      margin: 0;
    }
    
    .holiday-checkbox-item .date {
      color: var(--muted);
      font-size: 12px;
      font-weight: 400;
    }
    
    .holiday-checkbox-item input[type="checkbox"] {
      margin-left: 12px;
      transform: scale(1.2);
      accent-color: var(--accent);
      width: auto;
      padding: 0;
    }
    
    .results-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .summary-item {
      background: linear-gradient(135deg, rgba(255, 121, 198, 0.1), rgba(80, 250, 123, 0.1));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      text-align: center;
    }
    
    .summary-item h4 {
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .summary-item .value {
      color: var(--accent);
      font-size: 28px;
      font-weight: 700;
    }
    
    .overtime-type {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    
    .ot-weekend { background: rgba(255, 121, 198, 0.2); color: var(--accent); }
    .ot-weekday { background: rgba(80, 250, 123, 0.2); color: var(--success); }
    .ot-holiday { background: rgba(241, 250, 140, 0.2); color: var(--warning); }
    .ot-restday { background: rgba(255, 85, 85, 0.2); color: var(--danger); }
    
    /* Hour Adjuster Styles */
    .hour-adjuster-panel .grid-4 {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }
    .adjuster-item {
        background: var(--bg-secondary);
        border-radius: var(--radius-sm);
        padding: 16px;
        border: 1px solid var(--border);
    }
    .adjuster-item label {
        font-weight: 600;
        font-size: 14px;
        color: var(--text);
    }
    .adjuster-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
    }
    .adjuster-controls input {
        text-align: center;
        font-weight: 600;
        font-size: 16px;
        background: rgba(0,0,0,0.2);
    }
    .adjuster-controls .btn {
        padding: 8px 12px;
        font-size: 18px;
        line-height: 1;
        min-width: 40px;
    }
    
    /* Custom Flatpickr Theme */
    .flatpickr-calendar {
      background: var(--card);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow);
      color: var(--text);
      font-family: 'Poppins', sans-serif;
    }
    .flatpickr-months .flatpickr-month {
      color: var(--text);
      fill: var(--text);
      font-weight: 600;
    }
    .flatpickr-months .flatpickr-prev-month,
    .flatpickr-months .flatpickr-next-month {
      color: var(--muted);
      fill: var(--muted);
      transition: var(--transition);
    }
    .flatpickr-months .flatpickr-prev-month:hover,
    .flatpickr-months .flatpickr-next-month:hover {
      color: var(--accent);
      fill: var(--accent);
    }
    span.flatpickr-weekday {
      color: var(--muted);
      font-weight: 600;
    }
    .flatpickr-day {
      color: var(--text);
      border-radius: var(--radius-sm);
      transition: var(--transition);
    }
    .flatpickr-day:hover, .flatpickr-day:focus {
      background: var(--card-hover);
      border-color: var(--card-hover);
      color: var(--text);
    }
    .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange,
    .flatpickr-day.selected:focus, .flatpickr-day.startRange:focus, .flatpickr-day.endRange:focus,
    .flatpickr-day.selected:hover, .flatpickr-day.startRange:hover, .flatpickr-day.endRange:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg-primary);
    }
    .flatpickr-day.today {
      border-color: var(--accent-hover);
    }
    .flatpickr-day.today:hover {
      background: var(--accent-hover);
      border-color: var(--accent-hover);
      color: var(--bg-primary);
    }
    .flatpickr-day.disabled, .flatpickr-day.disabled:hover {
      color: var(--muted);
      opacity: 0.4;
      background: transparent;
    }
    .numInputWrapper span:hover {
      background: var(--card-hover);
    }
    .flatpickr-time input, .numInput, .numInputWrapper span {
      background: transparent;
      color: var(--text);
      border-color: var(--border);
    }
    .flatpickr-time .flatpickr-am-pm:hover {
      background: var(--card-hover);
    }
    input.flatpickr-input {
        background: rgba(22, 22, 37, 0.8) !important;
        color: var(--text) !important;
    }

    /* Deduction Mode Toggle */
    .deduction-mode-toggle {
        display: flex;
        background: var(--bg-secondary);
        border-radius: var(--radius-sm);
        padding: 4px;
        border: 1px solid var(--border);
        margin-top: 16px;
    }
    .deduction-mode-toggle button {
        flex: 1;
        padding: 8px 12px;
        border: none;
        background: transparent;
        color: var(--muted);
        cursor: pointer;
        border-radius: var(--radius-sm);
        transition: var(--transition);
        font-size: 13px;
        font-weight: 600;
    }
    .deduction-mode-toggle button.active {
        color: var(--bg-primary);
        background: var(--accent);
        box-shadow: 0 2px 8px rgba(255, 121, 198, 0.2);
    }

    /* Income Goal Visualizer */
    .income-goal-visualizer {
        margin-top: 24px;
    }
    .income-goal-visualizer .label {
        color: var(--muted);
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 8px;
    }
    .progress-bar-container {
        width: 100%;
        height: 24px;
        background-color: var(--bg-secondary);
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        overflow: hidden;
        position: relative;
    }
    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--success), var(--accent));
        border-radius: var(--radius-sm);
        transition: width 0.5s ease-out;
    }
    .progress-bar-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: var(--bg-primary);
        font-weight: 600;
        font-size: 12px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .hours-to-goal-helper {
        background: rgba(80, 250, 123, 0.1);
        border: 1px solid rgba(80, 250, 123, 0.3);
        color: var(--success);
        padding: 12px 16px;
        border-radius: var(--radius-sm);
        margin-top: 16px;
        font-size: 13px;
        font-weight: 500;
        text-align: center;
    }

    /* Forecast Tab */
    .forecast-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 24px;
    }
    .forecast-card .stat {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
    }
    .forecast-card .stat .label { font-size: 16px; }
    .forecast-card .stat .value { font-size: 22px; }
    .what-if-slider-container {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-top: 16px;
    }
    .what-if-slider-container input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 8px;
        background: var(--bg-secondary);
        outline: none;
        border-radius: 8px;
        border: 1px solid var(--border);
    }
    .what-if-slider-container input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: var(--accent);
        cursor: pointer;
        border-radius: 50%;
        border: 3px solid var(--card);
    }
    .what-if-slider-container input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: var(--accent);
        cursor: pointer;
        border-radius: 50%;
        border: 3px solid var(--card);
    }
    
    /* Hour Adjuster Buttons */
    .hour-adjuster {
        display: flex;
        align-items: center;
    }
    .hour-adjuster input {
        text-align: center;
        border-right: none;
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }
    .hour-adjuster-buttons {
        display: flex;
        flex-direction: column;
    }
    .hour-adjuster-buttons button {
        background: var(--card-hover);
        border: 1px solid var(--border);
        color: var(--text);
        width: 28px;
        height: 24px;
        padding: 0;
        font-size: 16px;
        line-height: 1;
        cursor: pointer;
        transition: var(--transition);
    }
    .hour-adjuster-buttons button:hover {
        background: var(--accent);
        color: var(--bg-primary);
    }
    .hour-adjuster-buttons button:first-child {
        border-bottom: none;
        border-top-right-radius: var(--radius-sm);
    }
    .hour-adjuster-buttons button:last-child {
        border-bottom-right-radius: var(--radius-sm);
    }

    /* Expenses Tab Styles */
    .expenses-grid {
      display: grid;
      grid-template-columns: 2fr 1.2fr;
      gap: 24px;
    }

    #addExpenseForm {
      display: grid;
      grid-template-columns: 0.75fr 1.2fr 1fr 1fr 1fr 1fr auto;
      gap: 12px;
      align-items: end;
      margin-top: 16px;
    }
    
    .expense-note {
        font-size: 12px;
        color: var(--muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px;
    }
    
    .action-buttons {
        display: flex;
        gap: 8px;
    }
     .action-buttons .btn {
        padding: 6px 10px;
        font-size: 16px;
     }

    /* Infographic Styles */
    #expenseInfographicContainer {
        margin-top: 16px;
        padding: 4px;
    }
    .category-item {
        background: rgba(22, 22, 37, 0.5);
        border-radius: var(--radius-sm);
        padding: 16px;
        margin-bottom: 12px;
        border: 1px solid var(--border);
    }
    .category-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 8px;
    }
    .category-total {
        color: var(--text);
    }
    .progress-bar-wrapper {
        display: flex;
        height: 10px;
        border-radius: 10px;
        overflow: hidden;
        background: var(--bg-secondary);
        margin-bottom: 8px;
    }
    .progress-bar-user {
        background: var(--warning);
        transition: width 0.3s ease;
    }
    .progress-bar-partner {
        background: var(--accent);
        transition: width 0.3s ease;
    }
    .category-breakdown {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: var(--muted);
    }
     .category-breakdown span:last-child {
        text-align: right;
    }
    /* NEW: Budget Progress Bar */
    .budget-progress-bar-container {
        height: 6px;
        background: var(--bg-secondary);
        border-radius: 6px;
        margin: 8px 0 4px 0;
    }
    .budget-progress-bar-fill {
        height: 100%;
        background-color: var(--success);
        border-radius: 6px;
    }

    /* MODAL STYLES (for Budgeting and Annual Summary) */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        backdrop-filter: blur(5px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }
    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    .modal-content {
        background: var(--card);
        padding: 32px;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        transform: scale(0.9);
        transition: transform 0.3s ease;
    }
    .modal-overlay.active .modal-content {
        transform: scale(1);
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 16px;
        margin-bottom: 24px;
        border-bottom: 1px solid var(--border);
    }
    .modal-header h2 {
        margin: 0;
    }
    .modal-close-btn {
        background: transparent;
        border: none;
        color: var(--muted);
        font-size: 28px;
        cursor: pointer;
        line-height: 1;
    }
    .budget-item, .annual-summary-item {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: 16px;
        align-items: center;
        margin-bottom: 16px;
    }
     .annual-summary-item {
        grid-template-columns: 1fr 1fr;
        padding: 12px 0;
        border-bottom: 1px solid var(--border-light);
    }
    .budget-item label {
        margin-bottom: 0;
        font-weight: 600;
        color: var(--text);
    }

    @media (max-width: 900px) {
      .expenses-grid {
        grid-template-columns: 1fr;
      }
    }


    @media (max-width: 768px) {
      .wrap { padding: 0 16px; }
      h1 { font-size: 28px; }
      header { flex-direction: column; align-items: flex-start; gap: 16px; }
      .split { flex-direction: column; align-items: flex-start; gap: 16px; }
      .row { justify-content: flex-start; }
      .tabs { flex-wrap: wrap; }
      .tab { padding: 12px 16px; font-size: 14px; }
      .form-row { grid-template-columns: 1fr; }
      .form-row-custom-pattern { grid-template-columns: 1fr 1fr; }
      #addExpenseForm {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Salary & OT Dashboard</h1>
      <div class="row">
        <button class="btn ghost" id="viewAnnualSummaryBtn">🗓️ View Annual Summary</button>
        <button class="btn ghost" id="exportData">📤 Export Data</button>
        <button class="btn ghost" id="importData">📥 Import Data</button>
        <button class="btn ghost" id="resetAll">🔄 Reset data</button>
      </div>
    </header>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('manual', this)">📊 Manual Tracking</button>
      <button class="tab" onclick="switchTab('smart', this)">🤖 Smart Calculator</button>
      <button class="tab" onclick="switchTab('expenses', this)">💸 Monthly Expenses</button>
      <button class="tab" onclick="switchTab('forecast', this)">🔮 Forecast</button>
    </div>

    <div id="manual-tab" class="tab-content active">
      <div class="grid grid-2">
        <div class="card panel">
          <div class="split">
            <h2 class="section-title">⚙️ Settings</h2>
            <div class="row">
              <label class="muted small">📅 Month</label>
              <select id="monthSelect"></select>
            </div>
          </div>
          
          <div class="deduction-mode-toggle">
              <button id="deductionModeEstimate" onclick="setDeductionMode('estimate')">Estimate (%)</button>
              <button id="deductionModeActual" class="active" onclick="setDeductionMode('actual')">Actual (RM)</button>
          </div>

          <div class="grid grid-6" style="margin-top: 20px; grid-row-gap: 20px;">
            <div>
              <label>💵 Basic Salary (RM)</label>
              <input type="number" id="basic" step="0.01" />
            </div>
             <div>
              <label>📋 Claims (RM)</label>
              <input type="number" id="claims" step="0.01" />
            </div>
            <div>
              <label>📱 HP Allowance (RM)</label>
              <input type="number" id="hpAllow" step="0.01" />
            </div>
            <div>
              <label>🎯 Incentive (RM)</label>
              <input type="number" id="incentive" step="0.01" />
            </div>
            <div>
              <label>⏰ Hourly Rate (RM)</label>
              <input type="number" id="hourly" step="0.0001" readonly />
            </div>
            <div>
                 <div class="toggle-group" style="justify-content: flex-end; margin-bottom: 8px;">
                    <label class="switch">
                        <input type="checkbox" id="smartGoalToggle">
                        <span class="slider"></span>
                    </label>
                    <label for="smartGoalToggle" class="toggle-label" style="margin-bottom: 0;">✨ Smart Goal</label>
                </div>
            </div>
             <div>
              <label id="epfLabel">🏦 EPF (RM)</label>
              <input type="number" id="epf" step="0.01" />
            </div>
            <div>
              <label id="socsoLabel">🛡️ SOCSO (RM)</label>
              <input type="number" id="socso" step="0.01" />
            </div>
            <div>
              <label id="pcbLabel">📊 PCB (RM)</label>
              <input type="number" id="pcb" step="0.01" />
            </div>
            <div>
              <label id="eisLabel">⚡ EIS (RM)</label>
              <input type="number" id="eis" step="0.01" />
            </div>
            <div>
              <label>💸 Cash Advance (RM)</label>
              <input type="number" id="advance" step="0.01" />
            </div>
            <div id="desiredSavingsContainer" style="display: none;">
                <label>🏦 Desired End-of-Month Balance (RM)</label>
                <input type="number" id="desiredSavings" step="0.01" />
            </div>
          </div>
           <div class="grid" style="margin-top: 20px; grid-template-columns: 1fr;">
                 <div>
                   <label>💰 Net Income Goal (RM)</label>
                   <input type="number" id="incomeGoal" step="0.01" />
                </div>
           </div>
          <div class="row" style="margin-top: 28px; justify-content: flex-end">
            <button id="copyLastMonth" class="btn ghost">📋 Copy Last Month</button>
            <button id="saveParams" class="btn primary">💾 Save Settings</button>
          </div>
          <div id="saveMessage" style="display: none;"></div>
        </div>

        <div class="card panel">
          <h2 class="section-title" style="margin-bottom: 20px">📈 Quick Stats</h2>
          <div class="grid grid-3">
            <div class="stat">
              <div class="label">💰 Gross Income</div>
              <div class="value" id="grossOut">RM 0.00</div>
            </div>
            <div class="stat">
              <div class="label">✅ Net Pay</div>
              <div class="value" id="netOut" style="color: var(--success)">RM 0.00</div>
            </div>
            <div class="stat">
              <div class="label">🏦 Remaining Balance</div>
              <div class="value" id="balanceOut" style="color: var(--success)">RM 0.00</div>
            </div>
          </div>
          <div class="grid grid-2" style="margin-top: 16px;">
            <div class="stat secondary">
                <div class="label">💸 Total Deductions</div>
                <div class="value" id="deductOut" style="color: var(--warning)">RM 0.00</div>
            </div>
            <div class="stat secondary">
                <div class="label">📉 Total Expenses</div>
                <div class="value" id="expensesOut" style="color: var(--danger)">RM 0.00</div>
            </div>
          </div>
          <div id="incomeGoalVisualizer" class="income-goal-visualizer">
              <div class="label">🎯 Progress to Net Income Goal</div>
              <div class="progress-bar-container">
                  <div id="progressBarFill" class="progress-bar-fill"></div>
                  <div id="progressBarText" class="progress-bar-text"></div>
              </div>
              <div id="hoursToGoalHelper" class="hours-to-goal-helper"></div>
          </div>
        </div>
      </div>
      
      <div class="card panel hour-adjuster-panel" id="manualHourAdjusterContainer" style="display: none; margin-top: 24px;">
          <h4>🔧 Fine-Tune Schedule</h4>
           <div style="text-align: center; margin-bottom: 16px; font-size: 16px;">
                <span>Total OT Pay: </span><strong id="manualTotalOtPayAdjuster" style="color: var(--accent); font-size: 18px;">RM 0.00</strong>
            </div>
          <div class="grid grid-4">
              <div class="adjuster-item">
                  <label>Weekday (1.5x)</label>
                  <div class="adjuster-controls">
                      <button class="btn ghost" onclick="adjustManualHours('weekday', -0.5)">-</button>
                      <input type="text" id="manualWeekdayHoursTotal" readonly>
                      <button class="btn ghost" onclick="adjustManualHours('weekday', 0.5)">+</button>
                  </div>
              </div>
              <div class="adjuster-item">
                  <label>Saturday (1.5x)</label>
                  <div class="adjuster-controls">
                      <button class="btn ghost" onclick="adjustManualHours('saturday', -0.5)">-</button>
                      <input type="text" id="manualSaturdayHoursTotal" readonly>
                      <button class="btn ghost" onclick="adjustManualHours('saturday', 0.5)">+</button>
                  </div>
              </div>
              <div class="adjuster-item">
                  <label>Sunday (0.5x)</label>
                  <div class="adjuster-controls">
                      <button class="btn ghost" onclick="adjustManualHours('sunday', -0.5)">-</button>
                      <input type="text" id="manualSundayHoursTotal" readonly>
                      <button class="btn ghost" onclick="adjustManualHours('sunday', 0.5)">+</button>
                  </div>
              </div>
              <div class="adjuster-item">
                  <label>Holiday (2.0x)</label>
                  <div class="adjuster-controls">
                      <button class="btn ghost" onclick="adjustManualHours('holiday', -0.5)">-</button>
                      <input type="text" id="manualHolidayHoursTotal" readonly>
                      <button class="btn ghost" onclick="adjustManualHours('holiday', 0.5)">+</button>
                  </div>
              </div>
          </div>
      </div>

      <div class="card panel" style="margin-top: 24px">
        <div class="split">
          <h2 class="section-title">⏰ Overtime Sessions (<span id="monthLabel"></span>)</h2>
          <div class="row">
            <button class="btn primary" id="addRow">➕ Add Row</button>
            <button class="btn ghost" id="clearRows">🗑️ Clear All</button>
          </div>
        </div>
        <div class="table-container">
          <table id="otTable">
            <thead>
              <tr>
                <th style="width:160px">Date</th>
                <th style="width:110px">Start</th>
                <th style="width:110px">End</th>
                <th style="width:120px">Hours</th>
                <th style="width:160px">Multiplier</th>
                <th>OT Pay (RM)</th>
                <th style="width:auto">Notes</th>
                <th style="width:80px"></th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <td colspan="5" style="text-align:right; font-weight: 600">Total OT Pay</td>
                <td id="otTotal" style="color: var(--accent)">RM 0.00</td>
                <td colspan="2"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <div class="grid grid-2" style="margin-top: 24px">
        <div class="card panel">
          <h2 class="section-title" style="margin-bottom: 20px">📊 Breakdown</h2>
          <div class="table-container">
            <table>
              <tbody>
                <tr><td class="muted">💵 Basic</td><td id="bBasic">RM 0.00</td></tr>
                <tr><td class="muted">📋 Claims</td><td id="bClaims">RM 0.00</td></tr>
                <tr><td class="muted">📱 HP Allowance</td><td id="bHP">RM 0.00</td></tr>
                <tr><td class="muted">🎯 Incentive</td><td id="bIncen">RM 0.00</td></tr>
                <tr><td class="muted">⏰ OT Pay</td><td id="bOT">RM 0.00</td></tr>
                <tr><td style="font-weight: 600; color: var(--accent)">💰 Gross Total</td><td id="bGross" style="font-weight: 600; color: var(--accent)">RM 0.00</td></tr>
                <tr><td class="muted">🏦 EPF</td><td id="bEPF" style="color: var(--warning)">RM 0.00</td></tr>
                <tr><td class="muted">🛡️ SOCSO</td><td id="bSOCSO" style="color: var(--warning)">RM 0.00</td></tr>
                <tr><td class="muted">📊 PCB</td><td id="bPCB" style="color: var(--warning)">RM 0.00</td></tr>
                <tr><td class="muted">⚡ EIS</td><td id="bEIS" style="color: var(--warning)">RM 0.00</td></tr>
                <tr><td class="muted">💸 Cash Advance</td><td id="bAdv" style="color: var(--warning)">RM 0.00</td></tr>
                <tr><td style="font-weight: 600; color: var(--warning)">💸 Total Deductions</td><td id="bDeduct" style="font-weight: 600; color: var(--warning)">RM 0.00</td></tr>
                <tr><td style="font-weight: 700; color: var(--success)">✅ Net Pay</td><td id="bNet" style="font-weight: 700; color: var(--success)">RM 0.00</td></tr>
                <tr><td class="muted">📉 Total Expenses</td><td id="bExpenses" style="color: var(--danger)">RM 0.00</td></tr>
                <tr style="border-top: 2px solid var(--border-light);"><td style="font-weight: 700; font-size: 18px; color: var(--success)">🏦 Remaining Balance</td><td id="bBalance" style="font-weight: 700; font-size: 18px; color: var(--success)">RM 0.00</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="card panel">
          <div class="split">
            <h2 class="section-title">📈 Income Composition</h2>
            <p class="muted small">Monthly Gross Pay Breakdown</p>
          </div>
          <div class="chart-container">
            <canvas id="chartGrossNet"></canvas>
          </div>
          <div class="chart-container" style="margin-top: 32px">
            <canvas id="chartOT"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div id="smart-tab" class="tab-content">
      <div class="card panel">
        <h2 class="section-title" style="margin-bottom: 20px">🤖 Smart OT Calculator</h2>
        
        <div class="smart-form">
          <div class="form-section">
            <h4>💰 Basic Information</h4>
            <div class="form-row">
              <div>
                <label>Basic Salary (RM)</label>
                <input type="number" id="smartBasicSalary" step="0.01" placeholder="3700">
              </div>
              <div>
                <label>Date Range Start</label>
                <input type="text" id="startDate">
              </div>
              <div>
                <label>Date Range End</label>
                <input type="text" id="endDate">
              </div>
            </div>
            <div id="smartHourlyRateDisplay" style="background: rgba(80, 250, 123, 0.1); border: 1px solid rgba(80, 250, 123, 0.3); color: var(--success); padding: 12px; border-radius: var(--radius-sm); margin-top: 12px; text-align: center; font-weight: 600; display: none;"></div>
          </div>
          
          <div class="form-section">
            <h4>🏖️ Public Holidays (2025)</h4>
            <div class="holiday-checklist" id="holidayChecklist"></div>
            <div class="form-row" style="margin-top: 16px;">
              <div>
                <label>Add Custom Holiday</label>
                <div style="display: flex; gap: 8px;">
                  <input type="text" id="holidayPicker" style="flex: 1;">
                  <button type="button" class="btn success" onclick="addHoliday()">➕ Add</button>
                </div>
              </div>
            </div>
            <div id="holidayList" style="margin-top: 12px;"></div>
          </div>
          
          <div class="form-section">
            <h4>⚙️ AI Schedule Constraints</h4>
             <div class="form-row">
                 <div>
                    <label>Unavailable / Blackout Dates</label>
                    <input type="text" id="blackoutDates" placeholder="Select dates you cannot work...">
                 </div>
                 <div>
                    <label>Work Style Preference</label>
                    <select id="workStylePreference">
                        <option value="balanced">Balanced (Default)</option>
                        <option value="long_days">Prefer Fewer, Longer Days</option>
                        <option value="short_sessions">Prefer More, Shorter Sessions</option>
                    </select>
                 </div>
             </div>
          </div>

          <div class="form-section">
            <h4>📝 OT Pattern Templates</h4>
            <div class="form-row">
                <div style="grid-column: 1 / -1;">
                    <label for="patternSelect">Select a Pattern</label>
                    <div style="display: flex; gap: 8px;">
                        <select id="patternSelect" style="flex: 1;"></select>
                        <button class="btn" id="applyPatternBtn">🚀 Apply Pattern</button>
                        <button class="btn ghost" id="editPatternBtn" title="Edit selected custom pattern">✏️ Edit</button>
                        <button class="btn danger ghost" id="deletePatternBtn" title="Delete selected custom pattern">🗑️</button>
                    </div>
                </div>
            </div>
            <h5 style="font-size: 16px; color: var(--muted); margin-top: 24px; margin-bottom: 16px; font-weight: 500;">Create or Edit a Custom Pattern</h5>
            <div class="form-row-custom-pattern">
                <div><label>Mon</label><input type="number" step="0.5" min="0" id="customPatternMon" placeholder="0"></div>
                <div><label>Tue</label><input type="number" step="0.5" min="0" id="customPatternTue" placeholder="0"></div>
                <div><label>Wed</label><input type="number" step="0.5" min="0" id="customPatternWed" placeholder="0"></div>
                <div><label>Thu</label><input type="number" step="0.5" min="0" id="customPatternThu" placeholder="0"></div>
                <div><label>Fri</label><input type="number" step="0.5" min="0" id="customPatternFri" placeholder="0"></div>
                <div><label>Sat</label><input type="number" step="0.5" min="0" id="customPatternSat" placeholder="0"></div>
                <div><label>Sun</label><input type="number" step="0.5" min="0" id="customPatternSun" placeholder="0"></div>
                <div><label>Pattern Name</label><input type="text" id="customPatternName" placeholder="e.g. Client ABC Rush"></div>
                <div><label>&nbsp;</label><button class="btn success" id="savePatternBtn">💾 Save New Pattern</button></div>
            </div>
          </div>
        </div>
        
        <div class="form-section" style="margin-bottom: 24px;">
            <h4>🎯 Target-Based Calculator</h4>
            <div class="form-row">
              <div>
                <label>Target OT Pay (RM)</label>
                <input type="number" id="targetPay" step="0.01" placeholder="4000">
              </div>
            </div>
             <div class="row" style="justify-content: center; margin-top: 16px; gap: 16px;">
                <button class="btn primary" style="padding: 12px 24px; font-size: 16px;" onclick="calculateSmartOT()">✨ Calculate to Target</button>
                <button class="btn success" style="padding: 12px 24px; font-size: 16px;" onclick="aiSuggestSchedule()">🤖 AI Suggest Schedule</button>
            </div>
        </div>


        <div id="smartResults" style="display: none;">
          <div class="results-summary" id="smartSummary"></div>
          
          <div class="form-section hour-adjuster-panel" id="smartHourAdjusterContainer" style="display: none;">
              <h4>🔧 Fine-Tune Schedule</h4>
               <div style="text-align: center; margin-bottom: 16px; font-size: 16px;">
                    <span>Total OT Pay: </span><strong id="smartTotalOtPayAdjuster" style="color: var(--accent); font-size: 18px;">RM 0.00</strong>
                </div>
              <div class="grid grid-4">
                  <div class="adjuster-item">
                      <label>Weekday (1.5x)</label>
                      <div class="adjuster-controls">
                          <button class="btn ghost" onclick="adjustHours('weekday', -0.5)">-</button>
                          <input type="text" id="weekdayHoursTotal" readonly>
                          <button class="btn ghost" onclick="adjustHours('weekday', 0.5)">+</button>
                      </div>
                  </div>
                  <div class="adjuster-item">
                      <label>Saturday (1.5x)</label>
                      <div class="adjuster-controls">
                          <button class="btn ghost" onclick="adjustHours('saturday', -0.5)">-</button>
                          <input type="text" id="saturdayHoursTotal" readonly>
                          <button class="btn ghost" onclick="adjustHours('saturday', 0.5)">+</button>
                      </div>
                  </div>
                  <div class="adjuster-item">
                      <label>Sunday (0.5x)</label>
                      <div class="adjuster-controls">
                          <button class="btn ghost" onclick="adjustHours('sunday', -0.5)">-</button>
                          <input type="text" id="sundayHoursTotal" readonly>
                          <button class="btn ghost" onclick="adjustHours('sunday', 0.5)">+</button>
                      </div>
                  </div>
                  <div class="adjuster-item">
                      <label>Holiday (2.0x)</label>
                      <div class="adjuster-controls">
                          <button class="btn ghost" onclick="adjustHours('holiday', -0.5)">-</button>
                          <input type="text" id="holidayHoursTotal" readonly>
                          <button class="btn ghost" onclick="adjustHours('holiday', 0.5)">+</button>
                      </div>
                  </div>
              </div>
          </div>

          <div class="form-section">
            <div class="split" style="margin-bottom: 16px;">
              <h4>📋 Generated OT Schedule</h4>
              <div class="row">
                <button class="btn success" onclick="exportToCSV()">📄 Export CSV</button>
                <button class="btn primary" onclick="exportToPDF()">📑 Export PDF</button>
                <button class="btn ghost" onclick="applyToManualTab()">📊 Apply to Manual Tab</button>
              </div>
            </div>
            <div class="table-container">
              <table id="smartOTTable">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Day</th>
                    <th>OT Type</th>
                    <th>Start</th>
                    <th>End</th>
                    <th>Hours</th>
                    <th>Pay (RM)</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="expenses-tab" class="tab-content">
        <div class="expenses-grid">
            <div class="card panel">
                <div class="split" style="margin-bottom: 16px;">
                    <h2 class="section-title">💸 Monthly Expenses (<span id="expensesMonthLabel"></span>)</h2>
                     <div class="row">
                        <button class="btn ghost" id="copyRecurringExpensesBtn">📋 Copy Recurring from Last Month</button>
                        <button class="btn ghost" id="clearExpensesBtn">🗑️ Clear All</button>
                    </div>
                </div>
                <input type="text" id="expenseSearch" placeholder="🔍 Search expenses..." style="margin-bottom: 16px;">

                <div class="table-container" style="margin-top: 0;">
                    <table id="expensesTable">
                        <thead>
                            <tr>
                                <th data-sort="date">Date</th>
                                <th data-sort="desc">Description</th>
                                <th data-sort="category">Category</th>
                                <th data-sort="fullAmount">Total Cost</th>
                                <th data-sort="amount">My Cost</th>
                                <th data-sort="partnerShare">Partner's Cost</th>
                                <th>Notes</th>
                                <th style="width: 120px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" style="text-align:right;">Partner's Total</td>
                                <td id="expensesPartnerTotal" style="color: var(--accent); font-weight: 700;">RM 0.00</td>
                                <td style="text-align:right;">My Total</td>
                                <td id="expensesMyTotal" style="color: var(--danger); font-weight: 700;">RM 0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <h3 class="section-title" style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border); font-size: 20px;">➕ Add / Edit Expense</h3>
                <form id="addExpenseForm">
                    <div>
                        <label for="expenseDate">Date</label>
                        <input type="text" id="expenseDate" required>
                    </div>
                    <div>
                        <label for="expenseDesc">Description</label>
                        <input type="text" id="expenseDesc" placeholder="e.g., Groceries" required>
                    </div>
                    <div>
                        <label for="expenseCat">Category</label>
                        <input type="text" id="expenseCat" placeholder="e.g., Food" list="expenseCategories" required>
                        <datalist id="expenseCategories">
                            <option value="Food & Dining">
                            <option value="Transportation">
                            <option value="Bills & Utilities">
                            <option value="Housing">
                            <option value="Shopping">
                            <option value="Entertainment">
                            <option value="Health & Fitness">
                            <option value="Personal Care">
                            <option value="Education">
                            <option value="Miscellaneous">
                        </datalist>
                    </div>
                    <div>
                        <label for="expenseMyShare">My Share (RM)</label>
                        <input type="number" id="expenseMyShare" step="0.01" placeholder="50.00">
                    </div>
                    <div>
                        <label for="expensePartnerShare">Partner's Share (RM)</label>
                        <input type="number" id="expensePartnerShare" step="0.01" placeholder="50.00">
                    </div>
                     <div>
                        <label for="expenseNotes">Notes (Optional)</label>
                        <input type="text" id="expenseNotes" placeholder="e.g., Dinner with family">
                    </div>
                    <div class="form-actions" style="display: flex; flex-direction: column; gap: 8px;">
                        <div class="toggle-group" style="margin-top: auto; margin-bottom: 8px;">
                             <label class="switch">
                                <input type="checkbox" id="isRecurringToggle">
                                <span class="slider"></span>
                            </label>
                            <label for="isRecurringToggle" class="toggle-label" style="margin-bottom: 0;">Mark as Recurring</label>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button type="submit" id="addExpenseBtn" class="btn primary" style="flex: 1; height: 49px;">➕ Add</button>
                            <button type="button" id="cancelEditBtn" class="btn ghost" style="display: none; height: 49px;">❌</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="card panel">
                <div class="split">
                    <h2 class="section-title">📊 Expense Analysis</h2>
                    <button class="btn ghost" id="setBudgetsBtn">💰 Set Budgets</button>
                </div>
                 <div class="chart-container" style="height: 200px; margin-bottom: 24px;">
                    <canvas id="expensePieChart"></canvas>
                </div>
                <div id="expenseInfographicContainer" class="expense-analysis-container"></div>
            </div>
        </div>
    </div>


    <div id="forecast-tab" class="tab-content">
        <div class="forecast-grid">
            <div class="card panel forecast-card">
                <h2 class="section-title" style="margin-bottom: 20px">🔮 Predictive Forecast</h2>
                <p class="muted" style="margin-bottom: 24px;">Based on your average overtime from the last 3 months.</p>
                <div class="stat">
                    <div class="label">Avg. OT Hours / Month</div>
                    <div class="value" id="forecastAvgHours">0.0h</div>
                </div>
                <div class="stat">
                    <div class="label">Projected Gross Pay</div>
                    <div class="value" id="forecastGross">RM 0.00</div>
                </div>
                <div class="stat">
                    <div class="label">Projected Deductions</div>
                    <div class="value" id="forecastDeductions" style="color: var(--warning);">RM 0.00</div>
                </div>
                <div class="stat">
                    <div class="label">Projected Net Pay</div>
                    <div class="value" id="forecastNet" style="color: var(--success);">RM 0.00</div>
                </div>
            </div>
            <div class="card panel forecast-card">
                <h2 class="section-title" style="margin-bottom: 20px">🤔 "What-If" Analysis</h2>
                <p class="muted" style="margin-bottom: 24px;">See how additional OT hours could affect your current month's pay.</p>
                <div>
                    <label for="whatIfSlider">Additional OT Hours (at 1.5x): <strong id="whatIfHoursLabel" style="color: var(--accent);">0.0h</strong></label>
                    <div class="what-if-slider-container">
                        <input type="range" id="whatIfSlider" min="0" max="100" step="0.5" value="0">
                    </div>
                </div>
                <div class="stat">
                    <div class="label">"What-If" Gross Pay</div>
                    <div class="value" id="whatIfGross">RM 0.00</div>
                </div>
                <div class="stat">
                    <div class="label">"What-If" Deductions</div>
                    <div class="value" id="whatIfDeductions" style="color: var(--warning);">RM 0.00</div>
                </div>
                <div class="stat">
                    <div class="label">"What-If" Net Pay</div>
                    <div class="value" id="whatIfNet" style="color: var(--success);">RM 0.00</div>
                </div>
            </div>
        </div>
    </div>


    <div class="footer-tip">
      <p class="muted small" style="margin: 0">💡 <strong>Tip:</strong> All data is saved in your browser's local storage.</p>
    </div>
  </div>

  <div class="modal-overlay" id="budgetModal">
      <div class="modal-content">
          <div class="modal-header">
              <h2 class="section-title">💰 Set Monthly Budgets</h2>
              <button class="modal-close-btn">&times;</button>
          </div>
          <div id="budgetForm">
              </div>
           <div class="row" style="margin-top: 28px; justify-content: flex-end">
                <button id="saveBudgetsBtn" class="btn primary">💾 Save Budgets</button>
            </div>
      </div>
  </div>

  <div class="modal-overlay" id="annualSummaryModal">
       <div class="modal-content" style="max-width: 800px;">
          <div class="modal-header">
              <div style="display: flex; align-items: center; gap: 16px;">
                 <h2 class="section-title">🗓️ Annual Summary</h2>
                 <select id="annualSummaryYearSelect"></select>
              </div>
              <button class="modal-close-btn">&times;</button>
          </div>
          <div id="annualSummaryContent">
              </div>
      </div>
  </div>

  <script>
    // --- Global Variables ---
    let publicHolidays = [];
    let calculatedDailyHours = [];
    let lastGeneratedRates = {};
    let lastGeneratedAllHolidays = [];
    let chartGrossNet, chartOT, expensePieChart; // Added expensePieChart
    let months = []; // Will be populated dynamically
    let expenseSort = { key: 'date', order: 'desc' };
    let editingExpenseId = null;
    let editingPatternId = null; // NEW: For editing OT patterns

    // --- Static Data ---
    const expenseCategories = ["Food & Dining", "Transportation", "Bills & Utilities", "Housing", "Shopping", "Entertainment", "Health & Fitness", "Personal Care", "Education", "Miscellaneous"];


    // --- OT Pattern Data ---
    const otPatterns = {
        predefined: [
            { id: 'crunch', name: '🚀 Project Crunch Week', pattern: [4, 5, 6, 5, 4, 0, 0], description: 'High intensity on weekdays to meet project deadlines. Weekends are free.' },
            { id: 'warrior', name: '⚡ Weekend Warrior', pattern: [0, 0, 0, 0, 0, 8, 8], description: 'Focuses all overtime on Saturday and Sunday for maximum impact with free weekdays.' },
            { id: 'steady', name: '🌱 Steady Grind', pattern: [3, 3, 3, 3, 3, 4, 0], description: 'A balanced approach with moderate, consistent overtime on weekdays and a short Saturday.' },
            { id: 'maximizer', name: '🆘 Emergency Sprint', pattern: [4, 4, 4, 4, 4, 8, 8], description: 'Maximum effort. High hours every day of the week to maximize earnings quickly.' }
        ],
        custom: [] // Loaded from localStorage
    };

    // --- Data Model & Persistence ---
    function generateMonths(startYear, endYear) {
        const generatedMonths = [];
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        for (let year = startYear; year <= endYear; year++) {
            for (let month = 0; month < 12; month++) {
                const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
                const monthLabel = `${monthNames[month]} ${year}`;
                generatedMonths.push({ key: monthKey, label: monthLabel });
            }
        }
        return generatedMonths;
    }
    
    months = generateMonths(2025, 2027); // Generate months for 2025, 2026, and 2027

    const defaultParams = {
      basic: 3700.00,
      claims: 0.00,
      hpAllow: 80.00,
      incentive: 500.00,
      advance: 500.00,
      hourly: 3700.00 / 208,
      incomeGoal: 9500.00,
      // NEW: Smart Goal fields
      desiredSavings: 1500.00,
      smartGoalEnabled: false,
      // Actual RM values
      epf: 407.00,
      socso: 29.75,
      pcb: 534.30,
      eis: 11.90,
      // Estimate % values
      epf_pct: 3.73,
      socso_pct: 0.27,
      pcb_pct: 4.89,
      eis_pct: 0.11,
      deductionMode: 'actual' // 'actual' or 'estimate'
    };

    const predefinedHolidays2025 = [
      { date: '2025-01-01', name: 'New Year\'s Day' },
      { date: '2025-01-21', name: 'Thaipusam' },
      { date: '2025-01-29', name: 'Chinese New Year' },
      { date: '2025-01-30', name: 'Chinese New Year Day 2' },
      { date: '2025-03-29', name: 'Nuzul Al-Quran' },
      { date: '2025-03-31', name: 'Hari Raya Aidilfitri' },
      { date: '2025-04-01', name: 'Hari Raya Aidilfitri Day 2' },
      { date: '2025-05-01', name: 'Labour Day' },
      { date: '2025-05-12', name: 'Wesak Day' },
      { date: '2025-06-02', name: 'Agong\'s Birthday' },
      { date: '2025-06-07', name: 'Hari Raya Haji' },
      { date: '2025-06-27', name: 'Awal Muharram' },
      { date: '2025-08-31', name: 'Merdeka Day Holiday' }, // Merdeka is on Sunday, so Monday is holiday
      { date: '2025-09-01', name: 'Merdeka Day' },
      { date: '2025-09-05', name: 'Prophet Muhammad\'s Birthday' },
      { date: '2025-09-16', name: 'Malaysia Day' },
      { date: '2025-10-20', name: 'Deepavali' },
      { date: '2025-12-11', name: 'Sultan of Selangor\'s Birthday' },
      { date: '2025-12-25', name: 'Christmas Day' }
    ];

    function loadState() {
      const raw = localStorage.getItem('salary-ot-state-v5'); // Incremented version for new data structure
      let parsedState;
      if (raw) {
        try { 
          parsedState = JSON.parse(raw); 
        } catch(e) { 
          parsedState = null;
        }
      }

      if (!parsedState) {
        const state = { params: {}, ot: {}, expenses: {}, customPatterns: [], budgets: {} };
        months.forEach(m => {
          state.params[m.key] = { ...defaultParams };
          state.ot[m.key] = [];
          state.expenses[m.key] = [];
          state.budgets[m.key] = {};
        });
        return state;
      }
      
      months.forEach(m => {
        if (!parsedState.params[m.key]) parsedState.params[m.key] = { ...defaultParams };
        else parsedState.params[m.key] = { ...defaultParams, ...parsedState.params[m.key] };
        
        if (!parsedState.ot[m.key]) parsedState.ot[m.key] = [];
        if (!parsedState.expenses) parsedState.expenses = {};
        if (!parsedState.expenses[m.key]) parsedState.expenses[m.key] = [];
        else {
             // Data migration from wifeShare to partnerShare for backward compatibility
             parsedState.expenses[m.key].forEach(exp => {
                if (typeof exp.wifeShare !== 'undefined') {
                    exp.partnerShare = exp.wifeShare;
                    delete exp.wifeShare;
                }
             });
        }
        
        // NEW: Budget handling
        if (!parsedState.budgets) parsedState.budgets = {};
        if (!parsedState.budgets[m.key]) parsedState.budgets[m.key] = {};
      });

      if (!parsedState.customPatterns) parsedState.customPatterns = [];
      otPatterns.custom = parsedState.customPatterns;

      return parsedState;
    }
    
    function saveState() { 
      state.customPatterns = otPatterns.custom;
      localStorage.setItem('salary-ot-state-v5', JSON.stringify(state));
    }

    let state = loadState();

    // --- UI Elements ---
    const monthSelect = document.getElementById('monthSelect');
    const monthLabel = document.getElementById('monthLabel');
    const expensesMonthLabel = document.getElementById('expensesMonthLabel');
    const basic = document.getElementById('basic');
    const claims = document.getElementById('claims');
    const hpAllow = document.getElementById('hpAllow');
    const incentive = document.getElementById('incentive');
    const advance = document.getElementById('advance');
    const hourly = document.getElementById('hourly');
    const incomeGoal = document.getElementById('incomeGoal');
    const desiredSavings = document.getElementById('desiredSavings');
    const smartGoalToggle = document.getElementById('smartGoalToggle');
    const epf = document.getElementById('epf');
    const socso = document.getElementById('socso');
    const pcb = document.getElementById('pcb');
    const eis = document.getElementById('eis');
    const epfLabel = document.getElementById('epfLabel');
    const socsoLabel = document.getElementById('socsoLabel');
    const pcbLabel = document.getElementById('pcbLabel');
    const eisLabel = document.getElementById('eisLabel');
    const saveParamsBtn = document.getElementById('saveParams');
    const copyLastMonthBtn = document.getElementById('copyLastMonth');
    const saveMessage = document.getElementById('saveMessage');
    const addRowBtn = document.getElementById('addRow');
    const clearRowsBtn = document.getElementById('clearRows');
    const otTableBody = document.querySelector('#otTable tbody');

    const grossOut = document.getElementById('grossOut');
    const deductOut = document.getElementById('deductOut');
    const netOut = document.getElementById('netOut');
    const expensesOut = document.getElementById('expensesOut');
    const balanceOut = document.getElementById('balanceOut');

    const incomeGoalVisualizer = document.getElementById('incomeGoalVisualizer');
    const progressBarFill = document.getElementById('progressBarFill');
    const progressBarText = document.getElementById('progressBarText');
    const hoursToGoalHelper = document.getElementById('hoursToGoalHelper');

    const b = {
      basic: document.getElementById('bBasic'),
      claims: document.getElementById('bClaims'),
      hp: document.getElementById('bHP'),
      inc: document.getElementById('bIncen'),
      ot: document.getElementById('bOT'),
      gross: document.getElementById('bGross'),
      epf: document.getElementById('bEPF'),
      socso: document.getElementById('bSOCSO'),
      pcb: document.getElementById('bPCB'),
      eis: document.getElementById('bEIS'),
      adv: document.getElementById('bAdv'),
      deduct: document.getElementById('bDeduct'),
      net: document.getElementById('bNet'),
      expenses: document.getElementById('bExpenses'),
      balance: document.getElementById('bBalance')
    };

    // --- Tab Management ---
    function switchTab(tabName, element) {
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabName + '-tab').classList.add('active');
      element.classList.add('active');
    }

    // --- Utility Functions ---
    function fmt(n) { return (Number(n)||0).toFixed(2); }
    function fmtDisplay(n) { return `RM ${fmt(n)}`; }


    function formatDateToYyyyMmDd(date) { 
      const year = date.getFullYear(); 
      const month = String(date.getMonth() + 1).padStart(2, '0'); 
      const day = String(date.getDate()).padStart(2, '0'); 
      return `${year}-${month}-${day}`; 
    }

    // --- Functions to calculate and format payroll date ranges ---
    function getOtDateRangeObjects(monthKey) { // e.g., "2025-08"
        const [year, month] = monthKey.split('-').map(Number);
        const endDate = new Date(year, month - 2, 25);
        const startDate = new Date(year, month - 3, 26);
        return { startDate, endDate };
    }

    function getOtDateRange(monthKey) {
        const { startDate, endDate } = getOtDateRangeObjects(monthKey);
        const options = { day: 'numeric', month: 'short', year: 'numeric' };
        const formattedStartDate = startDate.toLocaleDateString('en-GB', options);
        const formattedEndDate = endDate.toLocaleDateString('en-GB', options);
        return `${formattedStartDate} - ${formattedEndDate}`;
    }

    function updateSmartCalculatorDates(monthKey) {
        const { startDate, endDate } = getOtDateRangeObjects(monthKey);
        // Update flatpickr instances
        if (document.getElementById('startDate')._flatpickr) {
            document.getElementById('startDate')._flatpickr.setDate(startDate, false);
        }
        if (document.getElementById('endDate')._flatpickr) {
            document.getElementById('endDate')._flatpickr.setDate(endDate, false);
        }
    }

    function getDayOfWeek(date) { 
      return ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"][date.getDay()]; 
    }

    function getOvertimeTypeClass(type) { 
      if (type.includes('Rest Day')) return 'ot-restday'; 
      if (type.includes('Public Holiday')) return 'ot-holiday'; 
      if (type.includes('Off Day') || type.includes('Saturday')) return 'ot-weekend'; 
      return 'ot-weekday'; 
    }

    function roundToNearestFiveMinutes(hour, minute) { 
      let totalMinutes = hour * 60 + minute; 
      let roundedMinutes = Math.round(totalMinutes / 5) * 5; 
      return [Math.floor(roundedMinutes / 60) % 24, roundedMinutes % 60]; 
    }

    function generateRandomStartTime(dayOfWeek) { 
      let startHour = (dayOfWeek === 0 || dayOfWeek === 6) ? 
        Math.floor(Math.random() * 9) + 9 : 
        Math.floor(Math.random() * 6) + 18; 
      let startMinute = Math.floor(Math.random() * 60); 
      [startHour, startMinute] = roundToNearestFiveMinutes(startHour, startMinute); 
      return `${String(startHour).padStart(2, '0')}:${String(startMinute).padStart(2, '0')}`; 
    }

    function calculateEndTime(startTime, otHours) { 
      if (!startTime) return '';
      const [startHour, startMinute] = startTime.split(':').map(Number); 
      let totalMinutes = startHour * 60 + startMinute + (otHours * 60); 
      let [endHour, endMinute] = roundToNearestFiveMinutes(0, totalMinutes); 
      return `${String(endHour).padStart(2, '0')}:${String(endMinute).padStart(2, '0')}`; 
    }

    function calculateDuration(startTime, endTime) {
        if (!startTime || !endTime) return 0;

        const start = new Date(`1970-01-01T${startTime}:00`);
        const end = new Date(`1970-01-01T${endTime}:00`);

        if (end < start) { // Handle overnight case
            end.setDate(end.getDate() + 1);
        }

        const diffMs = end - start;
        const diffHours = diffMs / (1000 * 60 * 60);
        
        return Math.round(diffHours * 4) / 4; // Round to nearest 0.25
    }

    function getAllHolidays() {
        const checkedHolidays = Array.from(document.querySelectorAll('input[name="predefinedHolidays"]:checked')).map(cb => cb.value);
        return [...new Set([...publicHolidays, ...checkedHolidays])];
    }

    // --- Manual Tab Functions ---
    function showSaveMessage(message, isSuccess = true) {
      saveMessage.innerHTML = `<div class="success-message">${message}</div>`;
      saveMessage.style.display = 'block';
      setTimeout(() => {
        saveMessage.style.display = 'none';
      }, 3000);
    }

    function loadParams(key) {
      const p = state.params[key];
      if (!p) {
        state.params[key] = { ...defaultParams };
        saveState();
      }
      const params = state.params[key];
      basic.value = params.basic; 
      claims.value = params.claims; 
      hpAllow.value = params.hpAllow; 
      incentive.value = params.incentive; 
      advance.value = params.advance;
      hourly.value = params.hourly.toFixed(4); 
      incomeGoal.value = params.incomeGoal;
      // NEW: Smart Goal
      desiredSavings.value = params.desiredSavings;
      smartGoalToggle.checked = params.smartGoalEnabled;
      
      updateDeductionUI(params.deductionMode);
      updateSmartGoalUI();
    }
    
    function saveParams(key) {
      const params = state.params[key];
      params.basic = Number(basic.value||0);
      params.claims = Number(claims.value||0);
      params.hpAllow = Number(hpAllow.value||0);
      params.incentive = Number(incentive.value||0);
      params.advance = Number(advance.value||0);
      params.hourly = Number(hourly.value||0);
      params.incomeGoal = Number(incomeGoal.value||0);
       // NEW: Smart Goal
      params.desiredSavings = Number(desiredSavings.value || 0);
      params.smartGoalEnabled = smartGoalToggle.checked;

      if (params.deductionMode === 'actual') {
        params.epf = Number(epf.value||0);
        params.socso = Number(socso.value||0);
        params.pcb = Number(pcb.value||0);
        params.eis = Number(eis.value||0);
      } else {
        params.epf_pct = Number(epf.value||0);
        params.socso_pct = Number(socso.value||0);
        params.pcb_pct = Number(pcb.value||0);
        params.eis_pct = Number(eis.value||0);
      }
      
      saveState();
      showSaveMessage('✅ Settings saved successfully!');
      refresh();
    }

    function renderOT(key) {
      otTableBody.innerHTML = '';
      const p = state.params[key];
      const rows = state.ot[key] || [];
      
      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');
        const otPay = (r.hours || 0) * (r.mult || 0) * (p.hourly || 0);
        tr.innerHTML = `
          <td><input type="text" value="${r.date||''}" data-idx="${idx}" data-field="date"></td>
          <td><input type="time" class="time-input" value="${r.start||''}" data-idx="${idx}" data-field="start"></td>
          <td><input type="time" class="time-input" value="${r.end||''}" data-idx="${idx}" data-field="end"></td>
          <td>
            <div class="hour-adjuster">
                <input type="number" step="0.25" value="${r.hours||0}" data-idx="${idx}" data-field="hours" min="0">
                 <div class="hour-adjuster-buttons">
                    <button data-idx="${idx}" data-action="increase">▲</button>
                    <button data-idx="${idx}" data-action="decrease">▼</button>
                </div>
            </div>
          </td>
          <td>
            <select data-idx="${idx}" data-field="mult">
              <option value="0.5" ${r.mult==0.5?'selected':''}>0.5× Rest Day</option>
              <option value="1.5" ${r.mult==1.5?'selected':''}>1.5× Working/Off Day</option>
              <option value="2" ${r.mult==2?'selected':''}>2.0× Public Holiday</option>
            </select>
          </td>
          <td class="otpay" style="font-weight: 600; color: var(--accent)">${fmtDisplay(otPay)}</td>
          <td><input type="text" value="${r.notes || ''}" data-idx="${idx}" data-field="notes" placeholder="e.g., Project deployment"></td>
          <td><button class="btn ghost" data-del="${idx}" title="Remove this entry">🗑️</button></td>
        `;
        otTableBody.appendChild(tr);
      });
      
      otTableBody.querySelectorAll('input,select').forEach(el => {
        const eventType = (el.tagName === 'SELECT' || el.dataset.field === 'notes' || el.type === 'time') ? 'change' : 'input';
        el.addEventListener(eventType, e => {
          const i = Number(e.target.dataset.idx);
          const field = e.target.dataset.field;
          if (!state.ot[key][i]) return;
          
          state.ot[key][i][field] = e.target.value || '';
          
          if (field === 'date') {
              const allHolidays = getAllHolidays();
              const selectedDate = new Date(e.target.value + 'T00:00:00');
              if (!isNaN(selectedDate.getTime())) {
                  const dayOfWeek = selectedDate.getDay();
                  let newMultiplier = 1.5;
                  if (allHolidays.includes(e.target.value)) newMultiplier = 2.0;
                  else if (dayOfWeek === 0) newMultiplier = 0.5;
                  state.ot[key][i].mult = newMultiplier;
              }
          }

          if (field === 'start' || field === 'end') {
              const row = e.target.closest('tr');
              const startVal = row.querySelector('input[data-field="start"]').value;
              const endVal = row.querySelector('input[data-field="end"]').value;
              if (startVal && endVal) {
                  const duration = calculateDuration(startVal, endVal);
                  state.ot[key][i].hours = duration;
              }
          }
          
          saveState();
          refresh();
        });
      });
      
      otTableBody.querySelectorAll('.hour-adjuster-buttons button').forEach(btn => {
          btn.addEventListener('click', e => {
              const key = monthSelect.value;
              const idx = Number(e.target.dataset.idx);
              if (!state.ot[key][idx]) return;

              const action = e.target.dataset.action;
              
              let currentHours = parseFloat(state.ot[key][idx].hours) || 0;
              if (action === 'increase') {
                  currentHours += 0.25;
              } else if (action === 'decrease') {
                  currentHours -= 0.25;
              }
              const newHours = Math.max(0, currentHours);
              state.ot[key][idx].hours = newHours;
              
              const startTime = state.ot[key][idx].start;
              if (startTime) {
                  const newEndTime = calculateEndTime(startTime, newHours);
                  state.ot[key][idx].end = newEndTime;
              }

              saveState();
              refresh();
          });
      });
      
      otTableBody.querySelectorAll('button[data-del]').forEach(btn => {
        btn.addEventListener('click', () => {
          const i = Number(btn.dataset.del);
          if (confirm('Are you sure you want to remove this OT entry?')) {
            state.ot[key].splice(i,1);
            saveState();
            refresh();
          }
        });
      });

      // Initialize flatpickr on date inputs
      otTableBody.querySelectorAll('input[data-field="date"]').forEach(dateInput => {
        flatpickr(dateInput, {
            dateFormat: "Y-m-d", altInput: true, altFormat: "d M, Y",
            onChange: (selectedDates, dateStr, instance) => instance.element.dispatchEvent(new Event('input', { bubbles: true }))
        });
      });
    }

    function totalsFor(key, previousKey = null) {
      const p = state.params[key] || defaultParams;
      const rows = state.ot[key] || [];
      const expenses = state.expenses[key] || [];
      
      const otPay = rows.reduce((s, r) => s + (Number(r.hours||0) * Number(r.mult||0) * Number(p.hourly||0)), 0);
      const gross = Number(p.basic) + Number(p.claims) + Number(p.hpAllow) + Number(p.incentive) + otPay;
      
      let epfAmt, socsoAmt, pcbAmt, eisAmt;

      if (p.deductionMode === 'estimate') {
        const totalDeductionPct = (Number(p.epf_pct) + Number(p.socso_pct) + Number(p.pcb_pct) + Number(p.eis_pct)) / 100;
        epfAmt = gross * (Number(p.epf_pct)/100);
        socsoAmt = gross * (Number(p.socso_pct)/100);
        pcbAmt = gross * (Number(p.pcb_pct)/100);
        eisAmt = gross * (Number(p.eis_pct)/100);
      } else { // 'actual' mode
        epfAmt = Number(p.epf);
        socsoAmt = Number(p.socso);
        pcbAmt = Number(p.pcb);
        eisAmt = Number(p.eis);
      }
      
      const deductions = epfAmt + socsoAmt + pcbAmt + eisAmt + Number(p.advance);
      const net = gross - deductions;
      
      const totalExpenses = expenses.reduce((s, e) => s + (Number(e.amount)||0), 0);
      const totalPartnerExpenses = expenses.reduce((s, e) => s + (Number(e.partnerShare)||0), 0);
      
      const balance = net - totalExpenses;
      
      let previousTotalExpenses = 0;
      if (previousKey && state.expenses[previousKey]) {
          previousTotalExpenses = state.expenses[previousKey].reduce((s, e) => s + (Number(e.amount)||0), 0);
      }

      return { otPay, gross, epfAmt, socsoAmt, pcbAmt, eisAmt, deductions, net, totalExpenses, totalPartnerExpenses, balance, previousTotalExpenses };
    }

    function refresh() {
      const key = monthSelect.value;
      const curIdx = months.findIndex(m => m.key === key);
      const prevKey = curIdx > 0 ? months[curIdx-1].key : null;
      const cur = months[curIdx];
      
      const dateRange = getOtDateRange(key);
      monthLabel.innerHTML = cur ? `${cur.label} <span class="muted small" style="font-weight: 400;">(${dateRange})</span>` : 'Unknown Month';
      expensesMonthLabel.textContent = cur ? cur.label : 'Unknown Month';
      
      updateSmartCalculatorDates(key);
      
      loadParams(key);
      renderOT(key);
      renderExpenses(key);
      renderExpenseAnalysis(key);

      const { otPay, gross, epfAmt, socsoAmt, pcbAmt, eisAmt, deductions, net, totalExpenses, totalPartnerExpenses, balance, previousTotalExpenses } = totalsFor(key, prevKey);
      
      // Update Quick Stats
      document.getElementById('otTotal').textContent = fmtDisplay(otPay);
      grossOut.innerHTML = `<span class="currency">RM</span> ${fmt(gross)}`;
      deductOut.innerHTML = `<span class="currency">RM</span> ${fmt(deductions)}`;
      netOut.innerHTML = `<span class="currency">RM</span> ${fmt(net)}`;
      expensesOut.innerHTML = `<span class="currency">RM</span> ${fmt(totalExpenses)}`;
      balanceOut.innerHTML = `<span class="currency">RM</span> ${fmt(balance)}`;


      const p = state.params[key] || defaultParams;
      // Update Breakdown Table
      b.basic.textContent = fmtDisplay(p.basic);
      b.claims.textContent = fmtDisplay(p.claims);
      b.hp.textContent = fmtDisplay(p.hpAllow);
      b.inc.textContent = fmtDisplay(p.incentive);
      b.ot.textContent = fmtDisplay(otPay);
      b.gross.textContent = fmtDisplay(gross);
      b.epf.textContent = fmtDisplay(epfAmt);
      b.socso.textContent = fmtDisplay(socsoAmt);
      b.pcb.textContent = fmtDisplay(pcbAmt);
      b.eis.textContent = fmtDisplay(eisAmt);
      b.adv.textContent = fmtDisplay(p.advance);
      b.deduct.textContent = fmtDisplay(deductions);
      b.net.textContent = fmtDisplay(net);
      b.expenses.textContent = fmtDisplay(totalExpenses);
      b.balance.textContent = fmtDisplay(balance);
      
      // Update Expense Totals in Footer
      document.getElementById('expensesMyTotal').textContent = fmtDisplay(totalExpenses);
      document.getElementById('expensesPartnerTotal').textContent = fmtDisplay(totalPartnerExpenses);

      // NEW: Recalculate Smart Goal
      updateSmartGoal(); 
      const updatedGoal = Number(state.params[key].incomeGoal) || 0; // Use the potentially updated goal

      // Update Income Goal Visualizer
      if (updatedGoal > 0) {
          incomeGoalVisualizer.style.display = 'block';
          const progress = Math.min((net / updatedGoal) * 100, 100);
          progressBarFill.style.width = `${progress}%`;
          progressBarText.textContent = `${fmtDisplay(net)} / ${fmtDisplay(updatedGoal)} (${progress.toFixed(1)}%)`;

          const remaining = updatedGoal - net;
          if (remaining > 0) {
              const hourlyRate = Number(p.hourly) || 0;
              if (hourlyRate > 0) {
                  const hours1_5x = remaining / (hourlyRate * 1.5);
                  const hours2_0x = remaining / (hourlyRate * 2.0);
                  const hours0_5x = remaining / (hourlyRate * 0.5);
                  hoursToGoalHelper.innerHTML = `You're <strong>${fmtDisplay(remaining)}</strong> away! You need ~<strong>${hours1_5x.toFixed(1)}h</strong> at 1.5x, <strong>${hours2_0x.toFixed(1)}h</strong> at 2.0x, or <strong>${hours0_5x.toFixed(1)}h</strong> at 0.5x to reach your goal. <br> <button class="btn success" style="margin-top: 8px; padding: 6px 12px; font-size: 12px;" onclick="autoScheduleToGoal()">🚀 Auto-Schedule to Goal</button>`;
                  hoursToGoalHelper.style.display = 'block';
              }
          } else {
              hoursToGoalHelper.innerHTML = '🎉 Goal Achieved!';
              hoursToGoalHelper.style.display = 'block';
          }

      } else {
          incomeGoalVisualizer.style.display = 'none';
      }
      
      updateManualHourAdjusters();
      updateCharts();
      calculateForecast();
    }

    function setDeductionMode(mode) {
        const key = monthSelect.value;
        state.params[key].deductionMode = mode;
        updateDeductionUI(mode);
        saveState();
        refresh();
    }
    
    // --- NEW Smart Goal Functions ---
    function updateSmartGoalUI() {
        const key = monthSelect.value;
        const params = state.params[key];
        const container = document.getElementById('desiredSavingsContainer');
        
        if (params.smartGoalEnabled) {
            container.style.display = 'block';
            incomeGoal.readOnly = true;
            incomeGoal.style.cursor = 'not-allowed';
            incomeGoal.style.color = 'var(--muted)';
        } else {
            container.style.display = 'none';
            incomeGoal.readOnly = false;
            incomeGoal.style.cursor = 'text';
            incomeGoal.style.color = 'var(--text)';
        }
    }
    
    function updateSmartGoal() {
        const key = monthSelect.value;
        const params = state.params[key];
        
        if (params.smartGoalEnabled) {
            const { totalExpenses } = totalsFor(key);
            const savings = Number(params.desiredSavings) || 0;
            const newGoal = totalExpenses + savings;
            
            incomeGoal.value = newGoal.toFixed(2);
            // We update the state directly here, which will be saved in the next auto-save
            if (state.params[key].incomeGoal !== newGoal) {
                 state.params[key].incomeGoal = newGoal;
                 // A light save without full refresh to avoid loops
                 saveState();
                 // Now update just the visualizer
                 const { net } = totalsFor(key);
                 const progress = Math.min((net / newGoal) * 100, 100);
                 progressBarFill.style.width = `${progress}%`;
                 progressBarText.textContent = `${fmtDisplay(net)} / ${fmtDisplay(newGoal)} (${progress.toFixed(1)}%)`;
            }
        }
    }
    // --- End Smart Goal Functions ---

    function updateDeductionUI(mode) {
        const key = monthSelect.value;
        const params = state.params[key];
        const estimateBtn = document.getElementById('deductionModeEstimate');
        const actualBtn = document.getElementById('deductionModeActual');

        if (mode === 'estimate') {
            estimateBtn.classList.add('active');
            actualBtn.classList.remove('active');
            epfLabel.innerHTML = '🏦 EPF (%)';
            socsoLabel.innerHTML = '🛡️ SOCSO (%)';
            pcbLabel.innerHTML = '📊 PCB (%)';
            eisLabel.innerHTML = '⚡ EIS (%)';
            epf.value = params.epf_pct;
            socso.value = params.socso_pct;
            pcb.value = params.pcb_pct;
            eis.value = params.eis_pct;
        } else { // 'actual'
            estimateBtn.classList.remove('active');
            actualBtn.classList.add('active');
            epfLabel.innerHTML = '🏦 EPF (RM)';
            socsoLabel.innerHTML = '🛡️ SOCSO (RM)';
            pcbLabel.innerHTML = '📊 PCB (RM)';
            eisLabel.innerHTML = '⚡ EIS (RM)';
            epf.value = params.epf;
            socso.value = params.socso;
            pcb.value = params.pcb;
            eis.value = params.eis;
        }
    }

    function updateCharts() {
      const labels = months.map(m => m.label).slice(0, 12); // Limit to 12 months for readability
      
      const datasetsGross = { basic: [], claims: [], hp: [], incentive: [], ot: [] };
      labels.forEach(label => {
          const monthKey = months.find(m => m.label === label).key;
          const p = state.params[monthKey] || defaultParams;
          const { otPay } = totalsFor(monthKey);
          datasetsGross.basic.push(p.basic);
          datasetsGross.claims.push(p.claims);
          datasetsGross.hp.push(p.hpAllow);
          datasetsGross.incentive.push(p.incentive);
          datasetsGross.ot.push(otPay);
      });

      const otHoursArr = labels.map(label => {
        const monthKey = months.find(m => m.label === label).key;
        const rows = state.ot[monthKey] || [];
        return rows.reduce((s,r)=> s + Number(r.hours||0), 0);
      });

      if (chartGrossNet) {
        chartGrossNet.data.labels = labels;
        chartGrossNet.data.datasets[0].data = datasetsGross.basic;
        chartGrossNet.data.datasets[1].data = datasetsGross.ot;
        chartGrossNet.data.datasets[2].data = datasetsGross.claims;
        chartGrossNet.data.datasets[3].data = datasetsGross.incentive;
        chartGrossNet.data.datasets[4].data = datasetsGross.hp;
        chartGrossNet.update('none');
      }

      if (chartOT) {
        chartOT.data.labels = labels;
        chartOT.data.datasets[0].data = otHoursArr;
        chartOT.update('none');
      }
    }

    // --- Expenses Tab Functions ---
    function renderExpenseAnalysis(key) {
        const container = document.getElementById('expenseInfographicContainer');
        const expenses = state.expenses[key] || [];
        const budgets = state.budgets[key] || {};
        
        const analysisData = expenses.reduce((acc, exp) => {
            const cat = exp.category || 'Uncategorized';
            if (!acc[cat]) {
                acc[cat] = { myTotal: 0, partnerTotal: 0 };
            }
            acc[cat].myTotal += exp.amount;
            acc[cat].partnerTotal += exp.partnerShare;
            return acc;
        }, {});

        const sortedCategories = Object.keys(analysisData).sort((a,b) => {
            const totalA = analysisData[a].myTotal + analysisData[a].partnerTotal;
            const totalB = analysisData[b].myTotal + analysisData[b].partnerTotal;
            return totalB - totalA;
        });
        
        // Update Pie Chart
        if (expensePieChart) {
            expensePieChart.data.labels = sortedCategories;
            expensePieChart.data.datasets[0].data = sortedCategories.map(cat => analysisData[cat].myTotal);
            expensePieChart.update('none');
        }

        if (sortedCategories.length === 0) {
            container.innerHTML = '<p style="text-align:center; padding: 20px; color: var(--muted);">No expenses logged for this month.</p>';
            return;
        }

        let infographicHTML = '';
        sortedCategories.forEach(cat => {
            const data = analysisData[cat];
            const total = data.myTotal + data.partnerTotal;
            const myPercent = total > 0 ? (data.myTotal / total) * 100 : 0;
            const partnerPercent = total > 0 ? (data.partnerTotal / total) * 100 : 0;
            
            const budget = budgets[cat] || 0;
            let budgetHTML = '';
            if (budget > 0) {
                const budgetSpentPct = Math.min((total / budget) * 100, 100);
                let barColor = 'var(--success)';
                if (budgetSpentPct > 75) barColor = 'var(--warning)';
                if (budgetSpentPct >= 100) barColor = 'var(--danger)';

                budgetHTML = `
                    <div class="budget-progress-bar-container">
                        <div class="budget-progress-bar-fill" style="width: ${budgetSpentPct}%; background-color: ${barColor};"></div>
                    </div>
                    <div class="category-breakdown" style="font-size: 11px;">
                        <span>Spent: <strong style="color:var(--text)">${fmtDisplay(total)}</strong></span>
                        <span>Budget: <strong style="color:var(--muted)">${fmtDisplay(budget)}</strong></span>
                    </div>
                `;
            }


            infographicHTML += `
                <div class="category-item">
                    <div class="category-header">
                        <span>${cat}</span>
                        <span class="category-total">${fmtDisplay(total)}</span>
                    </div>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar-user" style="width: ${myPercent}%" title="My Cost: ${fmtDisplay(data.myTotal)}"></div>
                        <div class="progress-bar-partner" style="width: ${partnerPercent}%" title="Partner's Cost: ${fmtDisplay(data.partnerTotal)}"></div>
                    </div>
                    <div class="category-breakdown">
                        <span>My Cost: <strong style="color:var(--warning)">${fmtDisplay(data.myTotal)}</strong></span>
                        <span>Partner's Cost: <strong style="color:var(--accent)">${fmtDisplay(data.partnerTotal)}</strong></span>
                    </div>
                    ${budgetHTML}
                </div>
            `;
        });

        container.innerHTML = infographicHTML;
    }

    function renderExpenses(key) {
        const expensesTableBody = document.querySelector('#expensesTable tbody');
        const searchTerm = document.getElementById('expenseSearch').value.toLowerCase();
        expensesTableBody.innerHTML = '';
        
        let expenses = state.expenses[key] || [];

        // 1. Filter
        if (searchTerm) {
            expenses = expenses.filter(exp => 
                exp.desc.toLowerCase().includes(searchTerm) ||
                exp.category.toLowerCase().includes(searchTerm) ||
                (exp.notes && exp.notes.toLowerCase().includes(searchTerm))
            );
        }

        // 2. Sort
        expenses.sort((a, b) => {
            let valA = a[expenseSort.key];
            let valB = b[expenseSort.key];
            
            if (expenseSort.key === 'paidBy') {
                valA = a.isPaidByWife ? 1 : 0;
                valB = b.isPaidByWife ? 1 : 0;
            } else if (expenseSort.key === 'amount' || expenseSort.key === 'fullAmount' || expenseSort.key === 'partnerShare') {
                valA = Number(valA);
                valB = Number(valB);
            }
            if (expenseSort.key === 'date') {
                return expenseSort.order === 'asc' ? new Date(valA) - new Date(valB) : new Date(valB) - new Date(valA);
            }

            if (valA < valB) return expenseSort.order === 'asc' ? -1 : 1;
            if (valA > valB) return expenseSort.order === 'asc' ? 1 : -1;
            return 0;
        });

        // 3. Render
        expenses.forEach(expense => {
            const tr = document.createElement('tr');
            const hasPartnerShare = expense.partnerShare > 0;
            const recurringIcon = expense.isRecurring ? '🔄' : '';
            tr.innerHTML = `
                <td>${expense.date}</td>
                <td>${expense.desc} <span title="Recurring Expense">${recurringIcon}</span></td>
                <td>${expense.category}</td>
                <td style="color: ${hasPartnerShare ? 'var(--accent)' : 'var(--text)'}; font-weight: ${hasPartnerShare ? '600' : '400'};">${fmtDisplay(expense.fullAmount)}</td>
                <td style="color: var(--warning); font-weight: 600;">${fmtDisplay(expense.amount)}</td>
                <td style="color: var(--muted);">${fmtDisplay(expense.partnerShare)}</td>
                <td><div class="expense-note" title="${expense.notes || ''}">${expense.notes || '-'}</div></td>
                <td>
                    <div class="action-buttons">
                        <button class="btn ghost" onclick="editExpense('${expense.id}')" title="Edit">✏️</button>
                        <button class="btn ghost" onclick="deleteExpense('${expense.id}')" title="Delete">🗑️</button>
                    </div>
                </td>
            `;
            expensesTableBody.appendChild(tr);
        });
    }
    
    function setExpenseSort(key) {
        if (expenseSort.key === key) {
            expenseSort.order = expenseSort.order === 'asc' ? 'desc' : 'asc';
        } else {
            expenseSort.key = key;
            expenseSort.order = (key === 'amount' || key === 'date' || key === 'fullAmount' || key === 'partnerShare') ? 'desc' : 'asc';
        }
        
        // Update header classes
        document.querySelectorAll('#expensesTable th').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
            if(th.dataset.sort === key) {
                th.classList.add(`sort-${expenseSort.order}`);
            }
        });

        renderExpenses(monthSelect.value);
    }


    function handleExpenseSubmit(e) {
        e.preventDefault();
        const key = monthSelect.value;
        const isRecurring = document.getElementById('isRecurringToggle').checked;
        const myShare = parseFloat(document.getElementById('expenseMyShare').value) || 0;
        const partnerShare = parseFloat(document.getElementById('expensePartnerShare').value) || 0;
        
        const newExpense = {
            id: editingExpenseId || `exp_${new Date().getTime()}`,
            date: document.getElementById('expenseDate').value,
            desc: document.getElementById('expenseDesc').value.trim(),
            category: document.getElementById('expenseCat').value.trim(),
            fullAmount: myShare + partnerShare,
            amount: myShare, // 'amount' is always My Share for calculations
            partnerShare: partnerShare,
            notes: document.getElementById('expenseNotes').value.trim(),
            isRecurring: isRecurring
        };

        if (newExpense.desc && newExpense.category && (myShare > 0 || partnerShare > 0) && newExpense.date) {
            if (editingExpenseId) { // Update existing
                const index = state.expenses[key].findIndex(exp => exp.id === editingExpenseId);
                state.expenses[key][index] = newExpense;
            } else { // Add new
                 if (!state.expenses[key]) state.expenses[key] = [];
                state.expenses[key].push(newExpense);
            }
            saveState();
            refresh();
            cancelEdit();
        } else {
            alert("Please fill in Date, Description, Category, and at least one Share amount.");
        }
    }

    function editExpense(expenseId) {
        const key = monthSelect.value;
        const expense = state.expenses[key].find(exp => exp.id === expenseId);
        if (expense) {
            editingExpenseId = expenseId;
            document.getElementById('expenseDate')._flatpickr.setDate(expense.date, true);
            document.getElementById('expenseDesc').value = expense.desc;
            document.getElementById('expenseCat').value = expense.category;
            document.getElementById('expenseMyShare').value = expense.amount;
            document.getElementById('expensePartnerShare').value = expense.partnerShare;
            document.getElementById('expenseNotes').value = expense.notes || '';
            
            // Handle recurring toggle
            document.getElementById('isRecurringToggle').checked = expense.isRecurring || false;
            
            const addBtn = document.getElementById('addExpenseBtn');
            addBtn.textContent = '💾 Save';
            addBtn.classList.remove('primary');
            addBtn.classList.add('success');
            document.getElementById('cancelEditBtn').style.display = 'inline-flex';
        }
    }

    function cancelEdit() {
        editingExpenseId = null;
        document.getElementById('addExpenseForm').reset();
        document.getElementById('expenseDate')._flatpickr.setDate(new Date(), true);
        const addBtn = document.getElementById('addExpenseBtn');
        addBtn.textContent = '➕ Add';
        addBtn.classList.remove('success');
        addBtn.classList.add('primary');
        document.getElementById('cancelEditBtn').style.display = 'none';
    }

    function deleteExpense(expenseId) {
        if (confirm('Are you sure you want to delete this expense?')) {
            const key = monthSelect.value;
            state.expenses[key] = state.expenses[key].filter(exp => exp.id !== expenseId);
            saveState();
            refresh();
        }
    }



    // --- Smart Calculator & OT Pattern Functions ---
    function populateHolidayChecklist() { 
      const checklistContainer = document.getElementById('holidayChecklist'); 
      checklistContainer.innerHTML = predefinedHolidays2025.map(holiday => { 
        const holidayDate = new Date(holiday.date + 'T00:00:00'); 
        const dateString = holidayDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }); 
        return `<div class="holiday-checkbox-item">
          <label for="holiday-${holiday.date}">
            <span>${holiday.name}</span>
            <span class="date">${dateString}</span>
          </label>
          <input type="checkbox" id="holiday-${holiday.date}" name="predefinedHolidays" value="${holiday.date}" checked>
        </div>`; 
      }).join(''); 
    }

    function addHoliday() { 
      const holidayPicker = document.getElementById('holidayPicker'); 
      const selectedDate = holidayPicker._flatpickr.selectedDates[0];
      if (!selectedDate) {
        alert('Please select a date for the public holiday.');
        return;
      } 
      const dateString = formatDateToYyyyMmDd(selectedDate);
      if (publicHolidays.includes(dateString)) { 
        alert("This custom holiday has already been added."); 
        return; 
      } 
      publicHolidays.push(dateString); 
      updateHolidayList(); 
      holidayPicker._flatpickr.clear();
    }

    function removeHoliday(date) { 
      publicHolidays = publicHolidays.filter(holiday => holiday !== date); 
      updateHolidayList(); 
    }

    function updateHolidayList() { 
      const holidayList = document.getElementById('holidayList'); 
      publicHolidays.sort(); 
      
      if (publicHolidays.length === 0) {
        holidayList.innerHTML = '<p style="color: var(--muted); font-style: italic; margin: 10px 0;">No custom holidays added yet.</p>';
        return;
      }
      
      holidayList.innerHTML = publicHolidays.map(date => { 
        const holidayDate = new Date(date + 'T00:00:00'); 
        const dayName = getDayOfWeek(holidayDate); 
        const formattedDate = holidayDate.toLocaleDateString('en-GB', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric' 
        }); 
        return `<div class="holiday-item">
          <div>
            <span style="color: var(--text);">${formattedDate}</span>
            <span style="color: var(--muted); font-size: 12px;">(${dayName})</span>
          </div>
          <button class="btn ghost" style="padding: 4px 8px; font-size: 12px;" onclick="removeHoliday('${date}')">&times;</button>
        </div>`; 
      }).join(''); 
    }

    function getSmartCalulatorInputs() {
        const startDate = document.getElementById('startDate')._flatpickr.selectedDates[0];
        const endDate = document.getElementById('endDate')._flatpickr.selectedDates[0];
        const basicSalary = parseFloat(document.getElementById('smartBasicSalary').value);

        if (!startDate || !endDate) { 
            alert("Please select a valid date range."); 
            return null; 
        }
        if (startDate > endDate) {
            alert("Start date cannot be after end date.");
            return null;
        }
        if (!basicSalary || basicSalary <= 0) { 
            alert('Please enter a valid Basic Salary.'); 
            return null; 
        }

        const hourlyRate = basicSalary / 208;
        const rates = { 
            restDay: hourlyRate * 0.5,
            normalOT: hourlyRate * 1.5,
            offDay: hourlyRate * 1.5,
            holiday: hourlyRate * 2.0
        };

        let daysInRange = [], currentDate = new Date(startDate);
        while (currentDate <= endDate) { 
            daysInRange.push(new Date(currentDate)); 
            currentDate.setDate(currentDate.getDate() + 1); 
        }

        const allHolidays = getAllHolidays();

        return { daysInRange, rates, allHolidays };
    }


    function applyOTPattern() {
        const inputs = getSmartCalulatorInputs();
        if (!inputs) return;

        const { daysInRange, rates, allHolidays } = inputs;
        lastGeneratedRates = rates;
        lastGeneratedAllHolidays = allHolidays;

        const patternSelect = document.getElementById('patternSelect');
        const selectedId = patternSelect.value;
        
        if (!selectedId) {
            alert("Please select a pattern to apply.");
            return;
        }

        const allPatterns = [...otPatterns.predefined, ...otPatterns.custom];
        const selectedPattern = allPatterns.find(p => p.id === selectedId);

        if (!selectedPattern) {
            alert("Selected pattern not found.");
            return;
        }
        
        const patternHours = selectedPattern.pattern; // [Mon, Tue, Wed, Thu, Fri, Sat, Sun]

        let dailyHours = [];
        daysInRange.forEach(date => {
            const dateString = formatDateToYyyyMmDd(date);
            const dayOfWeek = date.getDay(); // Sunday is 0, Monday is 1...
            const patternDayIndex = (dayOfWeek === 0) ? 6 : dayOfWeek - 1; // Adjust index for our pattern array
            const hours = patternHours[patternDayIndex] || 0;

            if (hours > 0) {
                const isHoliday = allHolidays.includes(dateString);
                let overtimeType = "", rate = 0;
                
                if (isHoliday) {
                    overtimeType = "Overtime 2.0x (Public Holiday)"; 
                    rate = rates.holiday; 
                } else if (dayOfWeek === 0) { // Sunday
                    overtimeType = "Rest Day OT (0.5x)"; 
                    rate = rates.restDay; 
                } else if (dayOfWeek === 6) { // Saturday
                    overtimeType = "Off Day 1.5x (Saturday)"; 
                    rate = rates.offDay; 
                } else { // Weekday
                    overtimeType = "Overtime 1.5x (Weekday)"; 
                    rate = rates.normalOT; 
                }

                dailyHours.push({ 
                    date: dateString, 
                    day: getDayOfWeek(date), 
                    hours: hours, 
                    pay: hours * rate, 
                    type: overtimeType, 
                    rate: rate
                });
            }
        });
        
        // NEW: Scale pattern to meet target if provided
        const targetPay = parseFloat(document.getElementById('targetPay').value);
        if (targetPay > 0) {
            const initialTotalPay = dailyHours.reduce((sum, day) => sum + day.pay, 0);
            if (initialTotalPay > 0) {
                const scaleFactor = targetPay / initialTotalPay;
                dailyHours.forEach(day => {
                    day.hours = Math.round((day.hours * scaleFactor) * 4) / 4; // Round to nearest 0.25
                    day.pay = day.hours * day.rate;
                });
            }
        }
        
        // Add start/end times after all calculations
        dailyHours.forEach(day => {
            const dayOfWeek = new Date(day.date + 'T00:00:00').getDay();
            day.startTime = generateRandomStartTime(dayOfWeek);
            day.endTime = calculateEndTime(day.startTime, day.hours);
        });

        calculatedDailyHours = dailyHours;
        displaySmartResults(calculatedDailyHours, targetPay);
    }

    function calculateSmartOT() {
        const inputs = getSmartCalulatorInputs();
        if (!inputs) return;
        const { daysInRange, rates, allHolidays } = inputs;
        lastGeneratedRates = rates;
        lastGeneratedAllHolidays = allHolidays;

        const targetPay = parseFloat(document.getElementById('targetPay').value);
        if (!targetPay || targetPay <= 0) { 
            alert('Please fill in a valid Target OT Pay!'); 
            return; 
        }
      
        // Use default hour limits for this calculation method
        const hourLimits = {
            weekday: { min: 2, max: 5 }, 
            saturday: { min: 4, max: 8 },
            sunday: { min: 4, max: 8 }, 
            holiday: { min: 4, max: 8 },
        };
      
        let dailyHours = [];
        daysInRange.forEach(date => {
            const dateString = formatDateToYyyyMmDd(date);
            const isHoliday = allHolidays.includes(dateString);
            const dayOfWeek = date.getDay();
            
            let overtimeType = "", rate = 0, dayTypeLimits;
            
            if (isHoliday) {
                overtimeType = "Overtime 2.0x (Public Holiday)"; 
                rate = rates.holiday; 
                dayTypeLimits = hourLimits.holiday;
            } else if (dayOfWeek === 0) {
                overtimeType = "Rest Day OT (0.5x)"; 
                rate = rates.restDay; 
                dayTypeLimits = hourLimits.sunday;
            } else if (dayOfWeek === 6) {
                overtimeType = "Off Day 1.5x (Saturday)"; 
                rate = rates.offDay; 
                dayTypeLimits = hourLimits.saturday;
            } else {
                overtimeType = "Overtime 1.5x (Weekday)"; 
                rate = rates.normalOT; 
                dayTypeLimits = hourLimits.weekday;
            }
            
            let randomHours = Math.random() * (dayTypeLimits.max - dayTypeLimits.min) + dayTypeLimits.min;
            randomHours = Math.round(randomHours * 4) / 4; // Round to nearest 0.25
            
            dailyHours.push({ 
                date: dateString, 
                day: getDayOfWeek(date), 
                hours: randomHours, 
                pay: randomHours * rate, 
                type: overtimeType, 
                rate: rate, 
                startTime: generateRandomStartTime(dayOfWeek) 
            });
        });
      
        const totalAllocatedPay = dailyHours.reduce((acc, day) => acc + day.pay, 0);
        const scaleFactor = totalAllocatedPay > 0 ? targetPay / totalAllocatedPay : 0;
      
        let finalDailyHours = dailyHours.map(day => {
            const scaledHours = day.hours * scaleFactor;
            const finalHours = Math.round(scaledHours * 4) / 4; // Round to nearest 0.25
            return { 
                ...day, 
                hours: finalHours, 
                pay: finalHours * day.rate, 
                endTime: calculateEndTime(day.startTime, finalHours) 
            };
        });
      
        calculatedDailyHours = finalDailyHours;
        displaySmartResults(finalDailyHours, targetPay);
    }

    function displaySmartResults(dailyHours, targetPay = null) {
      const totalHours = dailyHours.reduce((acc, day) => acc + day.hours, 0);
      const totalPay = dailyHours.reduce((acc, day) => acc + day.pay, 0);
      const totalDays = dailyHours.filter(day => day.hours > 0).length;
      
      let summaryHTML = `
        <div class="summary-item">
          <h4>Total OT Hours</h4>
          <div class="value">${totalHours.toFixed(1)}h</div>
        </div>
        <div class="summary-item">
          <h4>Achieved OT Pay</h4>
          <div class="value">RM ${totalPay.toFixed(2)}</div>
        </div>
        <div class="summary-item">
          <h4>Days with OT</h4>
          <div class="value">${totalDays}</div>
        </div>
      `;

      if (targetPay) {
        summaryHTML += `
        <div class="summary-item">
          <h4>Target Achievement</h4>
          <div class="value">${targetPay > 0 ? ((totalPay / targetPay) * 100).toFixed(1) : '0.0'}%</div>
        </div>`;
      }
      
      document.getElementById('smartSummary').innerHTML = summaryHTML;
      
      // --- Update and display hour adjusters ---
      const adjusterContainer = document.getElementById('smartHourAdjusterContainer');
      if (dailyHours.length > 0) {
        let totals = { weekday: 0, saturday: 0, sunday: 0, holiday: 0 };
        dailyHours.forEach(day => {
            const d = new Date(day.date + 'T00:00:00');
            const dayOfWeek = d.getDay();
            const isHoliday = lastGeneratedAllHolidays.includes(day.date);

            if (isHoliday) totals.holiday += day.hours;
            else if (dayOfWeek === 0) totals.sunday += day.hours;
            else if (dayOfWeek === 6) totals.saturday += day.hours;
            else totals.weekday += day.hours;
        });

        document.getElementById('weekdayHoursTotal').value = totals.weekday.toFixed(2) + 'h';
        document.getElementById('saturdayHoursTotal').value = totals.saturday.toFixed(2) + 'h';
        document.getElementById('sundayHoursTotal').value = totals.sunday.toFixed(2) + 'h';
        document.getElementById('holidayHoursTotal').value = totals.holiday.toFixed(2) + 'h';
        document.getElementById('smartTotalOtPayAdjuster').textContent = fmtDisplay(totalPay);

        adjusterContainer.style.display = 'block';
      } else {
        adjusterContainer.style.display = 'none';
      }


      const tableRows = dailyHours
        .filter(day => day.hours > 0)
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .map(day => `
          <tr>
            <td>${day.date}</td>
            <td><strong>${day.day}</strong></td>
            <td><span class="overtime-type ${getOvertimeTypeClass(day.type)}">${day.type}</span></td>
            <td>${day.startTime}</td>
            <td>${day.endTime}</td>
            <td><strong>${day.hours.toFixed(2)}h</strong></td>
            <td><strong>RM ${day.pay.toFixed(2)}</strong></td>
          </tr>
        `).join('');
      
      document.querySelector('#smartOTTable tbody').innerHTML = tableRows;
      
      document.getElementById('smartResults').style.display = 'block';
      if (targetPay) { // Only scroll into view on initial generation
        document.getElementById('smartResults').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    function exportToCSV() {
      if (calculatedDailyHours.length === 0) { 
        alert("No data to export. Please calculate first."); 
        return; 
      }
      
      const headers = ["Date", "Day", "OT Type", "Start Time", "End Time", "Hours", "Pay (RM)"];
      const rows = calculatedDailyHours.filter(day => day.hours > 0).map(day => [
        day.date, 
        day.day, 
        `"${day.type}"`, 
        day.startTime, 
        day.endTime, 
        day.hours.toFixed(2), 
        day.pay.toFixed(2)
      ].join(','));
      
      const csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.join("\n");
      const link = document.createElement("a");
      link.setAttribute("href", encodeURI(csvContent));
      link.setAttribute("download", "overtime_schedule.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function exportToPDF() {
      if (calculatedDailyHours.length === 0) { 
        alert("No data to export. Please calculate first."); 
        return; 
      }
      
      const { jsPDF } = window.jspdf;
      const resultsNode = document.getElementById('smartResults');
      
      html2canvas(resultsNode, { 
        scale: 2, 
        useCORS: true,
        backgroundColor: '#1a1a2e',
        logging: false
      }).then(canvas => {
        const imgData = canvas.toDataURL('image/png', 1.0);
        const pdf = new jsPDF({ 
          orientation: 'portrait', 
          unit: 'mm', 
          format: 'a4' 
        });
        
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const canvasAspectRatio = canvas.width / canvas.height;
        
        let imgWidth = pdfWidth - 20;
        let imgHeight = imgWidth / canvasAspectRatio;
        
        if (imgHeight > pdfHeight - 20) {
          imgHeight = pdfHeight - 20;
          imgWidth = imgHeight * canvasAspectRatio;
        }
        
        const x = (pdfWidth - imgWidth) / 2;
        const y = 10;
        
        pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
        pdf.save('overtime_schedule.pdf');
      }).catch(err => {
        console.error("PDF generation failed:", err);
        alert("❌ An error occurred while creating the PDF. Please try again.");
      });
    }

    function applyToManualTab() {
      if (calculatedDailyHours.length === 0) {
        alert("No smart calculation data to apply. Please calculate first.");
        return;
      }

      const currentMonth = monthSelect.value;
      const workingDays = calculatedDailyHours.filter(day => day.hours > 0);

      if (workingDays.length === 0) {
        alert("No overtime days found in the calculation.");
        return;
      }

      if (!confirm(`This will merge the generated hours with your existing entries for ${months.find(m => m.key === currentMonth)?.label || currentMonth}. Continue?`)) {
          return;
      }

      // ADD to existing entries instead of replacing
      workingDays.forEach(day => {
        const existingEntry = state.ot[currentMonth].find(entry => entry.date === day.date);

        if (existingEntry) {
          existingEntry.hours = (Number(existingEntry.hours) || 0) + day.hours;
          if (existingEntry.start) {
            existingEntry.end = calculateEndTime(existingEntry.start, existingEntry.hours);
          }
        } else {
          let multiplier = 1.5;
          if (day.type.includes('Rest Day')) multiplier = 0.5;
          else if (day.type.includes('Public Holiday')) multiplier = 2.0;
          else if (day.type.includes('1.5x')) multiplier = 1.5;

          state.ot[currentMonth].push({
            date: day.date,
            start: day.startTime,
            end: day.endTime,
            hours: day.hours,
            mult: multiplier,
            notes: 'Generated by Smart OT'
          });
        }
      });
      
      // Sort all entries by date after adding new ones
      state.ot[currentMonth].sort((a, b) => new Date(a.date) - new Date(b.date));


      saveState();
      switchTab('manual', document.querySelector('.tab[onclick*="manual"]'));
      refresh();
      alert(`✅ Schedule updated and merged successfully!`);
    }

    // --- OT Pattern Management ---
    function populatePatternSelector() {
        const select = document.getElementById('patternSelect');
        select.innerHTML = '<option value="">-- Select a pattern --</option>';

        const predefinedGroup = document.createElement('optgroup');
        predefinedGroup.label = 'Predefined Patterns';
        otPatterns.predefined.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.name;
            opt.title = p.description;
            predefinedGroup.appendChild(opt);
        });
        select.appendChild(predefinedGroup);

        if (otPatterns.custom.length > 0) {
            const customGroup = document.createElement('optgroup');
            customGroup.label = 'My Custom Patterns';
            otPatterns.custom.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = p.name;
                customGroup.appendChild(opt);
            });
            select.appendChild(customGroup);
        }
    }

    function saveCustomPattern() {
        const name = document.getElementById('customPatternName').value.trim();
        if (!name) {
            alert("Please enter a name for your custom pattern.");
            return;
        }

        const pattern = [
            Number(document.getElementById('customPatternMon').value) || 0,
            Number(document.getElementById('customPatternTue').value) || 0,
            Number(document.getElementById('customPatternWed').value) || 0,
            Number(document.getElementById('customPatternThu').value) || 0,
            Number(document.getElementById('customPatternFri').value) || 0,
            Number(document.getElementById('customPatternSat').value) || 0,
            Number(document.getElementById('customPatternSun').value) || 0,
        ];

        if (pattern.every(h => h === 0)) {
            alert("Pattern cannot be all zeros. Please enter some hours.");
            return;
        }
        
        // NEW: Check if we are editing or saving new
        if (editingPatternId) {
            const patternToUpdate = otPatterns.custom.find(p => p.id === editingPatternId);
            if (patternToUpdate) {
                patternToUpdate.name = `📝 ${name}`;
                patternToUpdate.pattern = pattern;
                alert(`✅ Pattern "${name}" updated!`);
            }
        } else {
            const newPattern = {
                id: `custom_${Date.now()}`,
                name: `📝 ${name}`,
                pattern: pattern
            };
            otPatterns.custom.push(newPattern);
            alert(`✅ Pattern "${name}" saved!`);
        }
        
        saveState();
        populatePatternSelector();
        cancelEditPattern(); // Reset form
    }
    
    // NEW: Function to load a pattern for editing
    function editPattern() {
        const select = document.getElementById('patternSelect');
        const selectedId = select.value;
        const pattern = otPatterns.custom.find(p => p.id === selectedId);

        if (pattern) {
            editingPatternId = selectedId;
            document.getElementById('customPatternName').value = pattern.name.replace('📝 ', '');
            document.getElementById('customPatternMon').value = pattern.pattern[0];
            document.getElementById('customPatternTue').value = pattern.pattern[1];
            document.getElementById('customPatternWed').value = pattern.pattern[2];
            document.getElementById('customPatternThu').value = pattern.pattern[3];
            document.getElementById('customPatternFri').value = pattern.pattern[4];
            document.getElementById('customPatternSat').value = pattern.pattern[5];
            document.getElementById('customPatternSun').value = pattern.pattern[6];
            
            document.getElementById('savePatternBtn').textContent = '💾 Update Pattern';
        }
    }
    
    // NEW: Function to reset the pattern editing form
    function cancelEditPattern() {
        editingPatternId = null;
        document.getElementById('customPatternName').value = '';
        ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].forEach(day => {
            document.getElementById(`customPattern${day}`).value = '';
        });
        document.getElementById('savePatternBtn').textContent = '💾 Save New Pattern';
    }


    function deleteCustomPattern() {
        const select = document.getElementById('patternSelect');
        const selectedId = select.value;

        if (!selectedId || !selectedId.startsWith('custom_')) {
            alert("Please select a custom pattern to delete.");
            return;
        }

        const patternName = select.options[select.selectedIndex].text;
        if (confirm(`Are you sure you want to delete the custom pattern "${patternName}"?`)) {
            otPatterns.custom = otPatterns.custom.filter(p => p.id !== selectedId);
            saveState();
            populatePatternSelector();
            alert(`🗑️ Pattern "${patternName}" deleted.`);
        }
    }

    // --- AI Suggestion Logic ---
    function aiSuggestSchedule() {
        const inputs = getSmartCalulatorInputs();
        if (!inputs) return;
        let { daysInRange, rates, allHolidays } = inputs;
        lastGeneratedRates = rates;
        lastGeneratedAllHolidays = allHolidays;

        let targetPay = parseFloat(document.getElementById('targetPay').value);
        if (!targetPay || targetPay <= 0) {
            alert('Please enter a valid Target OT Pay to generate an AI schedule!');
            return;
        }
        
        // NEW: Apply AI Constraints
        const blackoutDates = document.getElementById('blackoutDates')._flatpickr.selectedDates.map(d => formatDateToYyyyMmDd(d));
        const workStyle = document.getElementById('workStylePreference').value;
        daysInRange = daysInRange.filter(d => !blackoutDates.includes(formatDateToYyyyMmDd(d)));


        // 1. Analyze historical data
        const history = { weekday: [], saturday: [], sunday: [] };
        Object.values(state.ot).flat().forEach(entry => {
            const date = new Date(entry.date + 'T00:00:00');
            const day = date.getDay();
            if (day > 0 && day < 6) history.weekday.push(entry.hours);
            else if (day === 6) history.saturday.push(entry.hours);
            else if (day === 0) history.sunday.push(entry.hours);
        });

        const getAvg = arr => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
        let avgHours = {
            weekday: getAvg(history.weekday) || 4, // Default to 4 if no history
            saturday: getAvg(history.saturday) || 8, // Default to 8
            sunday: getAvg(history.sunday) || 8, // Default to 8
        };
        
        // NEW: Adjust avgHours based on work style preference
        if (workStyle === 'long_days') {
            avgHours.weekday *= 1.25;
            avgHours.saturday *= 1.25;
            avgHours.sunday *= 1.25;
        } else if (workStyle === 'short_sessions') {
            avgHours.weekday *= 0.75;
            avgHours.saturday *= 0.75;
            avgHours.sunday *= 0.75;
        }


        // 2. Map and prioritize all available days in the range
        let potentialSlots = daysInRange.map(date => {
            const dateString = formatDateToYyyyMmDd(date);
            const isHoliday = allHolidays.includes(dateString);
            const dayOfWeek = date.getDay();
            
            let type, rate, maxHours;
            if (isHoliday) {
                type = "Overtime 2.0x (Public Holiday)"; rate = rates.holiday; maxHours = avgHours.saturday; // Treat holidays like weekends
            } else if (dayOfWeek === 0) {
                type = "Rest Day OT (0.5x)"; rate = rates.restDay; maxHours = avgHours.sunday;
            } else if (dayOfWeek === 6) {
                type = "Off Day 1.5x (Saturday)"; rate = rates.offDay; maxHours = avgHours.saturday;
            } else {
                type = "Overtime 1.5x (Weekday)"; rate = rates.normalOT; maxHours = avgHours.weekday;
            }
            
            return { date: dateString, day: getDayOfWeek(date), type, rate, hours: 0, maxHours };
        }).sort((a, b) => b.rate - a.rate); // Sort by highest rate first

        // 3. Iteratively allocate hours to meet the target
        let remainingPay = targetPay;
        const hourIncrement = 0.5;

        while (remainingPay > 0) {
            let allocatedInThisLoop = false;
            for (const slot of potentialSlots) {
                if (remainingPay <= 0) break;
                if (slot.hours < slot.maxHours) {
                    const payForIncrement = hourIncrement * slot.rate;
                    if (payForIncrement > 0) {
                        slot.hours += hourIncrement;
                        remainingPay -= payForIncrement;
                        allocatedInThisLoop = true;
                    }
                }
            }
            if (!allocatedInThisLoop) break;
        }

        // 4. Format and display results
        const finalSchedule = potentialSlots
            .filter(s => s.hours > 0)
            .map(s => ({
                ...s,
                pay: s.hours * s.rate,
                startTime: generateRandomStartTime(new Date(s.date + 'T00:00:00').getDay()),
                endTime: calculateEndTime(generateRandomStartTime(new Date(s.date + 'T00:00:00').getDay()), s.hours)
            }));
        
        calculatedDailyHours = finalSchedule;
        displaySmartResults(finalSchedule, targetPay);
    }

    // --- Hour Adjuster Logic ---
    function adjustHours(rateType, amount) {
        if (calculatedDailyHours.length === 0) return;

        let relevantDays = calculatedDailyHours.filter(day => {
            const d = new Date(day.date + 'T00:00:00');
            const dayOfWeek = d.getDay();
            const isHoliday = lastGeneratedAllHolidays.includes(day.date);

            if (isHoliday) return rateType === 'holiday';
            if (rateType === 'sunday') return dayOfWeek === 0;
            if (rateType === 'saturday') return dayOfWeek === 6;
            if (rateType === 'weekday') return dayOfWeek > 0 && dayOfWeek < 6;
            return false;
        });

        if (amount > 0) { // ADDING hours
            if (relevantDays.length > 0) {
                let dayToModify = relevantDays.reduce((prev, curr) => prev.hours < curr.hours ? prev : curr);
                dayToModify.hours += amount;
            } else {
                alert(`No ${rateType} days in the generated schedule to add hours to.`);
                return;
            }
        } else { // SUBTRACTING hours
            let daysWithHours = relevantDays.filter(d => d.hours > 0);
            if (daysWithHours.length > 0) {
                let dayToModify = daysWithHours.reduce((prev, curr) => prev.hours > curr.hours ? prev : curr);
                dayToModify.hours += amount;
                dayToModify.hours = Math.max(0, dayToModify.hours);
            } else {
                return; // No hours to subtract
            }
        }

        // Recalculate pay for all entries and redisplay
        calculatedDailyHours.forEach(day => {
            day.pay = day.hours * day.rate;
            day.endTime = calculateEndTime(day.startTime, day.hours);
        });
        
        calculatedDailyHours = calculatedDailyHours.filter(d => d.hours > 0);

        displaySmartResults(calculatedDailyHours, null);
    }


    // --- Forecast Functions ---
    function calculateForecast() {
        const currentKey = monthSelect.value;
        const currentIndex = months.findIndex(m => m.key === currentKey);
        
        let totalHours = 0;
        let monthsCount = 0;
        
        for (let i = 1; i <= 3; i++) {
            if (currentIndex - i >= 0) {
                const prevMonthKey = months[currentIndex - i].key;
                const rows = state.ot[prevMonthKey] || [];
                totalHours += rows.reduce((sum, row) => sum + (Number(row.hours) || 0), 0);
                monthsCount++;
            }
        }
        
        const avgHours = monthsCount > 0 ? totalHours / monthsCount : 0;
        document.getElementById('forecastAvgHours').textContent = `${avgHours.toFixed(1)}h`;

        const p = state.params[currentKey];
        const projectedOtPay = avgHours * (Number(p.hourly) || 0) * 1.5; // Assume 1.5x for average
        const projectedGross = Number(p.basic) + Number(p.claims) + Number(p.hpAllow) + Number(p.incentive) + projectedOtPay;
        
        const projectedEpf = projectedGross * (Number(p.epf_pct)/100);
        const projectedSocso = projectedGross * (Number(p.socso_pct)/100);
        const projectedPcb = projectedGross * (Number(p.pcb_pct)/100);
        const projectedEis = projectedGross * (Number(p.eis_pct)/100);
        const projectedDeductions = projectedEpf + projectedSocso + projectedPcb + projectedEis + Number(p.advance);
        const projectedNet = projectedGross - projectedDeductions;

        document.getElementById('forecastGross').textContent = fmtDisplay(projectedGross);
        document.getElementById('forecastDeductions').textContent = fmtDisplay(projectedDeductions);
        document.getElementById('forecastNet').textContent = fmtDisplay(projectedNet);

        // Also initialize the what-if analysis
        updateWhatIf(0);
    }

    function updateWhatIf(additionalHours) {
        const key = monthSelect.value;
        const p = state.params[key];
        const { gross, deductions, net } = totalsFor(key); // Get current month's actuals

        const additionalOtPay = additionalHours * (Number(p.hourly) || 0) * 1.5;
        const whatIfGross = gross + additionalOtPay;

        // Recalculate deductions based on the new gross pay using percentages
        const whatIfEpf = whatIfGross * (Number(p.epf_pct)/100);
        const whatIfSocso = whatIfGross * (Number(p.socso_pct)/100);
        const whatIfPcb = whatIfGross * (Number(p.pcb_pct)/100);
        const whatIfEis = whatIfGross * (Number(p.eis_pct)/100);
        const whatIfDeductions = whatIfEpf + whatIfSocso + whatIfPcb + whatIfEis + Number(p.advance);
        const whatIfNet = whatIfGross - whatIfDeductions;

        document.getElementById('whatIfGross').textContent = fmtDisplay(whatIfGross);
        document.getElementById('whatIfDeductions').textContent = fmtDisplay(whatIfDeductions);
        document.getElementById('whatIfNet').textContent = fmtDisplay(whatIfNet);
    }

    function autoScheduleToGoal() {
        const key = monthSelect.value;
        const { net } = totalsFor(key);
        const p = state.params[key];
        const goal = Number(p.incomeGoal) || 0;
        const remainingNet = goal - net;

        if (remainingNet <= 0) {
            alert("You've already reached your net income goal!");
            return;
        }

        const totalDeductionPct = (Number(p.epf_pct) + Number(p.socso_pct) + Number(p.pcb_pct) + Number(p.eis_pct)) / 100;
        const requiredAdditionalGrossOt = remainingNet / (1 - totalDeductionPct);
        
        switchTab('smart', document.querySelector('.tab[onclick*="smart"]'));
        
        document.getElementById('targetPay').value = requiredAdditionalGrossOt.toFixed(2);
        aiSuggestSchedule();
    }
    
    function updateManualHourAdjusters() {
        const key = monthSelect.value;
        const rows = state.ot[key] || [];
        const adjusterContainer = document.getElementById('manualHourAdjusterContainer');
        const { otPay } = totalsFor(key);

        if (rows.length > 0) {
            let totals = { weekday: 0, saturday: 0, sunday: 0, holiday: 0 };
            const allHolidays = getAllHolidays();

            rows.forEach(row => {
                const d = new Date(row.date + 'T00:00:00');
                const dayOfWeek = d.getDay();
                const isHoliday = allHolidays.includes(row.date);
                const hours = Number(row.hours) || 0;

                if (isHoliday) totals.holiday += hours;
                else if (dayOfWeek === 0) totals.sunday += hours;
                else if (dayOfWeek === 6) totals.saturday += hours;
                else totals.weekday += hours;
            });

            document.getElementById('manualWeekdayHoursTotal').value = totals.weekday.toFixed(2) + 'h';
            document.getElementById('manualSaturdayHoursTotal').value = totals.saturday.toFixed(2) + 'h';
            document.getElementById('manualSundayHoursTotal').value = totals.sunday.toFixed(2) + 'h';
            document.getElementById('manualHolidayHoursTotal').value = totals.holiday.toFixed(2) + 'h';
            document.getElementById('manualTotalOtPayAdjuster').textContent = fmtDisplay(otPay);

            adjusterContainer.style.display = 'block';
        } else {
            adjusterContainer.style.display = 'none';
        }
    }

    function adjustManualHours(rateType, amount) {
        const key = monthSelect.value;
        const allHolidays = getAllHolidays();
        let relevantDays = state.ot[key].filter(day => {
            const d = new Date(day.date + 'T00:00:00');
            const dayOfWeek = d.getDay();
            const isHoliday = allHolidays.includes(day.date);

            if (isHoliday) return rateType === 'holiday';
            if (rateType === 'sunday') return dayOfWeek === 0;
            if (rateType === 'saturday') return dayOfWeek === 6;
            if (rateType === 'weekday') return dayOfWeek > 0 && dayOfWeek < 6;
            return false;
        });

        if (amount > 0) {
            if (relevantDays.length > 0) {
                let dayToModify = relevantDays.reduce((prev, curr) => (prev.hours || 0) < (curr.hours || 0) ? prev : curr);
                dayToModify.hours = (Number(dayToModify.hours) || 0) + amount;
                if (dayToModify.start) {
                    dayToModify.end = calculateEndTime(dayToModify.start, dayToModify.hours);
                }
            } else {
                alert(`No ${rateType} days in your schedule to add hours to. Please add a relevant day first.`);
                return;
            }
        } else {
            let daysWithHours = relevantDays.filter(d => (d.hours || 0) > 0);
            if (daysWithHours.length > 0) {
                let dayToModify = daysWithHours.reduce((prev, curr) => (prev.hours || 0) > (curr.hours || 0) ? prev : curr);
                dayToModify.hours = Math.max(0, (Number(dayToModify.hours) || 0) + amount);
                 if (dayToModify.start) {
                    dayToModify.end = calculateEndTime(dayToModify.start, dayToModify.hours);
                }
            } else {
                return; 
            }
        }
        
        saveState();
        refresh();
    }


    // --- Event Handlers ---
    function initCharts() {
      const computedStyle = getComputedStyle(document.documentElement);
      const mutedColor = computedStyle.getPropertyValue('--muted').trim();
      const textColor = computedStyle.getPropertyValue('--text').trim();
      const borderColor = computedStyle.getPropertyValue('--border').trim();
      const cardColor = computedStyle.getPropertyValue('--card').trim();
      const radiusSm = computedStyle.getPropertyValue('--radius-sm').trim();
      
      const tooltipOptions = {
            backgroundColor: 'rgba(22, 22, 37, 0.95)',
            titleColor: textColor,
            bodyColor: mutedColor,
            borderColor: borderColor,
            borderWidth: 1,
            cornerRadius: parseInt(radiusSm),
            padding: 12,
            titleFont: { family: "'Poppins', sans-serif" },
            bodyFont: { family: "'Poppins', sans-serif" }
        };

      const legendOptions = {
            position: 'top',
            labels: {
              usePointStyle: true,
              padding: 20,
              color: mutedColor,
              font: {
                  family: "'Poppins', sans-serif",
                  size: 12
              }
            }
        };

      // NEW: Income Composition Chart (Replaces old Gross/Net chart)
      chartGrossNet = new Chart(document.getElementById('chartGrossNet'), {
        type: 'bar',
        data: {
          labels: [],
          datasets: [
            { label: 'Basic', data: [], backgroundColor: 'rgba(80, 250, 123, 0.7)'},
            { label: 'OT', data: [], backgroundColor: 'rgba(255, 121, 198, 0.7)'},
            { label: 'Claims', data: [], backgroundColor: 'rgba(241, 250, 140, 0.7)'},
            { label: 'Incentive', data: [], backgroundColor: 'rgba(139, 233, 253, 0.7)' },
            { label: 'HP Allow', data: [], backgroundColor: 'rgba(189, 147, 249, 0.7)' }
          ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: legendOptions, tooltip: tooltipOptions },
            scales: {
              y: { stacked: true, beginAtZero: true, grid: { color: 'rgba(58, 58, 90, 0.5)', drawBorder: false }, ticks: { color: mutedColor } },
              x: { stacked: true, grid: { display: false }, ticks: { color: mutedColor } }
            }
        }
      });
      
      // OT Hours Chart (no change)
      chartOT = new Chart(document.getElementById('chartOT'), {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'OT Hours',
              data: [],
              backgroundColor: 'rgba(241, 250, 140, 0.1)',
              borderColor: 'rgba(241, 250, 140, 1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointBackgroundColor: 'rgba(241, 250, 140, 1)',
              pointBorderColor: cardColor,
              pointBorderWidth: 2,
              pointRadius: 6,
              pointHoverRadius: 8
            }
          ]
        },
        options: {
             responsive: true,
             maintainAspectRatio: false,
             plugins: { legend: legendOptions, tooltip: {...tooltipOptions, callbacks: {
                label: (context) => `${context.dataset.label}: ${context.parsed.y.toFixed(1)}h`
             }}},
             scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(58, 58, 90, 0.5)', drawBorder: false }, ticks: { color: mutedColor } },
                x: { grid: { display: false }, ticks: { color: mutedColor } }
            }
        }
      });
      
      // NEW: Expense Pie Chart
      expensePieChart = new Chart(document.getElementById('expensePieChart'), {
          type: 'pie',
          data: {
              labels: [],
              datasets: [{
                  data: [],
                  backgroundColor: ['#ff79c6', '#50fa7b', '#f1fa8c', '#bd93f9', '#8be9fd', '#ffb86c', '#ff5555'],
                  borderColor: 'var(--card)',
                  borderWidth: 2,
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: { display: false },
                  tooltip: {...tooltipOptions, callbacks: {
                      label: (context) => `${context.label}: ${fmtDisplay(context.parsed)}`
                  }}
              }
          }
      });
    }

    // --- Data Import/Export Functions ---
    function exportData() {
        const dataStr = JSON.stringify(state, null, 2);
        const dataBlob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.download = `salary-ot-dashboard-backup-${new Date().toISOString().split('T')[0]}.json`;
        link.href = url;
        link.click();
        URL.revokeObjectURL(url);
        showSaveMessage('✅ Data exported successfully!');
    }

    function importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = readerEvent => {
                    try {
                        const importedState = JSON.parse(readerEvent.target.result);
                        // Basic validation to check if it's a valid state file
                        if (importedState && importedState.params && importedState.ot) {
                            if (confirm("This will overwrite all current data. Are you sure you want to proceed?")) {
                                state = importedState;
                                saveState(); // This calls loadState again which will perform the migration
                                state = loadState(); 
                                refresh();
                                populatePatternSelector(); // Repopulate after import
                                showSaveMessage('✅ Data imported successfully!');
                            }
                        } else {
                            alert("Error: Invalid data file.");
                        }
                    } catch (err) {
                        alert("Error reading file. Please make sure it's a valid backup file.");
                        console.error(err);
                    }
                }
                reader.readAsText(file);
            }
        }
        input.click();
    }
    
    // --- NEW: Modal Handling ---
    function setupModals() {
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target === modal || e.target.classList.contains('modal-close-btn')) {
                    modal.classList.remove('active');
                }
            });
        });
    }
    
    // --- NEW: Budgeting Functions ---
    function openBudgetModal() {
        const key = monthSelect.value;
        const form = document.getElementById('budgetForm');
        form.innerHTML = ''; // Clear previous form
        
        const currentBudgets = state.budgets[key] || {};
        
        expenseCategories.forEach(cat => {
            const value = currentBudgets[cat] || '';
            const item = document.createElement('div');
            item.className = 'budget-item';
            item.innerHTML = `
                <label for="budget-${cat}">${cat}</label>
                <input type="number" id="budget-${cat}" step="0.01" placeholder="0.00" value="${value}" data-category="${cat}">
            `;
            form.appendChild(item);
        });
        
        document.getElementById('budgetModal').classList.add('active');
    }
    
    function saveBudgets() {
        const key = monthSelect.value;
        state.budgets[key] = {};
        document.querySelectorAll('#budgetForm input').forEach(input => {
            const category = input.dataset.category;
            const value = parseFloat(input.value);
            if (value > 0) {
                state.budgets[key][category] = value;
            }
        });
        saveState();
        document.getElementById('budgetModal').classList.remove('active');
        refresh();
        showSaveMessage('💰 Budgets saved successfully!');
    }
    
    // --- NEW: Recurring Expenses ---
    function copyRecurringExpenses() {
        const currentKey = monthSelect.value;
        const currentIndex = months.findIndex(m => m.key === currentKey);
        if (currentIndex === 0) {
            alert("Cannot copy, as this is the first month in the list.");
            return;
        }
        const lastMonthKey = months[currentIndex - 1].key;
        const recurringExpenses = (state.expenses[lastMonthKey] || []).filter(exp => exp.isRecurring);
        
        if (recurringExpenses.length === 0) {
            alert('No recurring expenses found in the previous month.');
            return;
        }
        
        let addedCount = 0;
        recurringExpenses.forEach(exp => {
            // Check if a similar recurring expense already exists to avoid duplicates
            const alreadyExists = (state.expenses[currentKey] || []).some(
                currentExp => currentExp.isRecurring && currentExp.desc === exp.desc
            );
            
            if (!alreadyExists) {
                const newDate = new Date(currentKey + '-01'); // Start of current month
                newDate.setDate(new Date(exp.date).getDate()); // Try to keep the same day
                if (newDate.getMonth() !== new Date(currentKey + '-01').getMonth()) {
                    newDate.setDate(0); // Last day of previous month if day doesn't exist
                }

                const newExpense = {
                    ...exp,
                    id: `exp_${Date.now()}_${Math.random()}`,
                    date: formatDateToYyyyMmDd(newDate)
                };
                state.expenses[currentKey].push(newExpense);
                addedCount++;
            }
        });

        if (addedCount > 0) {
            saveState();
            refresh();
            showSaveMessage(`✅ Copied ${addedCount} recurring expense(s) from last month.`);
        } else {
            alert('All recurring expenses from last month already exist in the current month.');
        }
    }
    
    // --- NEW: Annual Summary ---
    function openAnnualSummaryModal() {
        const yearSelect = document.getElementById('annualSummaryYearSelect');
        const uniqueYears = [...new Set(months.map(m => m.key.substring(0, 4)))];
        yearSelect.innerHTML = uniqueYears.map(y => `<option value="${y}">${y}</option>`).join('');
        
        const currentYear = new Date().getFullYear().toString();
        if (uniqueYears.includes(currentYear)) {
            yearSelect.value = currentYear;
        }

        generateAnnualSummary();
        document.getElementById('annualSummaryModal').classList.add('active');
    }

    function generateAnnualSummary() {
        const year = document.getElementById('annualSummaryYearSelect').value;
        const contentDiv = document.getElementById('annualSummaryContent');
        
        let totalGross = 0, totalNet = 0, totalOTHours = 0, totalDeductions = 0, totalExpenses = 0;
        const expenseCategoryTotals = {};
        
        months.filter(m => m.key.startsWith(year)).forEach(m => {
            const monthTotals = totalsFor(m.key);
            totalGross += monthTotals.gross;
            totalNet += monthTotals.net;
            totalDeductions += monthTotals.deductions;
            totalExpenses += monthTotals.totalExpenses;
            totalOTHours += (state.ot[m.key] || []).reduce((sum, row) => sum + Number(row.hours || 0), 0);
            
            (state.expenses[m.key] || []).forEach(exp => {
                const cat = exp.category || 'Uncategorized';
                expenseCategoryTotals[cat] = (expenseCategoryTotals[cat] || 0) + exp.amount;
            });
        });

        let html = `
            <div class="grid grid-3" style="margin-bottom: 24px;">
                 <div class="stat"><div class="label">Total Gross Income</div><div class="value">${fmtDisplay(totalGross)}</div></div>
                 <div class="stat"><div class="label">Total Net Income</div><div class="value" style="color:var(--success)">${fmtDisplay(totalNet)}</div></div>
                 <div class="stat"><div class="label">Total OT Hours</div><div class="value">${totalOTHours.toFixed(1)}h</div></div>
                 <div class="stat"><div class="label">Total Deductions</div><div class="value" style="color:var(--warning)">${fmtDisplay(totalDeductions)}</div></div>
                 <div class="stat"><div class="label">Total Expenses</div><div class="value" style="color:var(--danger)">${fmtDisplay(totalExpenses)}</div></div>
                 <div class="stat"><div class="label">Final Balance</div><div class="value" style="color:var(--success)">${fmtDisplay(totalNet - totalExpenses)}</div></div>
            </div>
            <h3 class="section-title" style="font-size: 20px; margin-bottom: 16px;">Expense Breakdown</h3>
        `;
        
        const sortedCategories = Object.keys(expenseCategoryTotals).sort((a,b) => expenseCategoryTotals[b] - expenseCategoryTotals[a]);
        sortedCategories.forEach(cat => {
            html += `<div class="annual-summary-item"><strong>${cat}</strong> <span>${fmtDisplay(expenseCategoryTotals[cat])}</span></div>`;
        });
        
        contentDiv.innerHTML = html;
    }

    // --- Initialize Everything ---
    document.addEventListener('DOMContentLoaded', function() {
      // Populate month selector
      months.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.key; 
        opt.textContent = m.label; 
        monthSelect.appendChild(opt);
      });
      
      // Set default month to current month
      const today = new Date();
      const currentMonthKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
      if (monthSelect.querySelector(`option[value="${currentMonthKey}"]`)) {
          monthSelect.value = currentMonthKey;
      } else {
          monthSelect.value = '2025-08'; // Fallback
      }

      // Initialize flatpickr on static date inputs
      flatpickr("#startDate, #endDate, #holidayPicker, #expenseDate", {
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "d M, Y",
      });
      flatpickr("#blackoutDates", {
        dateFormat: "Y-m-d", altInput: true, altFormat: "d M, Y", mode: "multiple"
      });
      document.getElementById('expenseDate')._flatpickr.setDate(new Date(), true);


      // Set up smart calculator salary input
      const smartSalaryInput = document.getElementById('smartBasicSalary'); 
      smartSalaryInput.value = '3700.00'; 
      smartSalaryInput.dispatchEvent(new Event('input'));

      // Initialize holiday checklist and OT patterns
      populateHolidayChecklist();
      populatePatternSelector();
      
      // Set up event listeners
      monthSelect.addEventListener('change', refresh);
      
      saveParamsBtn.addEventListener('click', () => {
        saveParamsBtn.classList.add('loading');
        setTimeout(() => {
          saveParams(monthSelect.value);
          saveParamsBtn.classList.remove('loading');
        }, 100);
      });

      copyLastMonthBtn.addEventListener('click', () => {
        const currentKey = monthSelect.value;
        const currentIndex = months.findIndex(m => m.key === currentKey);
        if (currentIndex > 0) {
            const lastMonthKey = months[currentIndex - 1].key;
            if (confirm(`This will overwrite the current settings for ${months[currentIndex].label} with the data from ${months[currentIndex - 1].label}. Are you sure?`)) {
                // Copy params
                state.params[currentKey] = { ...state.params[lastMonthKey] };
                saveState();
                refresh();
                showSaveMessage(`✅ Settings from ${months[currentIndex - 1].label} copied.`);
            }
        } else {
            alert("Cannot copy, as this is the first month in the list.");
        }
      });
      
      addRowBtn.addEventListener('click', () => {
        const key = monthSelect.value;
        if (!state.ot[key]) state.ot[key] = [];
        const todayStr = new Date().toISOString().split('T')[0];
        state.ot[key].push({ date: todayStr, start: '', end: '', hours: 0, mult: 1.5, notes: '' });
        saveState();
        refresh();
      });
      
      clearRowsBtn.addEventListener('click', () => {
        const key = monthSelect.value;
        const monthName = months.find(m => m.key === key)?.label || 'this month';
        if (confirm(`⚠️ Are you sure you want to clear all OT entries for ${monthName}? This cannot be undone.`)) {
          state.ot[key] = [];
          saveState();
          refresh();
        }
      });
      
      document.getElementById('resetAll').addEventListener('click', () => {
        if (confirm('⚠️ This will reset ALL data including settings, OT entries, and expenses for all months. Are you absolutely sure? This cannot be undone.')) {
          localStorage.removeItem('salary-ot-state-v5');
          state = loadState();
          showSaveMessage('🔄 All data has been reset to defaults');
          // Repopulate dropdown after reset
          monthSelect.innerHTML = '';
          months.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.key;
            opt.textContent = m.label;
            monthSelect.appendChild(opt);
          });
          monthSelect.value = '2025-08';
          populatePatternSelector();
          refresh();
        }
      });

      document.getElementById('exportData').addEventListener('click', exportData);
      document.getElementById('importData').addEventListener('click', importData);

      document.getElementById('whatIfSlider').addEventListener('input', (e) => {
          const hours = parseFloat(e.target.value);
          document.getElementById('whatIfHoursLabel').textContent = `${hours.toFixed(1)}h`;
          updateWhatIf(hours);
      });
      
      // NEW: Smart Goal Listeners
      smartGoalToggle.addEventListener('change', () => {
        updateSmartGoalUI();
        saveParams(monthSelect.value); // Save the toggle state and refresh
      });

      desiredSavings.addEventListener('input', () => {
          clearTimeout(desiredSavings.saveTimeout);
          desiredSavings.saveTimeout = setTimeout(() => {
            state.params[monthSelect.value].desiredSavings = Number(desiredSavings.value || 0);
            saveState();
            refresh();
          }, 1000);
      });

      // Add event listener for basic salary to auto-calculate hourly rate
      basic.addEventListener('input', () => {
        const basicSal = parseFloat(basic.value) || 0;
        const calculatedHourly = basicSal > 0 ? basicSal / 208 : 0;
        hourly.value = calculatedHourly.toFixed(4);
      });

      // Auto-save on input changes
      [basic, claims, hpAllow, incentive, advance, epf, socso, pcb, eis, incomeGoal].forEach(input => {
        input.addEventListener('input', () => {
          // Do not auto-save if smart goal is enabled, as it's controlled automatically
          if (input.id === 'incomeGoal' && smartGoalToggle.checked) return;
          
          clearTimeout(input.saveTimeout);
          input.saveTimeout = setTimeout(() => {
            saveParams(monthSelect.value);
          }, 1000);
        });
      });

      // Smart calculator event listeners
      document.getElementById('smartBasicSalary').addEventListener('input', function() { 
        const basicSalary = parseFloat(this.value) || 0; 
        const hourlyRate = basicSalary > 0 ? (basicSalary / 208).toFixed(2) : '0.00'; 
        const display = document.getElementById('smartHourlyRateDisplay'); 
        display.innerHTML = `Hourly Rate: RM <strong>${hourlyRate}</strong> | Rest Day: RM ${(hourlyRate * 0.5).toFixed(2)} | Normal/Off: RM ${(hourlyRate * 1.5).toFixed(2)} | Holiday: RM ${(hourlyRate * 2.0).toFixed(2)}`; 
        display.style.display = basicSalary > 0 ? 'block' : 'none'; 
      });

      // OT Pattern Listeners
      document.getElementById('applyPatternBtn').addEventListener('click', applyOTPattern);
      document.getElementById('savePatternBtn').addEventListener('click', saveCustomPattern);
      document.getElementById('deletePatternBtn').addEventListener('click', deleteCustomPattern);
      document.getElementById('editPatternBtn').addEventListener('click', editPattern);
      document.getElementById('patternSelect').addEventListener('change', (e) => {
        const isCustom = e.target.value.startsWith('custom_');
        document.getElementById('deletePatternBtn').disabled = !isCustom;
        document.getElementById('editPatternBtn').disabled = !isCustom;
        if (!isCustom && editingPatternId) {
            cancelEditPattern();
        }
      });


      // Expenses Listeners
      document.getElementById('addExpenseForm').addEventListener('submit', handleExpenseSubmit);
      document.getElementById('cancelEditBtn').addEventListener('click', cancelEdit);
      document.getElementById('expenseSearch').addEventListener('input', () => renderExpenses(monthSelect.value));
      document.querySelectorAll('#expensesTable th[data-sort]').forEach(th => {
          th.addEventListener('click', () => setExpenseSort(th.dataset.sort));
      });
      document.getElementById('clearExpensesBtn').addEventListener('click', () => {
        const key = monthSelect.value;
        const monthName = months.find(m => m.key === key)?.label || 'this month';
        if (confirm(`⚠️ Are you sure you want to clear all expenses for ${monthName}?`)) {
            state.expenses[key] = [];
            saveState();
            refresh();
        }
      });
      document.getElementById('copyRecurringExpensesBtn').addEventListener('click', copyRecurringExpenses);

      // Budgeting Listeners
      document.getElementById('setBudgetsBtn').addEventListener('click', openBudgetModal);
      document.getElementById('saveBudgetsBtn').addEventListener('click', saveBudgets);
      
      // Annual Summary Listeners
      document.getElementById('viewAnnualSummaryBtn').addEventListener('click', openAnnualSummaryModal);
      document.getElementById('annualSummaryYearSelect').addEventListener('change', generateAnnualSummary);


      // Prefill July with known entries if empty
      if (!state.ot['2025-07'] || state.ot['2025-07'].length === 0) {
        state.ot['2025-07'] = [
          {date:'2025-07-24', start: '19:00', end: '01:00', hours:6.00, mult:1.5, notes: ''},
          {date:'2025-07-23', start: '19:00', end: '00:30', hours:5.50, mult:1.5, notes: ''},
          {date:'2025-07-22', start: '19:00', end: '00:30', hours:5.50, mult:1.5, notes: ''},
          {date:'2025-07-21', start: '19:00', end: '23:30', hours:4.50, mult:1.5, notes: ''},
          {date:'2025-07-20', start: '10:00', end: '14:00', hours:4.00, mult:0.5, notes: ''},
          {date:'2025-07-19', start: '10:00', end: '14:30', hours:4.50, mult:1.5, notes: ''},
          {date:'2025-07-18', start: '19:00', end: '23:30', hours:4.50, mult:1.5, notes: ''},
          {date:'2025-07-17', start: '19:00', end: '00:30', hours:5.50, mult:1.5, notes: ''},
          {date:'2025-07-16', start: '19:00', end: '01:30', hours:6.50, mult:1.5, notes: ''},
          {date:'2025-07-15', start: '19:00', end: '02:00', hours:7.00, mult:1.5, notes: ''},
          {date:'2025-07-14', start: '19:00', end: '22:30', hours:3.50, mult:1.5, notes: ''},
          {date:'2025-07-11', start: '19:00', end: '00:00', hours:5.00, mult:1.5, notes: ''},
          {date:'2025-07-10', start: '19:00', end: '01:30', hours:6.50, mult:1.5, notes: ''},
          {date:'2025-07-09', start: '19:00', end: '01:00', hours:6.00, mult:1.5, notes: ''},
          {date:'2025-07-08', start: '19:00', end: '01:30', hours:6.50, mult:1.5, notes: ''},
          {date:'2025-07-07', start: '19:00', end: '00:55', hours:5.92, mult:1.5, notes: ''},
          {date:'2025-07-06', start: '10:00', end: '14:00', hours:4.00, mult:0.5, notes: ''},
          {date:'2025-07-05', start: '10:00', end: '14:00', hours:4.00, mult:1.5, notes: ''},
          {date:'2025-07-04', start: '19:00', end: '00:00', hours:5.00, mult:1.5, notes: ''},
          {date:'2025-07-03', start: '19:00', end: '01:00', hours:6.00, mult:1.5, notes: ''},
          {date:'2025-07-02', start: '19:00', end: '23:30', hours:4.50, mult:1.5, notes: ''},
          {date:'2025-07-01', start: '19:00', end: '02:30', hours:7.50, mult:1.5, notes: ''}
        ];
        saveState();
      }

      // Initialize charts, modals, and refresh
      initCharts();
      setupModals();
      refresh();
    });
  </script>
</body>
</html>
