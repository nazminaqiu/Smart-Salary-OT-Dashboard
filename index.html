<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Smart Salary & Overtime Tracker with AI Allocation</title>
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
    <!-- jsPDF for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- html2canvas for rendering UI to image for PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .modal-content .btn-group {
            flex-direction: column;
            gap: 15px;
        }
        
        .modal-content .btn-group .btn {
            width: 100%;
            margin: 0;
        }

        .global-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
            background: rgba(102, 126, 234, 0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            background: white;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab:hover {
            background: #667eea;
            color: white;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.checkbox-group {
            flex-direction: row;
            align-items: center;
            gap: 10px;
        }
        .form-group.checkbox-group input {
            width: auto;
        }


        .form-group label {
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s ease;
            margin-right: 10px;
            margin-top: 10px;
        }

        .btn:hover {
            transform: scale(1.05);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 14px;
            margin-top: 0;
        }
        
        #meetTargetBtn {
            padding: 8px 16px;
            font-size: 14px;
            margin-left: 0;
            margin-top: 8px;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-info {
            background: #17a2b8;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, tfoot td {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px;
            text-align: left;
        }

        #expenseTable th.sortable {
            cursor: pointer;
            position: relative;
        }
        #expenseTable th.sortable::after {
            content: ' ';
            position: absolute;
            right: 8px;
            opacity: 0.5;
            font-size: 0.8em;
        }
        #expenseTable th.sortable.sorted-asc::after {
            content: '▲';
            opacity: 1;
        }
        #expenseTable th.sortable.sorted-desc::after {
            content: '▼';
            opacity: 1;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        td input, td select {
            width: 100%;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        
        .hours-input-group {
            display: flex;
            align-items: center;
        }
        .hours-input-group input {
            text-align: center;
            border-right: none;
            border-left: none;
        }
        .hours-input-group button {
            width: 25px;
            height: 30px;
            border: 1px solid #ccc;
            background: #f0f0f0;
            cursor: pointer;
        }


        tr:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        #expenseTableBody td:not(:last-child):not(:nth-child(2)):not(:nth-child(9)):not(:nth-child(10)) {
             cursor: pointer;
        }
        
        tr.excluded-expense {
            background-color: #f8f9fa;
            color: #adb5bd;
            text-decoration: line-through;
        }
        tr.excluded-expense:hover {
            background-color: #e9ecef;
        }
        tr.excluded-expense .expense-category,
        tr.excluded-expense .split-pill {
            opacity: 0.6;
        }


        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        #summary-tab .summary-grid {
             grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .summary-item {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .expense-category, .split-pill {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            margin: 2px;
            text-transform: capitalize;
        }
        
        .split-pill {
            font-weight: 500;
            background-color: #e9ecef;
            color: #495057;
        }

        .category-food { background: #ff9800; color: white; }
        .category-groceries { background: #8bc34a; color: white; }
        .category-transport { background: #2196f3; color: white; }
        .category-utilities { background: #4caf50; color: white; }
        .category-subscriptions { background: #009688; color: white; }
        .category-shopping { background: #9c27b0; color: white; }
        .category-entertainment { background: #e91e63; color: white; }
        .category-health { background: #00bcd4; color: white; }
        .category-personal-care { background: #ffc107; color: #333; }
        .category-family { background: #3f51b5; color: white; }
        .category-gifts { background: #f44336; color: white; }
        .category-others { background: #607d8b; color: white; }
        .category-mortgage-rent { background: #6f42c1; color: white; }
        .category-savings-investments { background: #20c997; color: white; }
        .category-debt-loans { background: #fd7e14; color: white; }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .ot-allocation-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .ot-preview-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .savings-indicator {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
        }

        .savings-good {
            background: #28a745;
            color: white;
        }

        .savings-warning {
            background: #ffc107;
            color: #333;
        }

        .savings-danger {
            background: #dc3545;
            color: white;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1050;
            opacity: 0;
            transition: opacity 0.5s, top 0.5s;
        }

        .adjuster-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .adjuster-group .btn {
            margin: 0 5px;
        }
        
        #sticky-ot-summary {
            position: -webkit-sticky; /* For Safari */
            position: sticky;
            top: 10px; /* Adjust this value based on your preference */
            z-index: 10;
        }

        /* --- NEW PERCENTAGE INPUT STYLES --- */
        .percentage-group {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .percentage-input-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        .percentage-input-container label {
            font-weight: 500;
            justify-self: start;
        }
        .input-group {
            display: flex;
            align-items: center;
            justify-self: end;
        }
        .input-group input[type="number"].percentage-input {
            width: 70px;
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            color: #667eea;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 0 5px;
            -moz-appearance: textfield; /* Firefox */
        }
        .input-group input[type="number"].percentage-input::-webkit-outer-spin-button,
        .input-group input[type="number"].percentage-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .input-group button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid #ccc;
            background: #f0f0f0;
            font-weight: bold;
            font-size: 1.2em;
            cursor: pointer;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-bottom: 2px; /* Optical alignment */
        }
        #totalPercentage {
            font-weight: bold;
            margin-top: 10px;
            text-align: center;
        }
        
        /* --- MODAL STYLES --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1001;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 30px 40px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2em;
            cursor: pointer;
            color: #888;
        }
        .modal-content h2 {
            margin-bottom: 20px;
            font-size: 1.2em;
            color: #333;
        }
        
        /* --- SINKING FUNDS STYLES --- */
        .sinking-funds-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        .sinking-fund-card {
            border: 1px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .sinking-fund-card h4 {
            font-size: 1.2em;
            color: #333;
        }
        .sinking-fund-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #666;
        }

        /* --- AI COACH STYLES --- */
        #aiCoachSuggestions {
            margin-top: 15px;
        }
        .suggestion-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
        }
        .suggestion-item strong {
            color: #667eea;
        }


        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="toast-notification" class="toast" style="display: none;"></div>
    <input type="file" id="import-file" accept=".json" style="display: none;">
    <div class="container">
        <div class="header">
            <h1>💼 Advanced Smart Salary & Overtime Tracker</h1>
            <div class="btn-group">
                <button class="btn btn-warning" onclick="launchSimulator()">シ What-If Simulator</button>
                <button class="btn btn-info" onclick="triggerImport()">📥 Import Data</button>
                <button class="btn btn-secondary" onclick="exportData()">📤 Export Data</button>
            </div>
            <!-- GLOBAL SETTINGS -->
            <div class="global-settings">
                <div class="form-group">
                    <label>Pay Period</label>
                    <input type="text" id="payPeriod" placeholder="Select Pay Period...">
                </div>
                <div class="form-group">
                    <label>OT Start Date</label>
                    <input type="text" id="otStartDate" placeholder="Select Start Date...">
                </div>
                <div class="form-group">
                    <label>OT End Date</label>
                    <input type="text" id="otEndDate" placeholder="Select End Date...">
                </div>
                 <div class="form-group">
                    <label>Current Month</label>
                    <input type="text" id="currentMonth" readonly style="background: #f0f0f0; text-align: center; font-weight: bold;">
                </div>
            </div>
        </div>

        <div class="dashboard">
            <div class="card">
                <h3 class="card-title">📊 Monthly Summary</h3>
                <div class="stat-value" id="totalIncome">RM 0.00</div>
                <div class="stat-label">Total Income (with OT)</div>
                <div style="margin-top: 15px;">
                    <div class="stat-label">Net Income</div>
                    <div style="font-size: 1.8em; color: #4caf50; font-weight: bold;" id="netIncome">RM 0.00</div>
                </div>
            </div>
            
            <div class="card">
                <h3 class="card-title">🎯 Savings Target Status</h3>
                <div class="stat-value" id="savingsTargetDisplay">RM 0.00</div>
                <div class="stat-label">Target Savings This Month</div>
                <div style="margin-top: 15px;">
                    <div class="stat-label">Actual vs Target</div>
                    <div style="font-size: 1.5em; font-weight: bold;" id="savingsStatus">
                        <span id="savingsActual" data-value="0">RM 0.00</span>
                        <div id="savingsIndicatorContainer">
                            <span id="savingsIndicator" class="savings-indicator">On Track</span>
                            <button id="meetTargetBtn" class="btn btn-small btn-warning" onclick="meetSavingsTarget()" style="display: none;">Meet Target</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3 class="card-title">💰 Future Goals Savings</h3>
                <div class="stat-value" id="sinkingFundsTotal">RM 0.00</div>
                <div class="stat-label">Total Saved Across All Goals</div>
                <div style="margin-top: 15px;">
                    <div class="stat-label">Next Goal Due</div>
                    <div style="font-size: 1.5em; font-weight: bold;" id="nextGoalDue">N/A</div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab(event, 'salary')">💵 Salary & Auto-Deductions</div>
            <div class="tab" onclick="switchTab(event, 'targets')">🎯 Savings Targets</div>
            <div class="tab" onclick="switchTab(event, 'sinking-funds')">🌱 Future Goals & Sinking Funds</div>
            <div class="tab" onclick="switchTab(event, 'expenses')">📝 Expenses Tracker</div>
            <div class="tab" onclick="switchTab(event, 'overtime')">⏰ Smart OT Allocator</div>
            <div class="tab" onclick="switchTab(event, 'summary')">📊 Financial Summary</div>
        </div>

        <!-- Salary Input Tab -->
        <div id="salary-tab" class="tab-content active">
            <div class="form-section">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 class="card-title">Monthly Salary Input with Auto-Deductions</h3>
                    <button class="btn btn-info" onclick="copyLastMonthSalary()">⎘ Copy Last Month's Salary</button>
                </div>
                
                <div class="alert alert-info">
                    ℹ️ Your salary and deduction information is auto-saved whenever you make a change.
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Basic Salary (RM)</label>
                        <input type="number" id="basicSalary" value="3700" step="0.01" oninput="autoCalculateDeductions()">
                    </div>
                    <div class="form-group">
                        <label>Claims (RM)</label>
                        <input type="number" id="claims" placeholder="0.00" step="0.01" oninput="updateAndSaveSalary()">
                    </div>
                    <div class="form-group">
                        <label>HP Allowance (RM)</label>
                        <input type="number" id="hpAllowance" value="80" step="0.01" oninput="updateAndSaveSalary()">
                    </div>
                    <div class="form-group">
                        <label>Incentive (RM)</label>
                        <input type="number" id="incentive" value="500" step="0.01" oninput="updateAndSaveSalary()">
                    </div>
                    <div class="form-group">
                        <label>Bonus (RM)</label>
                        <input type="number" id="bonus" placeholder="0.00" step="0.01" oninput="updateAndSaveSalary()">
                    </div>
                    <div class="form-group">
                        <label>Other Income (RM)</label>
                        <input type="number" id="otherIncome" placeholder="0.00" step="0.01" oninput="updateAndSaveSalary()">
                    </div>
                </div>
                
                <h4 style="margin-top: 20px; margin-bottom: 15px;">Auto-Calculated Deductions</h4>
                <div class="form-grid">
                    <div class="form-group">
                        <label>EPF (11%) - Auto</label>
                        <input type="number" id="epf" value="407" step="0.01" readonly style="background: #f0f0f0;">
                    </div>
                    <div class="form-group">
                        <label>SOCSO - Auto</label>
                        <input type="number" id="socso" value="29.75" step="0.01" readonly style="background: #f0f0f0;">
                    </div>
                    <div class="form-group">
                        <label>EIS - Auto</label>
                        <input type="number" id="eis" value="11.90" step="0.01" readonly style="background: #f0f0f0;">
                    </div>
                    <div class="form-group">
                        <label>PCB (Tax) - Auto</label>
                        <input type="number" id="pcb" placeholder="0.00" step="0.01" readonly style="background: #f0f0f0;">
                    </div>
                    <div class="form-group">
                        <label>Cash Advance (RM)</label>
                        <input type="number" id="cashAdvance" placeholder="0.00" step="0.01" oninput="updateAndSaveSalary()">
                    </div>
                    <div class="form-group">
                        <label>Other Deductions (RM)</label>
                        <input type="number" id="otherDeductions" placeholder="0.00" step="0.01" oninput="updateAndSaveSalary()">
                    </div>
                </div>
                
                <button class="btn btn-secondary" onclick="resetSalaryForm()">Reset Form</button>
            </div>
        </div>

        <!-- Savings Targets Tab -->
        <div id="targets-tab" class="tab-content">
            <div class="form-section">
                <h3 class="card-title">Savings Target Calculator</h3>
                
                <div class="alert alert-success">
                    💡 Set your monthly savings target. The system will calculate required overtime based on your chosen expense basis.
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Target Monthly Savings (RM)</label>
                        <input type="number" id="targetSavings" placeholder="How much do you want to save?" step="50">
                    </div>
                    <div class="form-group">
                        <label id="expectedExpensesLabel">Expected Monthly Expenses <span id="expenseBasisLabel">(Your Share)</span></label>
                        <input type="number" id="expectedExpenses" placeholder="Auto-filled from tracker" step="50">
                    </div>
                    <div class="form-group">
                        <label>Emergency Fund Goal (RM)</label>
                        <input type="number" id="emergencyFundGoal" placeholder="Target emergency fund" step="100">
                    </div>
                    <div class="form-group">
                        <label>Current Emergency Fund (RM)</label>
                        <input type="number" id="currentEmergencyFund" placeholder="Current saved amount" step="100">
                    </div>
                </div>
                <label class="form-group checkbox-group" style="margin-top:8px; margin-bottom: 20px;">
                  <input type="checkbox" id="useHouseholdExpenses" style="width: 20px; height: 20px;">
                  Use household expenses (full amount) for planning
                </label>
                                
                <div id="savingsAnalysis" style="margin-top: 30px; display: none;">
                    <h4>Savings Analysis & Recommendations</h4>
                    <div class="alert" id="savingsAlert"></div>
                     <!-- AI COACH SECTION -->
                    <div id="aiCoachSection" class="alert alert-warning" style="display: none;">
                        <h4>💡 AI Savings Coach</h4>
                        <p id="aiCoachText"></p>
                        <div id="aiCoachSuggestions"></div>
                        <button id="applySavingsPlanBtn" class="btn btn-small btn-success" style="margin-top: 10px; display:none;" onclick="applyAISavingsPlan()">Apply This Savings Plan</button>
                    </div>
                    
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="stat-label">Base Net Income</div>
                            <div style="font-size: 1.5em; font-weight: bold;" id="baseNetIncome">RM 0.00</div>
                        </div>
                        <div class="summary-item">
                            <div class="stat-label">After Your Expenses</div>
                            <div style="font-size: 1.5em; font-weight: bold;" id="afterExpenses">RM 0.00</div>
                        </div>
                        <div class="summary-item">
                            <div class="stat-label">Your Savings Gap</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #ff9800;" id="otRequired">RM 0.00</div>
                        </div>
                        <div class="summary-item">
                            <div class="stat-label">Hours Needed</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #2196f3;" id="hoursNeeded">0 hrs</div>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" style="margin-top: 20px;" onclick="autoGenerateOTForTarget()">
                        🚀 Auto-Generate OT Schedule
                    </button>
                </div>
                
                <h4 style="margin-top: 30px;">Savings Progress Tracker</h4>
                <div class="progress-bar">
                    <div class="progress-fill" id="savingsProgress" style="width: 0%">0%</div>
                </div>
                
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="stat-label">This Month Saved</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #4caf50;" id="monthSaved">RM 0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="stat-label">YTD Savings</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #9c27b0;" id="ytdSavings">RM 0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="stat-label">Months to Emergency Fund</div>
                        <div style="font-size: 1.5em; font-weight: bold;" id="monthsToGoal">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sinking Funds Tab -->
        <div id="sinking-funds-tab" class="tab-content">
            <div class="form-section">
                <h3 class="card-title">Add a New Future Goal (Sinking Fund)</h3>
                <div class="alert alert-info">
                    Use this section to plan for large, upcoming expenses. The system will calculate a monthly savings amount to ensure you're prepared.
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Goal Name</label>
                        <input type="text" id="fundName" placeholder="e.g., Car Insurance 2026">
                    </div>
                    <div class="form-group">
                        <label>Total Amount Needed (RM)</label>
                        <input type="number" id="fundTotal" step="50" placeholder="e.g., 2500">
                    </div>
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="text" id="fundDueDate" placeholder="Select a future date...">
                    </div>
                </div>
                <button class="btn btn-success" onclick="addSinkingFund()">🌱 Add New Goal</button>
            </div>
            <div class="form-section">
                <h3 class="card-title">Your Active Goals</h3>
                <div id="sinkingFundsContainer" class="sinking-funds-grid">
                    <!-- Sinking funds will be dynamically added here -->
                </div>
            </div>
        </div>

        <!-- Expenses Tracker Tab -->
        <div id="expenses-tab" class="tab-content">
            <div class="form-section">
                 <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
                    <h3 class="card-title" style="margin-bottom: 0;">Expenses Tracker</h3>
                    <div>
                        <button class="btn btn-success" onclick="applyRecurringExpenses()">➕ Apply Recurring</button>
                        <button class="btn btn-info" onclick="copyLastMonthExpenses()">⎘ Copy Last Month's</button>
                        <button class="btn" onclick="launchExportPDFModal()">📄 Export to PDF</button>
                    </div>
                </div>
                
                <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="text" id="expenseDate" placeholder="Select Date...">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="expenseCategory">
                            <option value="mortgage_rent">🏠 Mortgage or Rent</option>
                            <option value="food">🍔 Food & Dining</option>
                            <option value="groceries">🛒 Groceries</option>
                            <option value="transport">🚗 Transportation</option>
                            <option value="utilities">💡 Utilities & Bills</option>
                            <option value="subscriptions">🔁 Subscriptions</option>
                            <option value="shopping">🛍️ Shopping</option>
                            <option value="entertainment">🎬 Entertainment</option>
                            <option value="health">🏥 Health & Medical</option>
                            <option value="debt_loans">💳 Debt & Loans</option>
                            <option value="personal_care">🧴 Personal Care</option>
                            <option value="family">👨‍👩‍👧‍👦 Family</option>
                            <option value="gifts">🎁 Gifts</option>
                            <option value="savings_investments">💰 Savings & Investments</option>
                            <option value="others">📦 Others</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Full Amount (RM)</label>
                        <input type="number" id="expenseFullAmount" step="0.01" oninput="applySplitProfile()">
                    </div>
                    <div class="form-group">
                        <label>Split Profile</label>
                        <select id="expenseSplitProfile" onchange="applySplitProfile()">
                            <option value="custom">Custom</option>
                            <option value="mine100">You Pay 100%</option>
                            <option value="partner100">Partner Pays 100%</option>
                            <option value="equal50">Split 50/50</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Your Share (RM)</label>
                        <input type="number" id="myShare" step="0.01" oninput="updateShares('mine')">
                    </div>
                     <div class="form-group">
                        <label>Partner's Share (RM)</label>
                        <input type="number" id="partnerShare" step="0.01" oninput="updateShares('partner')">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="expenseDescription">
                    </div>
                    <div class="form-group checkbox-group">
                         <label for="isRecurringExpense">Is Recurring?</label>
                        <input type="checkbox" id="isRecurringExpense" style="width: 20px; height: 20px;">
                    </div>
                </div>
                
                <button id="addExpenseBtn" class="btn" onclick="addExpense()">Add Expense</button>
                
                <table id="expenseTable">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortExpenses('date')">Date</th>
                            <th class="sortable" onclick="sortExpenses('category')">Category</th>
                            <th class="sortable" onclick="sortExpenses('description')">Description</th>
                            <th>Split</th>
                            <th class="sortable" onclick="sortExpenses('myShare')">My Share</th>
                            <th class="sortable" onclick="sortExpenses('partnerShare')">Partner's Share</th>
                            <th class="sortable" onclick="sortExpenses('fullAmount')">Full Amount</th>
                            <th>Recurring</th>
                            <th>Exclude</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="expenseTableBody">
                    </tbody>
                    <tfoot id="expenseTableFooter">
                    </tfoot>
                </table>
            </div>
        </div>
        
        <!-- Smart OT Allocator Tab -->
        <div id="overtime-tab" class="tab-content">
            <div class="form-section">
                <h3 class="card-title">Smart Overtime Allocator</h3>
                
                <div class="alert alert-info">
                    🤖 The system will intelligently allocate overtime hours to meet your target. The new logic ensures the target is always met if possible.
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Target OT Earnings (RM)</label>
                        <input type="number" id="targetOTEarnings" placeholder="Enter target OT amount" step="0.01" oninput="debouncedAllocation()">
                    </div>
                     <div class="form-group">
                        <label>Project/Task Name</label>
                        <input type="text" id="defaultProject" value="PERKESO KASEYA" placeholder="Default project name">
                    </div>
                     <div class="form-group">
                        <label>Allocation Strategy</label>
                        <select id="allocationStrategy">
                            <option value="balanced">Balanced (Default)</option>
                            <option value="front-load-weekends">Front-load Weekends</option>
                            <option value="front-load-weekdays">Front-load Weekdays</option>
                            <option value="back-load">Back-load</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-success" onclick="generateAndApplyOT()">🚀 Generate & Apply Schedule</button>
                <button class="btn btn-warning" onclick="previewOTAllocation()">👁️ Preview Allocation</button>
                <button class="btn" onclick="applyOTAllocation()">✅ Apply Allocation</button>
                
                <div id="otAllocationPreview" class="ot-allocation-preview" style="display: none;">
                    <h4>Preview: Smart OT Allocation</h4>
                    <div id="previewContent"></div>
                </div>
                
                <div id="sticky-ot-summary" style="display: none;">
                    <div class="form-section" style="padding-bottom: 15px; margin-bottom: 0; border-bottom-left-radius: 0; border-bottom-right-radius: 0;">
                        <h4 class="card-title">📊 OT Hours Adjuster</h4>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="stat-label">Total OT Hours</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="totalOTHoursSummary">0</div>
                            </div>
                            <div class="summary-item">
                                <div class="stat-label">Total OT Earnings</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="totalOTEarningsSummary">RM 0.00</div>
                            </div>
                        </div>
                         <div id="otTargetProgressBarContainer" style="margin-top: 15px; display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="otTargetProgress" style="width: 0%; background: linear-gradient(90deg, #28a745, #20c997);">0%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="otAdjuster" class="form-section" style="display: none; margin-top: 0; border-top-left-radius: 0; border-top-right-radius: 0;">
                    <div class="alert alert-info" style="margin-top: 15px;">
                        Use the buttons to proportionally adjust the total hours for each day type.
                    </div>
                    <div class="form-grid" id="otAdjusterGrid">
                        <!-- JS will populate this area -->
                    </div>
                    <div class="percentage-group">
                        <h4>Rate Allocation Percentage</h4>
                        <div class="percentage-input-container">
                            <label>0.5x (Sunday)</label>
                            <div class="input-group">
                                <button onclick="adjustPercentage('rate0_5', -1)">-</button>
                                <input type="number" id="rate0_5_input" class="percentage-input" min="0" max="100" step="1" value="10">
                                <button onclick="adjustPercentage('rate0_5', 1)">+</button>
                            </div>
                        </div>
                        <div class="percentage-input-container">
                            <label>1.5x (Weekday)</label>
                            <div class="input-group">
                                <button onclick="adjustPercentage('rate1_5_weekday', -1)">-</button>
                                <input type="number" id="rate1_5_weekday_input" class="percentage-input" min="0" max="100" step="1" value="70">
                                <button onclick="adjustPercentage('rate1_5_weekday', 1)">+</button>
                            </div>
                        </div>
                        <div class="percentage-input-container">
                            <label>1.5x (Saturday)</label>
                            <div class="input-group">
                                <button onclick="adjustPercentage('rate1_5_saturday', -1)">-</button>
                                <input type="number" id="rate1_5_saturday_input" class="percentage-input" min="0" max="100" step="1" value="10">
                                <button onclick="adjustPercentage('rate1_5_saturday', 1)">+</button>
                            </div>
                        </div>
                        <div class="percentage-input-container">
                            <label>2.0x (Public Holiday)</label>
                            <div class="input-group">
                                <button onclick="adjustPercentage('rate2_0', -1)">-</button>
                                <input type="number" id="rate2_0_input" class="percentage-input" min="0" max="100" step="1" value="10">
                                <button onclick="adjustPercentage('rate2_0', 1)">+</button>
                            </div>
                        </div>
                        <div id="totalPercentage">Total: 100%</div>
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h4 style="margin-top: 30px;">Current OT Entries</h4>
                    <button class="btn btn-small btn-danger" onclick="deleteAllOTEntries()">Delete All</button>
                </div>
                <table id="otTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Start</th>
                            <th>End</th>
                            <th>Hours</th>
                            <th>Rate</th>
                            <th>Remarks</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="otTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Financial Summary Tab -->
        <div id="summary-tab" class="tab-content">
            <div class="form-section">
                <div style="display:flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <h3 class="card-title" style="margin-bottom:0;">Financial Summary Dashboard</h3>
                    <div>
                        <button class="btn btn-success" onclick="generateSettleUpReport()">🤝 Settle Up Report</button>
                        <button id="summaryViewToggle" class="btn btn-info" onclick="toggleSummaryView()">View: My Cash Flow</button>
                    </div>
                </div>
                
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="stat-label">Gross Income</div>
                        <div style="font-size: 1.8em; font-weight: bold; color: #4caf50;" id="summaryGross">RM 0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="stat-label">Total Deductions</div>
                        <div style="font-size: 1.8em; font-weight: bold; color: #ff9800;" id="summaryDeductions">RM 0.00</div>
                    </div>
                     <div class="summary-item">
                        <div class="stat-label">Net Income</div>
                        <div style="font-size: 1.8em; font-weight: bold; color: #2196f3;" id="summaryNet">RM 0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="stat-label" id="summaryExpensesLabel">Expenses (Your Share)</div>
                        <div style="font-size: 1.8em; font-weight: bold; color: #dc3545;" id="summaryExpenses">RM 0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="stat-label">Personal Savings</div>
                        <div style="font-size: 1.8em; font-weight: bold; color: #9c27b0;" id="summarySavings">RM 0.00</div>
                    </div>
                    <div class="summary-item" id="summaryHouseholdCoverageItem" style="display: none;">
                        <div class="stat-label">Household Coverage</div>
                        <div style="font-size: 1.8em; font-weight: bold;" id="summaryHouseholdCoverage">RM 0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="stat-label">Savings Rate</div>
                        <div style="font-size: 1.8em; font-weight: bold;" id="savingsRate">0%</div>
                    </div>
                </div>
                
                <h4 style="margin-top: 30px;">Income Breakdown</h4>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="stat-label">Basic Salary</div>
                        <div style="font-size: 1.2em; font-weight: bold;" id="incomeBasic">RM 0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="stat-label">Overtime</div>
                        <div style="font-size: 1.2em; font-weight: bold;" id="incomeOT">RM 0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="stat-label">Allowances</div>
                        <div style="font-size: 1.2em; font-weight: bold;" id="incomeAllowances">RM 0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="stat-label">Others</div>
                        <div style="font-size: 1.2em; font-weight: bold;" id="incomeOthers">RM 0.00</div>
                    </div>
                </div>
                
                <h4 style="margin-top: 30px;" id="categoryBreakdownTitle">Expense Breakdown by Category (Your Share)</h4>
                <div id="categoryBreakdown" class="summary-grid"></div>
            </div>
        </div>
        
    </div>
    
    <!-- What-If Simulator Modal -->
    <div id="simulator-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="closeSimulator()">&times;</span>
            <h2>シ What-If Scenario Simulator</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Salary Increase (RM/month)</label>
                    <input type="number" id="simSalaryIncrease" placeholder="e.g., 200" oninput="runSimulation()">
                </div>
                <div class="form-group">
                    <label>New Recurring Expense (Your Share) (RM/month)</label>
                    <input type="number" id="simNewExpense" placeholder="e.g., 600" oninput="runSimulation()">
                </div>
                <div class="form-group">
                    <label>Reduce an Expense Category (%)</label>
                    <select id="simExpenseCategory" onchange="runSimulation()">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Reduction Percentage</label>
                    <input type="number" id="simExpenseReduction" placeholder="e.g., 10" oninput="runSimulation()">
                </div>
                 <!-- NEW: Partner Contribution Simulator -->
                <div class="form-group">
                    <label>Partner Adds (RM/month)</label>
                    <input type="number" id="simPartnerContribution" placeholder="e.g., 500" oninput="runSimulation()">
                </div>
            </div>
            <div id="simulationResult" class="alert alert-success" style="margin-top: 20px;">
                Enter a value to see the impact on your savings.
            </div>
        </div>
    </div>

    <!-- Settle Up Modal -->
    <div id="settleup-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="closeSettleUp()">&times;</span>
            <h2>🤝 Settle Up Report</h2>
            <div id="settleup-content"></div>
        </div>
    </div>

    <!-- Export PDF Modal -->
    <div id="export-pdf-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="closeExportPDFModal()">&times;</span>
            <h2>📄 Export Expenses to PDF</h2>
            <p style="margin-bottom: 20px;">Customize and generate a PDF report of your expenses for this period.</p>
            <div class="form-group">
                <label for="pdfReportTitle">Report Title</label>
                <input type="text" id="pdfReportTitle" placeholder="e.g., Monthly Expense Report">
            </div>
            <div class="form-group checkbox-group" style="justify-content: center; margin-bottom: 25px;">
                 <label for="pdfIncludeExcluded">Include excluded/hidden items?</label>
                <input type="checkbox" id="pdfIncludeExcluded" style="width: 20px; height: 20px;">
            </div>
            <button class="btn btn-success" style="width: 100%;" onclick="exportExpensesToPDF()">Download PDF</button>
        </div>
    </div>


    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/index.js"></script>
    <script>
        // --- HELPER FUNCTIONS ---
        const round2 = n => Math.round((n + Number.EPSILON) * 100) / 100;
        const fmtRM = n => `RM ${round2(n).toFixed(2)}`;
        
        // --- SIMULATOR LOGIC (IMPROVED) ---
        function launchSimulator() {
            const categorySelect = document.getElementById('simExpenseCategory');
            categorySelect.innerHTML = '<option value="">Select Category</option>';
            const categories = [...new Set(expenses.filter(e => !e.isExcluded).map(e => e.category))];
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
                categorySelect.appendChild(option);
            });
            document.getElementById('simulator-modal').style.display = 'flex';
            runSimulation();
        }

        function closeSimulator() {
            document.getElementById('simulator-modal').style.display = 'none';
        }

        function runSimulation() {
            const includedExpenses = expenses.filter(e => !e.isExcluded);
            const partnerContribution = parseFloat(document.getElementById('simPartnerContribution').value) || 0;

            const totalOT = overtimeEntries.reduce((s, e) => s + (e.amount || 0), 0);
            const grossIncome = salaryData.basic + salaryData.claims + salaryData.hpAllowance + salaryData.incentive + salaryData.bonus + (salaryData.otherIncome || 0) + totalOT;
            const totalDeductions = salaryData.epf + salaryData.socso + salaryData.eis + salaryData.pcb + salaryData.cashAdvance + salaryData.otherDeductions;

            const currentNetIncome = grossIncome - totalDeductions;
            const currentTotalMyShare = includedExpenses.reduce((s, e) => s + (e.myShare || 0), 0);

            const cat = document.getElementById('simExpenseCategory').value;
            const pct = parseFloat(document.getElementById('simExpenseReduction').value) || 0;
            const categoryTotal = cat ? includedExpenses.filter(e => e.category === cat).reduce((s, e) => s + (e.myShare || 0), 0) : 0;
            const reduction = round2(categoryTotal * (pct / 100));

            const simNetIncome = currentNetIncome + (parseFloat(document.getElementById('simSalaryIncrease').value) || 0);
            let simMyShare = currentTotalMyShare + (parseFloat(document.getElementById('simNewExpense').value) || 0) - reduction - partnerContribution;
            if (simMyShare < 0) simMyShare = 0;

            const originalSavings = currentNetIncome - currentTotalMyShare;
            const simulatedSavings = simNetIncome - simMyShare;
            const diff = simulatedSavings - originalSavings;

            document.getElementById('simulationResult').innerHTML = `
                Original Monthly Savings: <strong>${fmtRM(originalSavings)}</strong><br>
                Simulated Monthly Savings: <strong>${fmtRM(simulatedSavings)}</strong><br>
                Impact: <strong style="color:${diff>=0?'green':'red'};">${diff>=0?'+':''}${fmtRM(diff)}</strong>
            `;
        }

        const publicHolidays = {
            '2025': ['2025-01-01', '2025-01-29', '2025-01-30', '2025-02-01', '2025-02-12', '2025-03-31', '2025-05-01', '2025-05-12', '2025-06-02', '2025-06-07', '2025-08-31', '2025-09-16', '2025-12-25'],
            '2026': ['2026-01-01', '2026-02-17', '2026-02-18', '2026-03-20', '2026-03-21', '2026-05-01', '2026-05-26', '2026-06-01', '2026-05-28', '2026-06-17', '2026-08-31', '2026-09-16', '2026-08-26', '2026-10-21', '2026-12-25'],
            '2027': ['2027-01-01', '2027-02-06', '2027-02-07', '2027-03-10', '2027-03-11', '2027-05-01', '2027-05-15', '2027-06-07', '2027-05-17', '2027-06-06', '2027-08-31', '2027-09-16', '2027-08-15', '2027-11-09', '2027-12-25']
        };
        
        const strategyPresets = {
            'balanced': { rate0_5: 10, rate1_5_weekday: 70, rate1_5_saturday: 10, rate2_0: 10 },
            'front-load-weekends': { rate0_5: 40, rate1_5_weekday: 10, rate1_5_saturday: 40, rate2_0: 10 },
            'front-load-weekdays': { rate0_5: 5, rate1_5_weekday: 85, rate1_5_saturday: 5, rate2_0: 5 }
        };

        // Data storage
        let salaryData = {};
        let savingsGoalsData = {};
        let overtimeEntries = [];
        let expenses = [];
        let sinkingFunds = [];
        let recurringExpenses = [];
        let previewedOTEntries = [];
        let currentPayPeriod = '';
        let startDatePicker, endDatePicker, payPeriodPicker, expenseDatePicker, fundDueDatePicker;
        let expenseSortColumn = 'date';
        let expenseSortDirection = 'desc';
        let manualExpenseSet = false;
        let summaryView = 'my';
        let aiSavingsPlan = {};


        const generateId = () => 'id_' + Math.random().toString(36).substr(2, 9);
        
        function getMonthKey(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            return `${year}-${month}`;
        }
        
        function getNewPeriodData() {
            return {
                salaryData: { basic: 0, claims: 0, hpAllowance: 80, incentive: 500, bonus: 0, otherIncome: 0, epf: 0, socso: 0, eis: 0, pcb: 0, cashAdvance: 0, otherDeductions: 0 },
                overtimeEntries: [],
                expenses: [],
                savingsGoalsData: { targetSavings: 0, expectedExpenses: 0, emergencyFundGoal: 0, currentEmergencyFund: 0 }
            };
        }

        function migrateExpenseRow(row) {
            if (row.myShare == null && row.partnerShare == null) {
                const my = row.amount ?? 0;
                const split = row.splitPayment ?? Math.max(0, (row.fullAmount || 0) - my);
                const full = row.fullAmount ?? round2(my + split);
                row.myShare = round2(my);
                row.partnerShare = round2(full - row.myShare);
                row.fullAmount = full;
            }
            row.splitProfile = row.splitProfile || 'custom';
            row.isExcluded = row.isExcluded || false; // Ensure isExcluded property exists
            delete row.amount;
            delete row.splitPayment;
            return row;
        }

        function initializeData() {
            const now = new Date();
            currentPayPeriod = localStorage.getItem('lastPayPeriod') || getMonthKey(now);
            
            initializeDatePickers();
            initializeMonthPickers();
            
            const savedRecurring = localStorage.getItem('recurringExpenses');
            recurringExpenses = savedRecurring ? JSON.parse(savedRecurring) : [];
            
            const savedSinkingFunds = localStorage.getItem('sinkingFunds');
            sinkingFunds = savedSinkingFunds ? JSON.parse(savedSinkingFunds) : [];

            loadDataForPeriod(currentPayPeriod);
            
            updateAllDisplays();
            runForecast();
        }
        
        function handlePayPeriodChange(newPeriod) {
            if (!newPeriod || newPeriod === currentPayPeriod) return;
            
            if (localStorage.getItem(`salaryData_${currentPayPeriod}`)) {
                 saveDataForPeriod(currentPayPeriod);
            }

            currentPayPeriod = newPeriod;
            localStorage.setItem('lastPayPeriod', newPeriod);
            
            loadDataForPeriod(currentPayPeriod);
            setDefaultOtDates();
            updateAllDisplays();
        }

        function loadDataForPeriod(period) {
            manualExpenseSet = false;
            const savedSalary = localStorage.getItem(`salaryData_${period}`);

            if (savedSalary) {
                salaryData = JSON.parse(savedSalary);
                overtimeEntries = JSON.parse(localStorage.getItem(`overtimeEntries_${period}`) || '[]');
                const rawExpenses = JSON.parse(localStorage.getItem(`expenses_${period}`) || '[]');
                expenses = rawExpenses.map(migrateExpenseRow);
                savingsGoalsData = JSON.parse(localStorage.getItem(`savingsGoalsData_${period}`) || '{}');
            } else {
                const newData = getNewPeriodData();
                salaryData = newData.salaryData;
                overtimeEntries = newData.overtimeEntries;
                expenses = newData.expenses;
                savingsGoalsData = newData.savingsGoalsData;
            }

            document.getElementById('basicSalary').value = salaryData.basic || '';
            document.getElementById('claims').value = salaryData.claims || '';
            document.getElementById('hpAllowance').value = salaryData.hpAllowance || '80';
            document.getElementById('incentive').value = salaryData.incentive || '500';
            document.getElementById('bonus').value = salaryData.bonus || '';
            document.getElementById('otherIncome').value = salaryData.otherIncome || '';
            document.getElementById('cashAdvance').value = salaryData.cashAdvance || '';
            document.getElementById('otherDeductions').value = salaryData.otherDeductions || '';
            
            document.getElementById('targetSavings').value = savingsGoalsData.targetSavings || '';
            document.getElementById('expectedExpenses').value = savingsGoalsData.expectedExpenses || '';
            document.getElementById('emergencyFundGoal').value = savingsGoalsData.emergencyFundGoal || '';
            document.getElementById('currentEmergencyFund').value = savingsGoalsData.currentEmergencyFund || '';
            
            if (salaryData.customOtStartDate && salaryData.customOtEndDate) {
                startDatePicker.setDate(salaryData.customOtStartDate, false);
                endDatePicker.setDate(salaryData.customOtEndDate, false);
            } else {
                setDefaultOtDates();
            }
            
            const [year, month] = period.split('-').map(Number);
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('currentMonth').value = `${months[month - 1]} ${year}`;
        }

        function saveDataForPeriod(period) {
            if (!period) return;
            salaryData.customOtStartDate = document.getElementById('otStartDate').value;
            salaryData.customOtEndDate = document.getElementById('otEndDate').value;
            
            localStorage.setItem(`salaryData_${period}`, JSON.stringify(salaryData));
            localStorage.setItem(`overtimeEntries_${period}`, JSON.stringify(overtimeEntries));
            localStorage.setItem(`expenses_${period}`, JSON.stringify(expenses));
            localStorage.setItem(`savingsGoalsData_${period}`, JSON.stringify(savingsGoalsData));
            localStorage.setItem('sinkingFunds', JSON.stringify(sinkingFunds));
        }
        
        function updateAllDisplays() {
            autoCalculateDeductions();
            displayOTEntries();
            displayExpenses();
            displaySinkingFunds();
            updateDashboard();
            updateSummary();
            updateSavingsAnalysis();
        }
        
        function setDefaultOtDates() {
            const payPeriod = document.getElementById('payPeriod').value;
            if (!payPeriod) return;
            const [year, month] = payPeriod.split('-').map(Number);
            const otStartDate = new Date(year, month - 3, 26);
            const otEndDate = new Date(year, month - 2, 25);
            
            startDatePicker.setDate(otStartDate, true);
            endDatePicker.setDate(otEndDate, true);
        }

        function autoCalculateDeductions() {
            updateAndSaveSalary(); // Ensure salaryData is up to date before calculating
            const totalOT = overtimeEntries.reduce((sum, e) => sum + e.amount, 0);
            const { epf, socso, eis, pcb } = calculateDeductions(salaryData, totalOT);
            
            document.getElementById('epf').value = epf.toFixed(2);
            document.getElementById('socso').value = socso.toFixed(2);
            document.getElementById('eis').value = eis.toFixed(2);
            document.getElementById('pcb').value = pcb.toFixed(2);
            
            updateAndSaveSalary(); // Save the newly calculated values
        }

        function calculatePCB(taxableIncome) {
            if (taxableIncome <= 0) return 0;
            
            const dataPoints = [
                { income: 5916.59, pcb: 159.90 },
                { income: 7295.01, pcb: 311.50 },
                { income: 8584.76, pcb: 534.30 }
            ];

            if (taxableIncome <= dataPoints[0].income) {
                return (taxableIncome / dataPoints[0].income) * dataPoints[0].pcb;
            }

            if (taxableIncome >= dataPoints[dataPoints.length - 1].income) {
                return (taxableIncome / dataPoints[dataPoints.length - 1].income) * dataPoints[dataPoints.length - 1].pcb;
            }

            let lowerBound, upperBound;
            for (let i = 0; i < dataPoints.length - 1; i++) {
                if (taxableIncome >= dataPoints[i].income && taxableIncome <= dataPoints[i + 1].income) {
                    lowerBound = dataPoints[i];
                    upperBound = dataPoints[i + 1];
                    break;
                }
            }

            const incomeRange = upperBound.income - lowerBound.income;
            const pcbRange = upperBound.pcb - lowerBound.pcb;
            const incomeFraction = (taxableIncome - lowerBound.income) / incomeRange;

            return lowerBound.pcb + (incomeFraction * pcbRange);
        }

        function calculateDeductions(currentSalary, totalOT) {
            const basic = currentSalary.basic || 0;
            const incentive = currentSalary.incentive || 0;
            const bonus = currentSalary.bonus || 0;
            const otherIncome = currentSalary.otherIncome || 0;

            const epf = basic * 0.11;
            const socso = 29.75;
            const eis = 11.90;
            
            const taxableIncome = basic + incentive + bonus + otherIncome + totalOT;
            const pcb = calculatePCB(taxableIncome);

            return { epf, socso, eis, pcb };
        }
        
        function switchTab(event, tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            if (tabName === 'summary') updateSummary();
        }
        
        function updateAndSaveSalary() {
            salaryData.basic = parseFloat(document.getElementById('basicSalary').value) || 0;
            salaryData.claims = parseFloat(document.getElementById('claims').value) || 0;
            salaryData.hpAllowance = parseFloat(document.getElementById('hpAllowance').value) || 0;
            salaryData.incentive = parseFloat(document.getElementById('incentive').value) || 0;
            salaryData.bonus = parseFloat(document.getElementById('bonus').value) || 0;
            salaryData.otherIncome = parseFloat(document.getElementById('otherIncome').value) || 0;
            salaryData.epf = parseFloat(document.getElementById('epf').value) || 0;
            salaryData.socso = parseFloat(document.getElementById('socso').value) || 0;
            salaryData.eis = parseFloat(document.getElementById('eis').value) || 0;
            salaryData.pcb = parseFloat(document.getElementById('pcb').value) || 0;
            salaryData.cashAdvance = parseFloat(document.getElementById('cashAdvance').value) || 0;
            salaryData.otherDeductions = parseFloat(document.getElementById('otherDeductions').value) || 0;
            saveDataForPeriod(currentPayPeriod);
            updateDashboard();
            updateSavingsAnalysis();
        }

        function updateAndSaveSavingsGoals() {
            savingsGoalsData.targetSavings = parseFloat(document.getElementById('targetSavings').value) || 0;
            savingsGoalsData.expectedExpenses = parseFloat(document.getElementById('expectedExpenses').value) || 0;
            savingsGoalsData.emergencyFundGoal = parseFloat(document.getElementById('emergencyFundGoal').value) || 0;
            savingsGoalsData.currentEmergencyFund = parseFloat(document.getElementById('currentEmergencyFund').value) || 0;
            saveDataForPeriod(currentPayPeriod);
            updateDashboard();
            updateSavingsAnalysis();
        }
        
        function resetSalaryForm() {
            document.getElementById('basicSalary').value = '';
            document.getElementById('claims').value = '';
            document.getElementById('bonus').value = '';
            document.getElementById('otherIncome').value = '';
            document.getElementById('cashAdvance').value = '';
            document.getElementById('otherDeductions').value = '';
            autoCalculateDeductions();
        }

        let debounceTimer;
        
        function debounce(func, delay) {
            return function(...args) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => func.apply(this, args), delay);
            };
        }
        
        const debouncedAllocation = debounce(handleRealtimeAllocation, 500);
        
        function handleRealtimeAllocation() {
            const totalTargetEarnings = parseFloat(document.getElementById('targetOTEarnings').value) || 0;
            if (totalTargetEarnings <= 0) {
                if (overtimeEntries.length > 0) {
                     overtimeEntries = [];
                     saveDataForPeriod(currentPayPeriod);
                     displayOTEntries();
                     updateDashboard();
                }
                return;
            }
            generateSmartOTAllocation(true);
            applyOTAllocation(true);
            topUpOTToMeetTarget(true);
        }
        
        function initializeDatePickers() {
            startDatePicker = flatpickr("#otStartDate", {
                altInput: true, altFormat: "d/m/Y", dateFormat: "Y-m-d",
                onChange: function(selectedDates, dateStr) {
                    if (endDatePicker.selectedDates.length > 0 && selectedDates[0] > endDatePicker.selectedDates[0]) {
                        endDatePicker.setDate(selectedDates[0], true);
                    }
                    endDatePicker.set('minDate', dateStr);
                    saveDataForPeriod(currentPayPeriod);
                }
            });
            endDatePicker = flatpickr("#otEndDate", {
                altInput: true, altFormat: "d/m/Y", dateFormat: "Y-m-d",
                 onChange: function(selectedDates, dateStr) {
                    saveDataForPeriod(currentPayPeriod);
                }
            });
            expenseDatePicker = flatpickr("#expenseDate", {
                altInput: true,
                altFormat: "d/m/Y",
                dateFormat: "Y-m-d",
                defaultDate: "today"
            });
            fundDueDatePicker = flatpickr("#fundDueDate", {
                altInput: true,
                altFormat: "d/m/Y",
                dateFormat: "Y-m-d",
                minDate: "today"
            });
        }

        function initializeMonthPickers() {
            payPeriodPicker = flatpickr("#payPeriod", {
                plugins: [
                    new monthSelectPlugin({
                      shorthand: true,
                      dateFormat: "Y-m",
                      altFormat: "F, Y",
                    })
                ],
                onChange: function(selectedDates, dateStr, instance) {
                    handlePayPeriodChange(dateStr);
                }
            });
            payPeriodPicker.setDate(currentPayPeriod, false);
        }
        
        
        // --- Start of new percentage logic ---
        const percentageIds = ['rate0_5', 'rate1_5_weekday', 'rate1_5_saturday', 'rate2_0'];

        function readPercentages() {
            return percentageIds.map(id => parseInt(document.getElementById(id + '_input').value) || 0);
        }

        function writePercentages(vals) {
            vals.forEach((v, i) => {
                const id = percentageIds[i];
                const el = document.getElementById(id + '_input');
                if (el) el.value = v;
            });
        }

        function adjustPercentage(id, amount) {
            const input = document.getElementById(id + '_input');
            let currentValue = parseInt(input.value) || 0;
            currentValue += amount;
            input.value = Math.max(0, Math.min(100, currentValue));
            normalizePercentages();
            debouncedAllocation();
        }

        function normalizePercentages() {
            let vals = readPercentages();
            let sum = vals.reduce((a, b) => a + b, 0);
            const totalEl = document.getElementById('totalPercentage');

            if (sum === 100) {
                totalEl.textContent = 'Total: 100%';
                totalEl.style.color = '#333';
                return;
            }
            
            if (sum === 0) {
                vals = [25, 25, 25, 25];
            } else {
                vals = vals.map(v => Math.max(0, Math.round(v * 100 / sum)));
                let diff = 100 - vals.reduce((a, b) => a + b, 0);
                
                // Distribute rounding error
                let i = 0;
                while (diff !== 0) {
                    const idx = i % vals.length;
                    const adjustment = diff > 0 ? 1 : -1;
                    if (vals[idx] + adjustment >= 0) {
                        vals[idx] += adjustment;
                        diff -= adjustment;
                    }
                    i++;
                    if (i > 100) break; // Safety break
                }
            }
            
            writePercentages(vals);
            totalEl.textContent = 'Total: 100%';
            totalEl.style.color = '#333';
        }

        function initializePercentageInputs() {
            document.querySelectorAll('.percentage-input').forEach(el => {
                el.addEventListener('input', () => { 
                    normalizePercentages();
                    debouncedAllocation();
                });
            });
            document.getElementById('allocationStrategy').addEventListener('change', (event) => {
                updatePercentagesForStrategy(event.target.value);
            });
            normalizePercentages(); // Initial call
        }

        function updatePercentagesForStrategy(strategy) {
            const presets = strategyPresets[strategy];
            if (!presets) return;
            
            const vals = [presets.rate0_5, presets.rate1_5_weekday, presets.rate1_5_saturday, presets.rate2_0];
            writePercentages(vals);
            normalizePercentages();
            handleRealtimeAllocation();
        }
        // --- End of new percentage logic ---

        function generateAndApplyOT() {
            generateSmartOTAllocation(false); 
            
            if (previewedOTEntries.length > 0) {
                applyOTAllocation(true); 
                topUpOTToMeetTarget(); 
                showToast('🚀 Smart OT schedule has been generated and adjusted to meet the target!');
            }
        }

        function generateSmartOTAllocation(isSilent = false) {
            const currentPercentages = readPercentages();
            if (currentPercentages.reduce((a,b)=>a+b,0) !== 100) {
                if (!isSilent) alert("OT allocation percentages must sum to 100%. Please adjust the values.");
                return;
            }

            const totalTargetEarnings = parseFloat(document.getElementById('targetOTEarnings').value) || 0;
            const project = document.getElementById('defaultProject').value || 'General OT';
            const startDate = document.getElementById('otStartDate').value;
            const endDate = document.getElementById('otEndDate').value;
            const strategy = document.getElementById('allocationStrategy').value;

            if (!isSilent && !totalTargetEarnings) {
                alert('Please enter target earnings.');
                return;
            }
            if (!isSilent && (!startDate || !endDate)) {
                alert('Please select a valid date range.');
                return;
            }

            let percentages = {
                '0.5': currentPercentages[0],
                '1.5_weekday': currentPercentages[1],
                '1.5_saturday': currentPercentages[2],
                '2.0': currentPercentages[3]
            };

            const targetEarningsByRate = {
                '0.5': totalTargetEarnings * (percentages['0.5'] / 100),
                '1.5_weekday': totalTargetEarnings * (percentages['1.5_weekday'] / 100),
                '1.5_saturday': totalTargetEarnings * (percentages['1.5_saturday'] / 100),
                '2.0': totalTargetEarnings * (percentages['2.0'] / 100)
            };

            previewedOTEntries = [];
            for (const rateKey in targetEarningsByRate) {
                const targetForRate = targetEarningsByRate[rateKey];
                if (targetForRate > 0) {
                    const rate = parseFloat(rateKey.split('_')[0]);
                    const dayType = rateKey.includes('_') ? rateKey.split('_')[1] : null;
                    const entriesForRate = allocateOTHours(targetForRate, project, startDate, endDate, strategy, rate, dayType, isSilent);
                    previewedOTEntries.push(...entriesForRate);
                }
            }
            
            if (!isSilent) displayOTPreview(totalTargetEarnings);
        }

        function getAvailableRates(startDateStr, endDateStr) {
            const rates = new Set();
            let currentDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
             while (currentDate <= endDate) {
                const dayOfWeek = currentDate.getDay();
                const dateStr = currentDate.toISOString().split('T')[0];
                const year = currentDate.getFullYear().toString();
                if (publicHolidays[year] && publicHolidays[year].includes(dateStr)) {
                    rates.add(2.0);
                } else if (dayOfWeek === 0) {
                    rates.add(0.5);
                } else {
                    rates.add(1.5);
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return Array.from(rates);
        }

        /**
         * [MODIFIED] This function now uses a randomized allocation for duration.
         * It calculates the total hours, distributes them randomly based on weights,
         * and then runs a correction loop to precisely match the target.
         */
        function allocateOTHours(targetAmount, project, startDateStr, endDateStr, strategy, specificRate, dayType, isSilent) {
            const hourlyRate = getHourlyRate();
            if (hourlyRate <= 0) return [];

            let potentialDays = [];
            let currentDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);

            while (currentDate <= endDate) {
                const dayOfWeek = currentDate.getDay();
                const dateStr = currentDate.toISOString().split('T')[0];
                const year = currentDate.getFullYear().toString();
                let rate = 1.5;
                let isWeekend = false;
                let currentDayType = 'weekday';

                if (publicHolidays[year] && publicHolidays[year].includes(dateStr)) {
                    rate = 2.0; isWeekend = true; currentDayType = null;
                } else if (dayOfWeek === 0) {
                    rate = 0.5; isWeekend = true; currentDayType = null;
                } else if (dayOfWeek === 6) {
                    rate = 1.5; isWeekend = true; currentDayType = 'saturday';
                }
                
                let match = false;
                if (rate === specificRate) {
                    if (dayType === 'weekday' && !isWeekend) match = true;
                    else if (dayType === 'saturday' && currentDayType === 'saturday') match = true;
                    else if (!dayType && (rate === 0.5 || rate === 2.0)) match = true;
                }

                if (match) {
                    potentialDays.push({ date: new Date(currentDate), rate, isWeekend });
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }

            if (potentialDays.length === 0) return [];

            if (strategy === 'back-load') potentialDays.reverse();
            else if (strategy === 'front-load-weekends') potentialDays.sort((a, b) => b.isWeekend - a.isWeekend || a.date - b.date);
            else if (strategy === 'front-load-weekdays') potentialDays.sort((a, b) => a.isWeekend - b.isWeekend || a.date - b.date);

            let totalHoursNeeded = targetAmount / (hourlyRate * specificRate);
            const maxPossibleHours = potentialDays.length * 8;
            if (totalHoursNeeded > maxPossibleHours) {
                totalHoursNeeded = maxPossibleHours;
            }

            const entries = potentialDays.map(day => ({
                id: generateId(),
                date: day.date.toISOString().split('T')[0],
                dayName: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][day.date.getDay()],
                rate: day.rate,
                isWeekend: day.isWeekend,
                hours: 0,
                amount: 0,
                remarks: project + ' - ' + generateTaskDescription(day.date)
            }));

            // --- NEW RANDOMIZED DURATION LOGIC ---
            // Step 1: Assign random weights for duration distribution
            entries.forEach(entry => { entry.weight = Math.random(); });

            // Step 2: Calculate initial proportional hours based on weights
            const totalWeight = entries.reduce((sum, e) => sum + e.weight, 0);
            if (totalWeight > 0) {
                entries.forEach(entry => {
                    const idealHours = (entry.weight / totalWeight) * totalHoursNeeded;
                    entry.hours = Math.min(8, Math.round(idealHours * 4) / 4);
                });
            }

            // Step 3: Correct for rounding errors to precisely match the target hours
            let currentTotalHours = entries.reduce((sum, e) => sum + e.hours, 0);
            let hourDifference = round2(totalHoursNeeded - currentTotalHours);
            let safetyNet = 0;

            while (Math.abs(hourDifference) > 0.01 && safetyNet < 500) {
                const increment = 0.25 * Math.sign(hourDifference);

                if (increment > 0) {
                    let eligibleToAdd = entries.filter(e => e.hours < 8);
                    if (eligibleToAdd.length === 0) break;
                    const randomIndex = Math.floor(Math.random() * eligibleToAdd.length);
                    eligibleToAdd[randomIndex].hours += increment;
                } else {
                    let eligibleToRemove = entries.filter(e => e.hours > 0);
                    if (eligibleToRemove.length === 0) break;
                    const randomIndex = Math.floor(Math.random() * eligibleToRemove.length);
                    eligibleToRemove[randomIndex].hours += increment;
                }

                hourDifference = round2(hourDifference - increment);
                safetyNet++;
            }
            // --- END OF NEW LOGIC ---

            entries.forEach(entry => {
                entry.hours = round2(entry.hours);
                entry.amount = entry.hours * hourlyRate * entry.rate;
                
                const startHourBase = entry.isWeekend ? 9 : 18;
                const randomHourOffset = Math.floor(Math.random() * 3);
                const randomMinute = Math.floor(Math.random() * 4) * 15;
                
                const startHour = startHourBase + randomHourOffset;
                entry.startTime = `${String(startHour).padStart(2, '0')}:${String(randomMinute).padStart(2, '0')}`;

                const totalStartMinutes = (startHour * 60) + randomMinute;
                const totalDurationMinutes = entry.hours * 60;
                const totalEndMinutes = totalStartMinutes + totalDurationMinutes;

                const endHour = Math.floor(totalEndMinutes / 60);
                const endMinute = Math.round(totalEndMinutes % 60);
                entry.endTime = `${String(endHour % 24).padStart(2, '0')}:${String(endMinute).padStart(2, '0')}`;
            });
            
            return entries.filter(e => e.hours > 0);
        }
        
        function applyOTAllocation(isSilent = false) {
            if (!isSilent && previewedOTEntries.length === 0) {
                alert('Please generate an allocation first');
                return;
            }
            if (!isSilent && !confirm(`Apply ${previewedOTEntries.length} OT entries?`)) return;

            overtimeEntries = previewedOTEntries;
            saveDataForPeriod(currentPayPeriod);
            previewedOTEntries = [];
            document.getElementById('otAllocationPreview').style.display = 'none';
            displayOTEntries();
            updateDashboard();
            if (!isSilent) showToast('OT allocation applied successfully!');
        }
        
        function topUpOTToMeetTarget(isSilent = false) {
            const targetEarnings = parseFloat(document.getElementById('targetOTEarnings').value) || 0;
            if (targetEarnings <= 0 || overtimeEntries.length === 0) return;

            const currentEarnings = overtimeEntries.reduce((sum, e) => sum + (e.amount || 0), 0);
            let gap = targetEarnings - currentEarnings;

            if (Math.abs(gap) <= 0.01) {
                if (!isSilent) showToast('✅ Target already met!');
                return;
            }

            const hourly = getHourlyRate();
            if (!hourly) return;

            overtimeEntries.sort((a, b) => (b.rate - a.rate) || (a.hours - b.hours));
            let safetyNet = 0;

            while (Math.abs(gap) > 0.01 && safetyNet < 200) {
                let entryToBoost = overtimeEntries.find(e => e.hours < 8);
                if (!entryToBoost) {
                    console.warn("Could not meet OT target because all available days are maxed out at 8 hours.");
                    break;
                }

                const earningsPerIncrement = 0.25 * hourly * entryToBoost.rate;
                const canAddHours = 8 - entryToBoost.hours;
                
                if (gap >= earningsPerIncrement && canAddHours >= 0.25) {
                    entryToBoost.hours += 0.25;
                    gap -= earningsPerIncrement;
                } else {
                    const hoursNeededForGap = gap / (hourly * entryToBoost.rate);
                    if (canAddHours >= hoursNeededForGap) {
                        entryToBoost.hours += hoursNeededForGap;
                        gap = 0;
                    } else {
                        const partialAmount = canAddHours * hourly * entryToBoost.rate;
                        entryToBoost.hours = 8;
                        gap -= partialAmount;
                    }
                }
                safetyNet++;
            }

            overtimeEntries.forEach(entry => {
                entry.hours = round2(entry.hours);
                entry.amount = round2(entry.hours * hourly * entry.rate);
                if (entry.startTime) {
                    entry.endTime = addHoursToTime(entry.startTime, entry.hours);
                }
            });

            saveDataForPeriod(currentPayPeriod);
            displayOTEntries();
            updateDashboard();
            if (!isSilent) showToast('🎯 OT schedule topped up to meet target!');
        }
        
        function generateTaskDescription(date) {
            const dayOfWeek = date.getDay();
            const hour = date.getHours();

            const tasks = {
                weeknight: ["Report prep", "Data analysis", "Client follow-up", "System maintenance", "Code review"],
                weekend: ["System upgrade", "Server backup", "Database migration", "Feature deployment", "Documentation"],
                lateNight: ["Critical patch", "Emergency support", "System diagnostics", "Security scan"]
            };

            let taskPool;
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                taskPool = tasks.weekend;
            } else {
                taskPool = tasks.weeknight;
            }

            if (hour >= 22 || hour < 6) {
                taskPool = taskPool.concat(tasks.lateNight);
            }
            
            return taskPool[Math.floor(Math.random() * taskPool.length)];
        }
        
        function displayOTPreview(targetAmount) {
            const previewDiv = document.getElementById('otAllocationPreview');
            const contentDiv = document.getElementById('previewContent');
            previewDiv.style.display = 'block';
            contentDiv.innerHTML = '';
            let totalHours = 0, totalAmount = 0;
            previewedOTEntries.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(entry => {
                totalHours += entry.hours; totalAmount += entry.amount;
                const item = document.createElement('div');
                item.className = 'ot-preview-item';
                item.innerHTML = `<div><strong>${entry.date}</strong> (${entry.dayName})<br>${entry.startTime} - ${entry.endTime}</div><div>${entry.hours.toFixed(2)}h @ ${entry.rate}x<br><strong>RM ${entry.amount.toFixed(2)}</strong></div>`;
                contentDiv.appendChild(item);
            });
            
            if (targetAmount && totalAmount < targetAmount * 0.99) {
                const warning = document.createElement('div');
                warning.className = 'alert alert-warning';
                warning.innerHTML = `<strong>Warning:</strong> Target of RM ${targetAmount.toFixed(2)} could not be reached with the 8-hour daily cap. The maximum achievable is <strong>RM ${totalAmount.toFixed(2)}</strong>.`;
                contentDiv.prepend(warning);
            }

            const summary = document.createElement('div');
            summary.style.cssText = 'margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 5px;';
            summary.innerHTML = `<strong>Total: ${totalHours.toFixed(2)} hours = RM ${totalAmount.toFixed(2)}</strong>`;
            contentDiv.appendChild(summary);
        }
        
        function previewOTAllocation() {
            if (previewedOTEntries.length === 0) { alert('Please generate an allocation first'); return; }
            const previewDiv = document.getElementById('otAllocationPreview');
            previewDiv.style.display = previewDiv.style.display === 'none' ? 'block' : 'none';
        }
        
        function getDayType(entry) {
            const date = new Date(entry.date);
            const dateStr = entry.date;
            const year = date.getFullYear().toString();
            if (publicHolidays[year] && publicHolidays[year].includes(dateStr)) return 'publicHoliday';
            const dayOfWeek = date.getDay();
            if (dayOfWeek === 0) return 'sunday';
            if (dayOfWeek === 6) return 'saturday';
            return 'weekday';
        }

        function displayOTEntries() {
            const tbody = document.getElementById('otTableBody');
            tbody.innerHTML = '';
            let totalHours = 0, totalAmount = 0;
            let hoursByDayType = { weekday: 0, saturday: 0, sunday: 0, publicHoliday: 0 };

            overtimeEntries.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            overtimeEntries.forEach(entry => {
                totalHours += entry.hours; 
                totalAmount += entry.amount;
                
                const dayType = getDayType(entry);
                hoursByDayType[dayType] += entry.hours;

                const row = tbody.insertRow();
                row.id = `ot-row-${entry.id}`;
                row.innerHTML = `
                    <td><input type="date" value="${entry.date}" onchange="saveOTEntry('${entry.id}')"></td>
                    <td><input type="time" value="${entry.startTime}" onchange="saveOTEntry('${entry.id}')"></td>
                    <td><input type="time" value="${entry.endTime}" onchange="saveOTEntry('${entry.id}')"></td>
                    <td>
                        <div class="hours-input-group">
                            <button onclick="adjustHour('${entry.id}', -0.25)">-</button>
                            <input type="number" step="0.25" value="${entry.hours.toFixed(2)}" onchange="saveOTEntry('${entry.id}')">
                            <button onclick="adjustHour('${entry.id}', 0.25)">+</button>
                        </div>
                    </td>
                    <td>
                        <select onchange="saveOTEntry('${entry.id}')">
                            <option value="0.5" ${entry.rate === 0.5 ? 'selected' : ''}>0.5x</option>
                            <option value="1.5" ${entry.rate === 1.5 ? 'selected' : ''}>1.5x</option>
                            <option value="2.0" ${entry.rate === 2.0 ? 'selected' : ''}>2.0x</option>
                            <option value="3.0" ${entry.rate === 3.0 ? 'selected' : ''}>3.0x</option>
                        </select>
                    </td>
                    <td><input type="text" value="${entry.remarks}" onchange="saveOTEntry('${entry.id}')"></td>
                    <td>
                        <button class="btn btn-small btn-danger" onclick="deleteOTEntry('${entry.id}')">Delete</button>
                    </td>`;
            });
            
            document.getElementById('totalOTHoursSummary').textContent = totalHours.toFixed(2);
            document.getElementById('totalOTEarningsSummary').textContent = fmtRM(totalAmount);
            
            const adjusterDiv = document.getElementById('otAdjuster');
            const stickySummaryDiv = document.getElementById('sticky-ot-summary');

            if (overtimeEntries.length > 0) {
                const adjusterGrid = document.getElementById('otAdjusterGrid');
                adjusterGrid.innerHTML = '';

                const dayTypes = {
                    weekday: "Weekday",
                    saturday: "Saturday",
                    sunday: "Sunday",
                    publicHoliday: "Public Holiday"
                };

                for (const dayType in dayTypes) {
                    if (hoursByDayType[dayType] > 0) {
                        const formGroup = document.createElement('div');
                        formGroup.className = 'adjuster-group';
                        formGroup.innerHTML = `
                            <label>${dayTypes[dayType]} Hours: <strong id="display_day_${dayType}">${hoursByDayType[dayType].toFixed(2)}</strong></label>
                            <div>
                                <button class="btn btn-small btn-secondary" onclick="adjustHoursByDayType('${dayType}', -1)">-1hr</button>
                                <button class="btn btn-small btn-secondary" onclick="adjustHoursByDayType('${dayType}', -0.25)">-15m</button>
                                <button class="btn btn-small btn-secondary" onclick="adjustHoursByDayType('${dayType}', 0.25)">+15m</button>
                                <button class="btn btn-small btn-secondary" onclick="adjustHoursByDayType('${dayType}', 1)">+1hr</button>
                            </div>
                        `;
                        adjusterGrid.appendChild(formGroup);
                    }
                }
                adjusterDiv.style.display = 'block';
                stickySummaryDiv.style.display = 'block'; 
            } else {
                adjusterDiv.style.display = 'none';
                stickySummaryDiv.style.display = 'none';
            }

            const targetOTEarnings = parseFloat(document.getElementById('targetOTEarnings').value) || 0;
            const otProgressBarContainer = document.getElementById('otTargetProgressBarContainer');
            if (targetOTEarnings > 0) {
                otProgressBarContainer.style.display = 'block';
                const otProgress = document.getElementById('otTargetProgress');
                const percent = Math.min((totalAmount / targetOTEarnings) * 100, 100);
                otProgress.style.width = `${percent}%`;
                otProgress.textContent = `${fmtRM(totalAmount)} / ${fmtRM(targetOTEarnings)} (${percent.toFixed(1)}%)`;
            } else {
                otProgressBarContainer.style.display = 'none';
            }
        }
        
        function adjustHour(id, amount) {
            const entryIndex = overtimeEntries.findIndex(e => e.id == id);
            if (entryIndex === -1) return;
            
            const entry = overtimeEntries[entryIndex];
            entry.hours += amount;
            if (entry.hours < 0) entry.hours = 0;

            const hourlyRate = salaryData.basic / 26 / 8;
            entry.amount = entry.hours * entry.rate * hourlyRate;

            if (entry.startTime) {
                const [startHour, startMinute] = entry.startTime.split(':').map(Number);
                const totalMinutes = (startHour * 60) + startMinute + (entry.hours * 60);
                const endHour = Math.floor(totalMinutes / 60);
                const endMinute = Math.round(totalMinutes % 60);
                entry.endTime = `${String(endHour % 24).padStart(2, '0')}:${String(endMinute).padStart(2, '0')}`;
            }

            saveDataForPeriod(currentPayPeriod);
            displayOTEntries();
            updateDashboard();
        }

        function adjustHoursByDayType(dayType, adjustment) {
            const hourlyRate = salaryData.basic / 26 / 8;
            
            const entriesForDayType = overtimeEntries.filter(e => getDayType(e) === dayType);
            if (entriesForDayType.length === 0) return;

            let totalOriginalHours = 0;
            entriesForDayType.forEach(e => totalOriginalHours += e.hours);

            if (totalOriginalHours + adjustment < 0) {
                alert("Cannot reduce hours below zero.");
                return;
            }

            const newTotalHours = totalOriginalHours + adjustment;
            const scalingFactor = newTotalHours / totalOriginalHours;

            entriesForDayType.forEach(entry => {
                entry.hours *= scalingFactor;
                entry.amount = entry.hours * hourlyRate * entry.rate;
                if (entry.startTime) {
                    const [startHour, startMinute] = entry.startTime.split(':').map(Number);
                    const totalMinutes = (startHour * 60) + startMinute + (entry.hours * 60);
                    const endHour = Math.floor(totalMinutes / 60);
                    const endMinute = Math.round(totalMinutes % 60);
                    entry.endTime = `${String(endHour % 24).padStart(2, '0')}:${String(endMinute).padStart(2, '0')}`;
                }
            });

            saveDataForPeriod(currentPayPeriod);
            displayOTEntries();
            updateDashboard();
        }
        
        function saveOTEntry(id) {
            const row = document.getElementById(`ot-row-${id}`);
            const inputs = row.querySelectorAll('input, select');
            const entryIndex = overtimeEntries.findIndex(e => e.id == id);
            if (entryIndex === -1) return;

            const date = inputs[0].value;
            const startTime = inputs[1].value;
            const endTime = inputs[2].value;
            let hours = parseFloat(inputs[3].value);
            const rate = parseFloat(inputs[4].value);
            const remarks = inputs[5].value;

            if (startTime && endTime) {
                const start = new Date(`${date}T${startTime}`);
                const end = new Date(`${date}T${endTime}`);
                if (end < start) { end.setDate(end.getDate() + 1); }
                const diffMs = end - start;
                const rawHours = diffMs / (1000 * 60 * 60);
                hours = Math.round(rawHours * 4) / 4;
            }
            
            if (hours > 24) {
                alert("An overtime entry cannot exceed 24 hours.");
                displayOTEntries();
                return;
            }

            const hourlyRate = salaryData.basic / 26 / 8;

            overtimeEntries[entryIndex] = {
                ...overtimeEntries[entryIndex],
                date: date, startTime: startTime, endTime: endTime,
                hours: hours, rate: rate, remarks: remarks,
                amount: hours * rate * hourlyRate
            };
            saveDataForPeriod(currentPayPeriod);
            displayOTEntries();
            updateDashboard();
        }

        function deleteOTEntry(id) {
            overtimeEntries = overtimeEntries.filter(e => e.id != id);
            saveDataForPeriod(currentPayPeriod);
            displayOTEntries();
            updateDashboard();
        }

        function deleteAllOTEntries() {
            if (confirm("Are you sure you want to delete ALL overtime entries? This action cannot be undone.")) {
                overtimeEntries = [];
                saveDataForPeriod(currentPayPeriod);
                displayOTEntries();
                updateDashboard();
                showToast("All overtime entries have been deleted.");
            }
        }
        
        // --- NEW/MODIFIED EXPENSE FUNCTIONS (IMPROVED) ---
        function getRatioFromProfile(profile){
          if (profile==='equal50') return .5;
          if (profile==='mine100') return 1;
          if (profile==='partner100') return 0;
          return null; // custom
        }

        function applySplitProfile() {
          const full = parseFloat(document.getElementById('expenseFullAmount').value)||0;
          const profile = document.getElementById('expenseSplitProfile').value;
          const r = getRatioFromProfile(profile);
          if (r==null) { validateExpenseForm(); return; }
          const my = round2(full*r);
          const her = round2(full-my);
          document.getElementById('myShare').value = my;
          document.getElementById('partnerShare').value = her;
          validateExpenseForm();
        }

        function updateShares(whoChanged){
          const prof = document.getElementById('expenseSplitProfile');
          const fullEl = document.getElementById('expenseFullAmount');
          const mineEl = document.getElementById('myShare');
          const herEl  = document.getElementById('partnerShare');
          if (prof.value!=='custom') prof.value='custom';

          const full = parseFloat(fullEl.value)||0;
          let my  = parseFloat(mineEl.value)||0;
          let her = parseFloat(herEl.value)||0;

          if (whoChanged==='mine') her = Math.max(0, round2(full - my));
          else if (whoChanged==='partner') my = Math.max(0, round2(full - her));

          mineEl.value = my; 
          herEl.value = her; 
          fullEl.value = round2(my+her);
          validateExpenseForm();
        }

        function validateExpenseForm() {
            const full = +document.getElementById('expenseFullAmount').value || 0;
            const my   = +document.getElementById('myShare').value || 0;
            const her  = +document.getElementById('partnerShare').value || 0;
            const ok = full >= 0 && my >= 0 && her >= 0 && Math.round((my + her - full)*100) === 0;
            document.getElementById('addExpenseBtn').disabled = !ok;
        }

        function addExpense() {
            const date = document.getElementById('expenseDate').value;
            const category = document.getElementById('expenseCategory').value;
            const myShare = parseFloat(document.getElementById('myShare').value) || 0;
            const partnerShare = parseFloat(document.getElementById('partnerShare').value) || 0;
            const fullAmount = round2(myShare + partnerShare);
            const description = document.getElementById('expenseDescription').value;
            const isRecurring = document.getElementById('isRecurringExpense').checked;
            const splitProfile = document.getElementById('expenseSplitProfile').value;

            if (!date || !fullAmount) { alert('Please fill in a date and amount.'); return; }
            
            const newExpense = { id: generateId(), date, category, myShare, partnerShare, description, fullAmount, isRecurring, splitProfile, isExcluded: false };
            expenses.push(newExpense);

            if (isRecurring) {
                const recurringExists = recurringExpenses.some(re => re.description === description && re.myShare === myShare && re.partnerShare === partnerShare);
                if (!recurringExists) {
                    recurringExpenses.push({ id: generateId(), category, myShare, partnerShare, description, fullAmount, splitProfile });
                    localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
                }
            }

            saveDataForPeriod(currentPayPeriod);
            displayExpenses();
            updateDashboard();
            
            document.getElementById('myShare').value = '';
            document.getElementById('partnerShare').value = '';
            document.getElementById('expenseFullAmount').value = '';
            document.getElementById('expenseDescription').value = '';
            document.getElementById('isRecurringExpense').checked = false;
            validateExpenseForm();
        }
        
        function sortExpenses(column) {
            if (expenseSortColumn === column) {
                expenseSortDirection = expenseSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                expenseSortColumn = column;
                expenseSortDirection = ['date', 'myShare', 'partnerShare', 'fullAmount'].includes(column) ? 'desc' : 'asc';
            }
            displayExpenses();
        }

        function displayExpenses() {
            const tbody = document.getElementById('expenseTableBody');
            const tfoot = document.getElementById('expenseTableFooter');
            tbody.innerHTML = '';
            tfoot.innerHTML = '';

            const direction = expenseSortDirection === 'asc' ? 1 : -1;
            expenses.sort((a, b) => {
                let valA = a[expenseSortColumn];
                let valB = b[expenseSortColumn];

                if (expenseSortColumn === 'date') {
                    valA = new Date(valA);
                    valB = new Date(valB);
                }
                
                if (typeof valA === 'string') {
                    return valA.localeCompare(valB) * direction;
                } else {
                    return (valA - valB) * direction;
                }
            });
            
            document.querySelectorAll('#expenseTable th.sortable').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
                if (th.getAttribute('onclick').includes(`'${expenseSortColumn}'`)) {
                    th.classList.add(expenseSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
                }
            });

            
            let totalMyShare = 0;
            let totalPartnerShare = 0;
            let totalFullAmount = 0;
            
            expenses.forEach(expense => {
                if (!expense.isExcluded) {
                    totalMyShare += expense.myShare;
                    totalPartnerShare += expense.partnerShare || 0;
                    totalFullAmount += expense.fullAmount || 0;
                }

                const profileMap = {'equal50': '50/50', 'mine100': 'Mine 100%', 'partner100': 'Partner 100%', 'custom': 'Custom'};
                const profileText = profileMap[expense.splitProfile] || 'Custom';

                const row = tbody.insertRow();
                row.id = `exp-row-${expense.id}`;
                if (expense.isExcluded) {
                    row.classList.add('excluded-expense');
                }
                row.innerHTML = `
                    <td onclick="makeEditable(this, '${expense.id}', 'date')">${expense.date}</td>
                    <td onclick="makeEditable(this, '${expense.id}', 'category')"><span class="expense-category category-${expense.category.replace(/_/g, '-')}">${expense.category.replace(/_/g, ' ')}</span></td>
                    <td onclick="makeEditable(this, '${expense.id}', 'description')">${expense.description}</td>
                    <td onclick="makeEditable(this, '${expense.id}', 'splitProfile')"><span class="split-pill">${profileText}</span></td>
                    <td onclick="makeEditable(this, '${expense.id}', 'myShare')">${fmtRM(expense.myShare)}</td>
                    <td onclick="makeEditable(this, '${expense.id}', 'partnerShare')">${fmtRM(expense.partnerShare || 0)}</td>
                    <td>${fmtRM(expense.fullAmount || 0)}</td>
                    <td style="text-align: center;"><input type="checkbox" onchange="toggleRecurringStatus('${expense.id}', this.checked)" ${expense.isRecurring ? 'checked' : ''}></td>
                    <td style="text-align: center;"><input type="checkbox" onchange="toggleExpenseExclusion('${expense.id}', this.checked)" ${expense.isExcluded ? 'checked' : ''}></td>
                    <td>
                        <button class="btn btn-small btn-danger" onclick="deleteExpense('${expense.id}')">Delete</button>
                    </td>`;
            });

            const footerRow = tfoot.insertRow();
            footerRow.style.fontWeight = 'bold';
            footerRow.innerHTML = `
                <td colspan="4" style="text-align: right;">Included Subtotal:</td>
                <td>${fmtRM(totalMyShare)}</td>
                <td>${fmtRM(totalPartnerShare)}</td>
                <td>${fmtRM(totalFullAmount)}</td>
                <td colspan="3"></td>
            `;

            if (!manualExpenseSet) {
                const useHousehold = document.getElementById('useHouseholdExpenses')?.checked || false;
                const expectedExpensesInput = document.getElementById('expectedExpenses');
                const expenseSum = getExpensesSum(useHousehold);
                expectedExpensesInput.value = expenseSum > 0 ? expenseSum.toFixed(2) : '';
                savingsGoalsData.expectedExpenses = expenseSum;
                updateSavingsAnalysis();
            }
        }

        function makeEditable(cell, id, field) {
            if (cell.querySelector('input, select')) return;
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;

            let inputElement;

            const commitChanges = (newValue) => {
                const expenseIndex = expenses.findIndex(e => e.id === id);
                if (expenseIndex === -1) {
                    displayExpenses();
                    return;
                }

                if (field === 'myShare' || field === 'partnerShare') {
                    expenses[expenseIndex][field] = parseFloat(newValue) || 0;
                    const myShare = expenses[expenseIndex].myShare || 0;
                    const partnerShare = expenses[expenseIndex].partnerShare || 0;
                    expenses[expenseIndex].fullAmount = round2(myShare + partnerShare);
                    expenses[expenseIndex].splitProfile = 'custom';
                } else if (field === 'splitProfile') {
                    expenses[expenseIndex].splitProfile = newValue;
                    const ratio = getRatioFromProfile(newValue);
                    if (ratio !== null) {
                        const full = expenses[expenseIndex].fullAmount || 0;
                        expenses[expenseIndex].myShare = round2(full * ratio);
                        expenses[expenseIndex].partnerShare = round2(full - expenses[expenseIndex].myShare);
                    }
                }
                else {
                    expenses[expenseIndex][field] = newValue;
                }
                
                saveDataForPeriod(currentPayPeriod);
                updateDashboard();
                updateSummary();
                displayExpenses();
            };
            
            switch (field) {
                case 'date':
                    inputElement = document.createElement('input');
                    inputElement.type = 'text';
                    inputElement.value = expense.date;
                    break;
                case 'category':
                    inputElement = document.createElement('select');
                    inputElement.innerHTML = document.getElementById('expenseCategory').innerHTML;
                    inputElement.value = expense.category;
                    break;
                case 'description':
                    inputElement = document.createElement('input');
                    inputElement.type = 'text';
                    inputElement.value = expense.description;
                    break;
                case 'myShare':
                case 'partnerShare':
                    inputElement = document.createElement('input');
                    inputElement.type = 'number';
                    inputElement.step = '0.01';
                    inputElement.value = expense[field] || 0;
                    break;
                case 'splitProfile':
                    inputElement = document.createElement('select');
                    inputElement.innerHTML = document.getElementById('expenseSplitProfile').innerHTML;
                    inputElement.value = expense.splitProfile;
                    break;
                default:
                    return;
            }

            cell.innerHTML = '';
            cell.appendChild(inputElement);

            if (field === 'date') {
                const fp = flatpickr(inputElement, {
                    dateFormat: "Y-m-d",
                    defaultDate: expense.date,
                    onClose: (selectedDates, dateStr, instance) => {
                        commitChanges(dateStr);
                    }
                });
                fp.open();
            } else {
                inputElement.focus();
                inputElement.onblur = () => commitChanges(inputElement.value);
                inputElement.onkeydown = (e) => {
                    if (e.key === 'Enter') inputElement.blur();
                    else if (e.key === 'Escape') {
                        displayExpenses();
                    }
                };
            }
        }
        
        function deleteExpense(id) {
            const expenseIndex = expenses.findIndex(e => e.id === id);
            if (expenseIndex > -1) {
                const expenseToDelete = expenses[expenseIndex];
                if (expenseToDelete.isRecurring) {
                    const recurringIndex = recurringExpenses.findIndex(re => re.description === expenseToDelete.description && re.myShare === expenseToDelete.myShare);
                    if (recurringIndex > -1) {
                        recurringExpenses.splice(recurringIndex, 1);
                        localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
                    }
                }
                expenses.splice(expenseIndex, 1);
                saveDataForPeriod(currentPayPeriod);
                displayExpenses();
                updateDashboard();
            }
        }
        
        // --- SAVINGS ANALYSIS & OT CALCULATION ---
        function getExpensesSum(useHousehold=false){
          return expenses
            .filter(e => !e.isExcluded)
            .reduce((s,e)=> s + (useHousehold ? (e.fullAmount||0) : (e.myShare||0)), 0);
        }

        function updateSavingsAnalysis() {
            const targetSavings = parseFloat(document.getElementById('targetSavings').value) || 0;
            const analysisDiv = document.getElementById('savingsAnalysis');
            const useHousehold = document.getElementById('useHouseholdExpenses')?.checked || false;

            document.getElementById('expenseBasisLabel').textContent = useHousehold ? '(Household)' : '(Your Share)';

            const expectedExpensesValue = getExpensesSum(useHousehold);
            document.getElementById('expectedExpenses').value = expectedExpensesValue > 0 ? expectedExpensesValue.toFixed(2) : '';
            savingsGoalsData.expectedExpenses = expectedExpensesValue;
            
            runAICoach(); // Run AI coach whenever analysis is updated

            if (!targetSavings) {
                analysisDiv.style.display = 'none';
                return;
            }
            
            const grossIncome = (salaryData.basic || 0) + (salaryData.claims || 0) + (salaryData.hpAllowance || 0) + (salaryData.incentive || 0) + (salaryData.bonus || 0) + (salaryData.otherIncome || 0);
            const totalDeductions = (salaryData.epf || 0) + (salaryData.socso || 0) + (salaryData.eis || 0) + (salaryData.pcb || 0) + (salaryData.cashAdvance || 0) + (salaryData.otherDeductions || 0);
            const baseNetIncome = grossIncome - totalDeductions;
            
            const afterExpenses = baseNetIncome - expectedExpensesValue;
            const otRequired = Math.max(0, targetSavings - afterExpenses);
            const hourlyRate = getHourlyRate();
            const hoursNeeded = hourlyRate > 0 ? otRequired / (hourlyRate * 1.5) : 0;
            
            analysisDiv.style.display = 'block';
            document.getElementById('baseNetIncome').textContent = fmtRM(baseNetIncome);
            document.getElementById('afterExpenses').textContent = fmtRM(afterExpenses);
            document.getElementById('otRequired').textContent = fmtRM(otRequired);
            document.getElementById('hoursNeeded').textContent = `${hoursNeeded.toFixed(1)} hrs`;
            
            const alertDiv = document.getElementById('savingsAlert');
            if (otRequired === 0 && baseNetIncome > 0) {
                alertDiv.className = 'alert alert-success';
                alertDiv.innerHTML = '✅ Great! You can achieve your savings target without overtime!';
            } else if (baseNetIncome > 0) {
                alertDiv.className = 'alert alert-warning';
                alertDiv.innerHTML = `⚠️ You need ${hoursNeeded.toFixed(1)} hours of overtime to reach your target.`;
                if(useHousehold) {
                    alertDiv.innerHTML += '<br><small><b>Note:</b> OT required is based on your income only; partner income is not included in this calculation.</small>';
                }
            } else {
                 alertDiv.className = 'alert alert-info';
                 alertDiv.innerHTML = 'Enter your salary details to begin the analysis.';
            }
        }

        function autoGenerateOTForTarget() {
            const otRequiredText = document.getElementById('otRequired').textContent;
            const otRequired = parseFloat(otRequiredText.replace('RM ', '')) || 0;
            if (otRequired <= 0.01) { showToast('No OT needed — already on target.'); return; }

            document.getElementById('targetOTEarnings').value = otRequired.toFixed(2);
            handleRealtimeAllocation();
        }
        
        function refreshSavingsHeader(){
          const actual = parseFloat(document.getElementById('savingsActual').dataset.value || '0') || 0;
          const target = +document.getElementById('targetSavings').value || 0;
          const ind = document.getElementById('savingsIndicator');
          const btn = document.getElementById('meetTargetBtn');
          const indContainer = document.getElementById('savingsIndicatorContainer');

          if (target === 0) {
              indContainer.style.display = 'none';
              return;
          }
          
          indContainer.style.display = 'block';
          if (actual >= target){
            ind.className='savings-indicator savings-good';
            ind.textContent='On Track';
            btn.style.display='none';
          } else {
            const gap = (target-actual).toFixed(2);
            ind.className='savings-indicator savings-warning';
            ind.textContent=`Short by RM ${gap}`;
            btn.style.display='inline-block';
          }
        }

        function updateDashboard() {
            const totalOT = overtimeEntries.reduce((sum, e) => sum + e.amount, 0);
            const grossIncome = (salaryData.basic || 0) + (salaryData.claims || 0) + (salaryData.hpAllowance || 0) + (salaryData.incentive || 0) + (salaryData.bonus || 0) + (salaryData.otherIncome || 0) + totalOT;
            const totalDeductions = (salaryData.epf || 0) + (salaryData.socso || 0) + (salaryData.eis || 0) + (salaryData.pcb || 0) + (salaryData.cashAdvance || 0) + (salaryData.otherDeductions || 0);
            const netIncome = grossIncome - totalDeductions;
            const totalMyShare = expenses.filter(e => !e.isExcluded).reduce((sum, e) => sum + e.myShare, 0);
            const actualSavings = netIncome - totalMyShare;

            document.getElementById('totalIncome').textContent = fmtRM(grossIncome);
            document.getElementById('netIncome').textContent = fmtRM(netIncome);
            
            const target = parseFloat(document.getElementById('targetSavings').value) || 0;
            document.getElementById('savingsTargetDisplay').textContent = fmtRM(target);
            document.getElementById('savingsActual').dataset.value = actualSavings;
            document.getElementById('savingsActual').textContent = fmtRM(actualSavings);

            refreshSavingsHeader();

            const liveActualSavings = netIncome - totalMyShare;
            const progressPercent = target > 0 ? Math.min((liveActualSavings / target) * 100, 100) : 0;
            const progressBar = document.getElementById('savingsProgress');
            if (progressBar) {
                progressBar.style.width = `${progressPercent}%`;
                progressBar.textContent = `${progressPercent.toFixed(1)}%`;
            }

            const monthSavedEl = document.getElementById('monthSaved');
            if (monthSavedEl) monthSavedEl.textContent = fmtRM(liveActualSavings);
            
            // Update Sinking Funds Dashboard Card
            const totalSinkingFundSavings = sinkingFunds.reduce((sum, fund) => sum + fund.savedAmount, 0);
            document.getElementById('sinkingFundsTotal').textContent = fmtRM(totalSinkingFundSavings);
            
            const upcomingFunds = sinkingFunds.filter(f => new Date(f.dueDate) > new Date()).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
            if (upcomingFunds.length > 0) {
                document.getElementById('nextGoalDue').textContent = `${upcomingFunds[0].name} (${upcomingFunds[0].dueDate})`;
            } else {
                document.getElementById('nextGoalDue').textContent = 'N/A';
            }
        }
        
        // --- ROBUST MEET SAVINGS TARGET LOGIC ---

        function getSavingsGap() {
          const actual = parseFloat(document.getElementById('savingsActual').dataset.value || '0') || 0;
          const target = +document.getElementById('targetSavings').value || 0;
          return round2(target - actual);
        }

        function getHourlyRate() {
          if (!salaryData || !salaryData.basic) return 0;
          return (salaryData.basic / 26) / 8;
        }

        function getCurrentOTWindow() {
          const s = document.getElementById('otStartDate')?.value;
          const e = document.getElementById('otEndDate')?.value;
          if (!s || !e) return null;
          return { start: new Date(s), end: new Date(e) };
        }

        function pickNextWorkdayString(win) {
          const today = new Date();
          let d = new Date(Math.max(today, win.start));
          while (d <= win.end && (d.getDay() === 0)) d.setDate(d.getDate() + 1);
          if (d > win.end) d = new Date(win.start);
          return d.toISOString().slice(0,10);
        }

        function rateForDate(dateStr) {
          const d = new Date(dateStr);
          const dow = d.getDay();
          if (dow === 0) return 0.5;
          if (dow === 6) return 1.5;
          return 1.5;
        }

        function addHoursToTime(startHHMM, hoursDecimal) {
          const [h, m] = startHHMM.split(':').map(Number);
          const totalMin = h*60 + m + Math.round(hoursDecimal * 60);
          const endH = Math.floor((totalMin / 60) % 24);
          const endM = totalMin % 60;
          return String(endH).padStart(2,'0') + ':' + String(endM).padStart(2,'0');
        }

        function meetSavingsTarget() {
          const gap = getSavingsGap();
          if (gap <= 0.01) { showToast('✅ You’re already on target.'); return; }

          const hourly = getHourlyRate();
          if (!hourly) { alert('Please set Basic Salary first, then try again.'); return; }

          const win = getCurrentOTWindow();
          if (!win) { alert('Please set your OT Start/End dates first.'); return; }

          if (!Array.isArray(overtimeEntries) || overtimeEntries.length === 0) {
            const date = pickNextWorkdayString(win);
            const rate = rateForDate(date);
            let hoursNeeded = gap / (hourly * rate);

            hoursNeeded = Math.ceil(hoursNeeded * 4) / 4;
            hoursNeeded = Math.max(1, Math.min(8, hoursNeeded));

            const start = '18:00';
            const end = addHoursToTime(start, hoursNeeded);

            const entry = {
              id: 'ot_' + Date.now(),
              date, startTime: start, endTime: end,
              hours: hoursNeeded,
              rate,
              amount: round2(hoursNeeded * hourly * rate),
              remarks: 'Auto top-up (Meet Target)',
            };

            overtimeEntries.push(entry);
            saveDataForPeriod(currentPayPeriod);
            displayOTEntries();
            updateDashboard();
            showToast('🧩 Added an OT entry to close your target gap.');
            return;
          }

          overtimeEntries.sort((a,b) => (b.rate - a.rate) || (a.hours - b.hours));
          let remaining = gap;

          for (const e of overtimeEntries) {
            if (e.hours >= 8) continue;
            const canAddHrs = 8 - e.hours;
            const addHrsRaw = remaining / (hourly * e.rate);
            let addHrs = Math.min(canAddHrs, Math.ceil(addHrsRaw * 4) / 4);
            if (addHrs <= 0) continue;

            e.hours = round2(e.hours + addHrs);
            e.endTime = addHoursToTime(e.startTime, e.hours);
            e.amount = round2(e.hours * hourly * e.rate);

            remaining = round2(remaining - (addHrs * hourly * e.rate));
            if (remaining <= 0.01) break;
          }

          if (remaining > 0.01) {
            const date = pickNextWorkdayString(win);
            const rate = rateForDate(date);
            let hoursNeeded = remaining / (hourly * rate);
            hoursNeeded = Math.ceil(hoursNeeded * 4) / 4;
            hoursNeeded = Math.max(1, Math.min(8, hoursNeeded));
            const start = '18:00';
            const end = addHoursToTime(start, hoursNeeded);
            overtimeEntries.push({
              id: 'ot_' + Date.now() + '_extra',
              date, startTime: start, endTime: end,
              hours: hoursNeeded,
              rate,
              amount: round2(hoursNeeded * hourly * rate),
              remarks: 'Auto extra top-up',
            });
          }

          saveDataForPeriod(currentPayPeriod);
          displayOTEntries();
          updateDashboard();
          showToast('🎯 Target gap closed via top-up.');
        }
        
        function updateSummary() {
            const totalOT = overtimeEntries.reduce((sum, e) => sum + e.amount, 0);
            const grossIncome = (salaryData.basic || 0) + (salaryData.claims || 0) + (salaryData.hpAllowance || 0) + (salaryData.incentive || 0) + (salaryData.bonus || 0) + (salaryData.otherIncome || 0) + totalOT;
            const totalDeductions = (salaryData.epf || 0) + (salaryData.socso || 0) + (salaryData.eis || 0) + (salaryData.pcb || 0) + (salaryData.cashAdvance || 0) + (salaryData.otherDeductions || 0);
            const netIncome = grossIncome - totalDeductions;
            
            const includedExpenses = expenses.filter(e => !e.isExcluded);
            const totalMyShare = includedExpenses.reduce((sum, e) => sum + e.myShare, 0);
            const totalFullAmount = includedExpenses.reduce((sum, e) => sum + e.fullAmount, 0);

            const expensesToDisplay = summaryView === 'my' ? totalMyShare : totalFullAmount;
            const personalSavings = netIncome - totalMyShare;
            const householdCoverage = netIncome - totalFullAmount;
            const savingsRate = netIncome > 0 ? (personalSavings / netIncome * 100) : 0;
            
            document.getElementById('summaryGross').textContent = fmtRM(grossIncome);
            document.getElementById('summaryDeductions').textContent = fmtRM(totalDeductions);
            document.getElementById('summaryNet').textContent = fmtRM(netIncome);
            document.getElementById('summaryExpenses').textContent = fmtRM(expensesToDisplay);
            document.getElementById('summarySavings').textContent = fmtRM(personalSavings);
            document.getElementById('savingsRate').textContent = `${savingsRate.toFixed(1)}%`;
            
            const householdItem = document.getElementById('summaryHouseholdCoverageItem');
            if (summaryView === 'household') {
                document.getElementById('summaryHouseholdCoverage').textContent = fmtRM(householdCoverage);
                householdItem.style.display = 'block';
            } else {
                householdItem.style.display = 'none';
            }

            document.getElementById('incomeBasic').textContent = fmtRM(salaryData.basic || 0);
            document.getElementById('incomeOT').textContent = fmtRM(totalOT);
            document.getElementById('incomeAllowances').textContent = fmtRM((salaryData.hpAllowance || 0) + (salaryData.incentive || 0));
            document.getElementById('incomeOthers').textContent = fmtRM((salaryData.claims || 0) + (salaryData.bonus || 0) + (salaryData.otherIncome || 0));
            
            const categoryTotals = {};
            includedExpenses.forEach(expense => {
                if (!categoryTotals[expense.category]) categoryTotals[expense.category] = 0;
                const amountToAdd = summaryView === 'my' ? expense.myShare : expense.fullAmount;
                categoryTotals[expense.category] += amountToAdd;
            });
            const breakdownDiv = document.getElementById('categoryBreakdown');
            breakdownDiv.innerHTML = '';
            Object.entries(categoryTotals).forEach(([category, amount]) => {
                const div = document.createElement('div');
                div.className = 'summary-item';
                div.innerHTML = `<div class="stat-label">${category.replace(/_/g, ' ')}</div><div style="font-size: 1.2em; font-weight: bold;">${fmtRM(amount)}</div><div style="font-size: 0.9em; color: #666;">${(expensesToDisplay > 0 ? (amount / expensesToDisplay) * 100 : 0).toFixed(1)}% of total</div>`;
                breakdownDiv.appendChild(div);
            });
        }
        
        function toggleSummaryView(){
          summaryView = summaryView==='my' ? 'household' : 'my';
          document.getElementById('summaryViewToggle').textContent = `View: ${summaryView==='my'?'My Cash Flow':'Household'}`;
          document.getElementById('summaryExpensesLabel').textContent = `Expenses (${summaryView==='my'?'Your Share':'Household'})`;
          document.getElementById('categoryBreakdownTitle').textContent = `Expense Breakdown by Category (${summaryView==='my'?'Your Share':'Household'})`;
          updateSummary();
        }

        function runForecast() {
            let totalIncome = 0, totalExpenses = 0, months = 0;
            const today = new Date();
            for (let i = 1; i <= 3; i++) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const period = getMonthKey(d);
                const pastSalary = JSON.parse(localStorage.getItem(`salaryData_${period}`));
                const pastOT = JSON.parse(localStorage.getItem(`overtimeEntries_${period}`));
                const pastExpenses = JSON.parse(localStorage.getItem(`expenses_${period}`));
                if (pastSalary && pastOT && pastExpenses) {
                    const otTotal = pastOT.reduce((sum, e) => sum + e.amount, 0);
                    totalIncome += (pastSalary.basic || 0) + (pastSalary.claims || 0) + (pastSalary.hpAllowance || 0) + (pastSalary.incentive || 0) + (pastSalary.bonus || 0) + (pastSalary.otherIncome || 0) + otTotal;
                    totalExpenses += pastExpenses.filter(e => !e.isExcluded).reduce((sum, e) => sum + (e.myShare || 0), 0);
                    months++;
                }
            }
            const avgIncome = months > 0 ? totalIncome / months : 0;
            const avgExpenses = months > 0 ? totalExpenses / months : 0;
            
            const forecastedIncomeEl = document.getElementById('forecastedIncome');
            const forecastedExpensesEl = document.getElementById('forecastedExpenses');

            if (forecastedIncomeEl) {
                forecastedIncomeEl.textContent = fmtRM(avgIncome);
            }
            if (forecastedExpensesEl) {
                forecastedExpensesEl.textContent = fmtRM(avgExpenses);
            }
        }

        function runAICoach() {
            const coachSection = document.getElementById('aiCoachSection');
            const suggestionsDiv = document.getElementById('aiCoachSuggestions');
            const applyBtn = document.getElementById('applySavingsPlanBtn');
            const coachText = document.getElementById('aiCoachText');

            suggestionsDiv.innerHTML = ''; // Clear previous suggestions

            const grossIncome = (salaryData.basic || 0) + (salaryData.claims || 0) + (salaryData.hpAllowance || 0) + (salaryData.incentive || 0) + (salaryData.bonus || 0) + (salaryData.otherIncome || 0);
            const totalDeductions = (salaryData.epf || 0) + (salaryData.socso || 0) + (salaryData.eis || 0) + (salaryData.pcb || 0) + (salaryData.cashAdvance || 0) + (salaryData.otherDeductions || 0);
            const netIncome = grossIncome - totalDeductions;
            const totalMyShare = getExpensesSum(false);
            let surplus = netIncome - totalMyShare;

            if (surplus <= 0) {
                coachSection.style.display = 'none';
                return;
            }

            coachSection.style.display = 'block';
            coachText.innerHTML = `You have a surplus of <strong>${fmtRM(surplus)}</strong> this month. Here's a suggested allocation plan:`;
            
            aiSavingsPlan = { total: 0, allocations: [] };
            let totalAllocated = 0;

            // 1. Emergency Fund
            const emergencyGoal = savingsGoalsData.emergencyFundGoal || 0;
            const emergencyCurrent = savingsGoalsData.currentEmergencyFund || 0;
            if (emergencyCurrent < emergencyGoal) {
                const emergencyNeeded = emergencyGoal - emergencyCurrent;
                // Suggest allocating a significant portion, e.g., 50% of surplus, but not more than needed
                let emergencyAllocation = Math.min(emergencyNeeded, surplus * 0.5);
                emergencyAllocation = round2(emergencyAllocation);
                
                if (emergencyAllocation > 0) {
                    aiSavingsPlan.allocations.push({ name: 'Emergency Fund', amount: emergencyAllocation });
                    surplus -= emergencyAllocation;
                    totalAllocated += emergencyAllocation;
                }
            }

            // 2. Sinking Funds
            sinkingFunds.forEach(fund => {
                const today = new Date();
                const due = new Date(fund.dueDate);
                const monthsLeft = Math.max(1, (due.getFullYear() - today.getFullYear()) * 12 + (due.getMonth() - today.getMonth()));
                const monthlyContribution = (fund.totalAmount - fund.savedAmount) / monthsLeft;

                if (monthlyContribution > 0 && surplus > 0) {
                    const allocation = Math.min(surplus, monthlyContribution);
                    aiSavingsPlan.allocations.push({ name: `Goal: ${fund.name}`, amount: allocation });
                    surplus -= allocation;
                    totalAllocated += allocation;
                }
            });

            // 3. General Savings
            if (surplus > 0) {
                aiSavingsPlan.allocations.push({ name: 'Flexible Savings', amount: surplus });
                totalAllocated += surplus;
            }

            aiSavingsPlan.total = round2(totalAllocated);

            // Display suggestions
            aiSavingsPlan.allocations.forEach(alloc => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.innerHTML = `<span>${alloc.name}</span><strong>${fmtRM(alloc.amount)}</strong>`;
                suggestionsDiv.appendChild(item);
            });

            if (aiSavingsPlan.total > 0) {
                applyBtn.style.display = 'block';
            } else {
                applyBtn.style.display = 'none';
            }
        }

        function applyAISavingsPlan() {
            if (aiSavingsPlan.total > 0) {
                document.getElementById('targetSavings').value = aiSavingsPlan.total.toFixed(2);
                updateAndSaveSavingsGoals();
                showToast('AI Savings Plan applied to your monthly target!');
            }
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            if (toast) {
                toast.textContent = message;
                toast.style.display = 'block';
                setTimeout(() => {
                    toast.style.opacity = '1';
                    toast.style.top = '30px';
                }, 100);

                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.top = '20px';
                    setTimeout(() => {
                        toast.style.display = 'none';
                    }, 500);
                }, 4000);
            }
        }
        
        function exportData() {
            const dataToExport = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('salaryData_') || key.startsWith('overtimeEntries_') || key.startsWith('expenses_') || key.startsWith('savingsGoalsData_') || key === 'recurringExpenses' || key === 'lastPayPeriod' || key === 'sinkingFunds') {
                    dataToExport[key] = localStorage.getItem(key);
                }
            }

            const jsonString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const date = new Date().toISOString().split('T')[0];
            a.href = url;
            a.download = `salary-tracker-backup-${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Data exported successfully!');
        }

        function triggerImport() {
            document.getElementById('import-file').click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!confirm('This will overwrite all existing data. Are you sure you want to continue?')) {
                        return;
                    }
                    
                    localStorage.clear();
                    
                    for (const key in importedData) {
                        if (Object.prototype.hasOwnProperty.call(importedData, key)) {
                            localStorage.setItem(key, importedData[key]);
                        }
                    }
                    
                    showToast('Data imported successfully! Reloading...');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);

                } catch (error) {
                    alert('Error parsing JSON file. Please make sure it is a valid backup file.');
                    console.error("Import error:", error);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // --- RECURRING EXPENSES FUNCTIONS ---
        function toggleRecurringStatus(expenseId, isChecked) {
            const expenseIndex = expenses.findIndex(e => e.id === expenseId);
            if (expenseIndex === -1) return;

            expenses[expenseIndex].isRecurring = isChecked;

            const expense = expenses[expenseIndex];
            const recurringIndex = recurringExpenses.findIndex(re => re.description === expense.description && re.myShare === expense.myShare && re.partnerShare === expense.partnerShare);

            if (isChecked) {
                if (recurringIndex === -1) {
                    recurringExpenses.push({ id: generateId(), category: expense.category, myShare: expense.myShare, partnerShare: expense.partnerShare, description: expense.description, fullAmount: expense.fullAmount, splitProfile: expense.splitProfile });
                    localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
                }
            } else {
                if (recurringIndex > -1) {
                    recurringExpenses.splice(recurringIndex, 1);
                    localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
                }
            }
            saveDataForPeriod(currentPayPeriod);
            showToast(`Expense marked as ${isChecked ? 'recurring' : 'not recurring'}.`);
        }
        
        // --- NEW: EXCLUDE EXPENSE FUNCTION ---
        function toggleExpenseExclusion(expenseId, isChecked) {
            const expenseIndex = expenses.findIndex(e => e.id === expenseId);
            if (expenseIndex === -1) return;

            expenses[expenseIndex].isExcluded = isChecked;
            saveDataForPeriod(currentPayPeriod);
            
            // Refresh all relevant parts of the UI
            displayExpenses();
            updateDashboard();
            updateSummary();
            updateSavingsAnalysis();
            showToast(`Expense ${isChecked ? 'excluded from' : 'included in'} totals.`);
        }

        function applyRecurringExpenses() {
            if (recurringExpenses.length === 0) {
                alert('You have no recurring expenses saved. Mark an expense as recurring to save it.');
                return;
            }

            let addedCount = 0;
            const firstDayOfMonth = `${currentPayPeriod}-01`;

            recurringExpenses.forEach(recurring => {
                const isDuplicate = expenses.some(exp => 
                    exp.description === recurring.description && exp.myShare === recurring.myShare && exp.isRecurring
                );

                if (!isDuplicate) {
                    expenses.push({
                        ...recurring,
                        id: generateId(),
                        date: firstDayOfMonth,
                        isRecurring: true,
                        isExcluded: false // Default to not excluded
                    });
                    addedCount++;
                }
            });

            if (addedCount > 0) {
                saveDataForPeriod(currentPayPeriod);
                displayExpenses();
                updateDashboard();
                showToast(`${addedCount} recurring expense(s) applied for this month.`);
            } else {
                showToast('All recurring expenses have already been applied for this month.');
            }
        }

        // --- COPY LAST MONTH FUNCTIONS ---
        function getPreviousMonthPeriod(period) {
            const [year, month] = period.split('-').map(Number);
            const date = new Date(year, month - 2, 1, 12, 0, 0); 
            return getMonthKey(date);
        }

        function copyLastMonthSalary(isSilent = false) {
            const prevPeriod = getPreviousMonthPeriod(currentPayPeriod);
            const prevSalaryData = localStorage.getItem(`salaryData_${prevPeriod}`);

            if (!prevSalaryData) {
                if (!isSilent) alert(`No salary data found for the previous month (${prevPeriod}).`);
                return false;
            }
            
            const proceed = isSilent ? true : confirm(`This will overwrite the current salary data with data from ${prevPeriod}. Continue?`);

            if (proceed) {
                salaryData = JSON.parse(prevSalaryData);
                delete salaryData.customOtStartDate;
                delete salaryData.customOtEndDate;
                
                document.getElementById('basicSalary').value = salaryData.basic || '';
                document.getElementById('claims').value = salaryData.claims || '';
                document.getElementById('hpAllowance').value = salaryData.hpAllowance || '';
                document.getElementById('incentive').value = salaryData.incentive || '';
                document.getElementById('bonus').value = salaryData.bonus || '';
                document.getElementById('otherIncome').value = salaryData.otherIncome || '';
                document.getElementById('cashAdvance').value = salaryData.cashAdvance || '';
                document.getElementById('otherDeductions').value = salaryData.otherDeductions || '';
                
                autoCalculateDeductions();
                if (!isSilent) showToast(`Salary data from ${prevPeriod} has been copied.`);
                return true;
            }
            return false;
        }

        function copyLastMonthExpenses(isSilent = false) {
            const prevPeriod = getPreviousMonthPeriod(currentPayPeriod);
            const prevExpensesData = localStorage.getItem(`expenses_${prevPeriod}`);

            if (!prevExpensesData) {
                if (!isSilent) alert(`No expense data found for the previous month (${prevPeriod}).`);
                return false;
            }
            
            const proceed = isSilent ? true : confirm(`This will REPLACE all current expenses with the data from ${prevPeriod}. Continue?`);

            if (proceed) {
                const lastMonthExpenses = JSON.parse(prevExpensesData);
                const [currentYear, currentMonth] = currentPayPeriod.split('-').map(Number);
                
                expenses = lastMonthExpenses.map(exp => {
                    const oldDate = new Date(exp.date);
                    const newDay = Math.min(oldDate.getUTCDate(), new Date(currentYear, currentMonth, 0).getDate());
                    const newDate = new Date(Date.UTC(currentYear, currentMonth - 1, newDay));
                    
                    return {
                        ...exp,
                        id: generateId(),
                        date: newDate.toISOString().split('T')[0]
                    };
                });

                saveDataForPeriod(currentPayPeriod);
                displayExpenses();
                updateDashboard();
                if (!isSilent) showToast(`Expenses from ${prevPeriod} have been copied.`);
                return true;
            }
            return false;
        }

        // --- SETTLE UP REPORT (IMPROVED) ---
        const DEFAULT_RATIO = 0.5;
        function generateSettleUpReport(){
          const includedExpenses = expenses.filter(e => !e.isExcluded);
          const totalHousehold = includedExpenses.reduce((s,e)=> s + (e.fullAmount || 0), 0);
          const iPaid = includedExpenses.reduce((s,e)=> s + (e.myShare || 0), 0);
          const myBaseline = round2(totalHousehold * DEFAULT_RATIO);
          const net = round2(iPaid - myBaseline);
          const msg = net>0 ? `Partner owes you ${fmtRM(net)}` :
                     net<0 ? `You owe partner ${fmtRM(Math.abs(net))}` :
                             'All settled — perfectly split.';

          document.getElementById('settleup-content').innerHTML = `
            <p>Total Household (Included Expenses): <strong>${fmtRM(totalHousehold)}</strong></p>
            <p>You Paid (Your Share): <strong>${fmtRM(iPaid)}</strong></p>
            <p>Your Baseline (${DEFAULT_RATIO*100}%): <strong>${fmtRM(myBaseline)}</strong></p>
            <hr><h3>${msg}</h3>`;
          document.getElementById('settleup-modal').style.display='flex';
        }

        function closeSettleUp() {
            document.getElementById('settleup-modal').style.display = 'none';
        }
        
        // --- NEW: PDF EXPORT ---
        function launchExportPDFModal() {
            const titleInput = document.getElementById('pdfReportTitle');
            const monthName = document.getElementById('currentMonth').value;
            titleInput.value = `${monthName} Expense Report`;
            document.getElementById('export-pdf-modal').style.display = 'flex';
        }

        function closeExportPDFModal() {
            document.getElementById('export-pdf-modal').style.display = 'none';
        }

        async function exportExpensesToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const includeExcluded = document.getElementById('pdfIncludeExcluded').checked;
            const reportTitle = document.getElementById('pdfReportTitle').value || 'Expense Report';
            const expensesToExport = includeExcluded ? expenses : expenses.filter(e => !e.isExcluded);

            if (expensesToExport.length === 0) {
                alert('No expenses to export for the selected criteria.');
                return;
            }

            // --- 1. Create Summary UI for PDF ---
            const summaryContainer = document.createElement('div');
            summaryContainer.id = 'pdf-summary-container';
            summaryContainer.style.position = 'absolute';
            summaryContainer.style.left = '-9999px'; // Position off-screen
            summaryContainer.style.padding = '20px';
            summaryContainer.style.fontFamily = 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
            summaryContainer.style.width = '800px';
            summaryContainer.style.background = 'white';

            const summaryExpenses = expenses.filter(e => !e.isExcluded);
            const totalMyShare = summaryExpenses.reduce((sum, exp) => sum + exp.myShare, 0);
            const totalPartnerShare = summaryExpenses.reduce((sum, exp) => sum + (exp.partnerShare || 0), 0);
            const totalFullAmount = summaryExpenses.reduce((sum, exp) => sum + (exp.fullAmount || 0), 0);

            summaryContainer.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div style="border: 1px solid #eee; border-radius: 10px; padding: 15px; text-align: center; background: #f8f9fa;">
                        <div style="font-size: 12px; color: #666;">My Share</div>
                        <div style="font-size: 24px; font-weight: bold; color: #667eea; margin-top: 5px;">${fmtRM(totalMyShare)}</div>
                    </div>
                    <div style="border: 1px solid #eee; border-radius: 10px; padding: 15px; text-align: center; background: #f8f9fa;">
                        <div style="font-size: 12px; color: #666;">Partner's Share</div>
                        <div style="font-size: 24px; font-weight: bold; color: #764ba2; margin-top: 5px;">${fmtRM(totalPartnerShare)}</div>
                    </div>
                    <div style="border: 1px solid #eee; border-radius: 10px; padding: 15px; text-align: center; background: #f8f9fa;">
                        <div style="font-size: 12px; color: #666;">Total Household</div>
                        <div style="font-size: 24px; font-weight: bold; color: #333; margin-top: 5px;">${fmtRM(totalFullAmount)}</div>
                    </div>
                </div>
            `;
            document.body.appendChild(summaryContainer);

            // --- 2. Render UI to Image ---
            const summaryCanvas = await html2canvas(summaryContainer);
            const summaryImage = summaryCanvas.toDataURL('image/png');
            document.body.removeChild(summaryContainer); // Clean up

            // --- 3. Build PDF ---
            doc.setFontSize(18);
            doc.text(reportTitle, 14, 22);
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`Report for period: ${currentPayPeriod}`, 14, 28);

            // Add Summary Image
            doc.addImage(summaryImage, 'PNG', 14, 35, 180, 40);

            // Add Table
            const tableBody = expensesToExport.map(exp => {
                return [
                    exp.date,
                    exp.category.replace(/_/g, ' '),
                    exp.description,
                    exp.myShare.toFixed(2),
                    (exp.partnerShare || 0).toFixed(2),
                    (exp.fullAmount || 0).toFixed(2)
                ];
            });

            doc.autoTable({
                head: [['Date', 'Category', 'Description', 'My Share', "Partner's Share", 'Full Amount']],
                body: tableBody,
                startY: 85,
                theme: 'grid',
                headStyles: { fillColor: [102, 126, 234] }
            });

            doc.save(`${reportTitle.replace(/ /g, '_')}.pdf`);
            closeExportPDFModal();
        }

        // --- SINKING FUNDS LOGIC ---
        function addSinkingFund() {
            const name = document.getElementById('fundName').value;
            const totalAmount = parseFloat(document.getElementById('fundTotal').value);
            const dueDate = document.getElementById('fundDueDate').value;

            if (!name || !totalAmount || !dueDate) {
                alert('Please fill out all fields for the new goal.');
                return;
            }

            const newFund = {
                id: generateId(),
                name,
                totalAmount,
                dueDate,
                savedAmount: 0,
                allocations: {} // To track monthly contributions
            };

            sinkingFunds.push(newFund);
            saveDataForPeriod(currentPayPeriod);
            displaySinkingFunds();
            
            // Reset form
            document.getElementById('fundName').value = '';
            document.getElementById('fundTotal').value = '';
            fundDueDatePicker.clear();
            showToast(`New goal "${name}" added!`);
        }

        function displaySinkingFunds() {
            const container = document.getElementById('sinkingFundsContainer');
            container.innerHTML = '';
            
            if (sinkingFunds.length === 0) {
                container.innerHTML = '<p>No future goals added yet. Add one above to start planning!</p>';
                return;
            }

            sinkingFunds.forEach(fund => {
                const today = new Date();
                const due = new Date(fund.dueDate);
                const monthsLeft = Math.max(0, (due.getFullYear() - today.getFullYear()) * 12 + (due.getMonth() - today.getMonth()));
                const monthlyContribution = monthsLeft > 0 ? (fund.totalAmount - fund.savedAmount) / monthsLeft : (fund.totalAmount - fund.savedAmount);
                const progress = fund.totalAmount > 0 ? (fund.savedAmount / fund.totalAmount) * 100 : 0;
                
                const hasAllocatedThisMonth = fund.allocations && fund.allocations[currentPayPeriod];

                const card = document.createElement('div');
                card.className = 'sinking-fund-card';
                card.innerHTML = `
                    <h4>${fund.name}</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress.toFixed(1)}%; background: linear-gradient(90deg, #20c997, #28a745);">${progress.toFixed(1)}%</div>
                    </div>
                    <div class="sinking-fund-details">
                        <span>Saved: <strong>${fmtRM(fund.savedAmount)} / ${fmtRM(fund.totalAmount)}</strong></span>
                        <span>Due: <strong>${fund.dueDate}</strong></span>
                    </div>
                    <div class="sinking-fund-details">
                        <span>Monthly: <strong>${fmtRM(monthlyContribution)}</strong></span>
                        <span>Months Left: <strong>${monthsLeft}</strong></span>
                    </div>
                    <button class="btn btn-small" onclick="allocateContribution('${fund.id}')" ${hasAllocatedThisMonth ? 'disabled' : ''}>
                        ${hasAllocatedThisMonth ? `Allocated for ${currentPayPeriod}` : `Allocate ${fmtRM(monthlyContribution)}`}
                    </button>
                    <button class="btn btn-small btn-danger" onclick="deleteSinkingFund('${fund.id}')">Delete Goal</button>
                `;
                container.appendChild(card);
            });
        }
        
        function allocateContribution(fundId) {
            const fundIndex = sinkingFunds.findIndex(f => f.id === fundId);
            if (fundIndex === -1) return;

            const fund = sinkingFunds[fundIndex];
            const today = new Date();
            const due = new Date(fund.dueDate);
            const monthsLeft = Math.max(1, (due.getFullYear() - today.getFullYear()) * 12 + (due.getMonth() - today.getMonth()));
            const monthlyContribution = (fund.totalAmount - fund.savedAmount) / monthsLeft;

            if (monthlyContribution <= 0) {
                showToast("This goal is already fully funded!", "warning");
                return;
            }

            // Update fund
            fund.savedAmount = round2(fund.savedAmount + monthlyContribution);
            if (!fund.allocations) fund.allocations = {};
            fund.allocations[currentPayPeriod] = true;

            // Create corresponding expense
            const expenseDate = `${currentPayPeriod}-01`;
            const newExpense = {
                id: generateId(),
                date: expenseDate,
                category: 'savings_investments',
                myShare: monthlyContribution,
                partnerShare: 0,
                fullAmount: monthlyContribution,
                description: `Sinking Fund: ${fund.name}`,
                isRecurring: false,
                splitProfile: 'mine100',
                isExcluded: false,
                isSinkingFund: true // Mark as a special expense
            };
            expenses.push(newExpense);

            saveDataForPeriod(currentPayPeriod);
            updateAllDisplays();
            showToast(`Contribution for "${fund.name}" allocated!`);
        }

        function deleteSinkingFund(fundId) {
            if (confirm("Are you sure you want to delete this goal? This cannot be undone.")) {
                sinkingFunds = sinkingFunds.filter(f => f.id !== fundId);
                saveDataForPeriod(currentPayPeriod);
                updateAllDisplays();
                showToast("Goal deleted.");
            }
        }


        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('import-file').addEventListener('change', importData);
            
            document.getElementById('targetSavings').addEventListener('input', updateAndSaveSavingsGoals);
            document.getElementById('emergencyFundGoal').addEventListener('input', updateAndSaveSavingsGoals);
            document.getElementById('currentEmergencyFund').addEventListener('input', updateAndSaveSavingsGoals);
            document.getElementById('expectedExpenses').addEventListener('input', () => {
                manualExpenseSet = true;
                updateAndSaveSavingsGoals();
            });

            document.getElementById('useHouseholdExpenses').addEventListener('change', () => {
                manualExpenseSet = false; // Allow auto-updates to take over again.
                updateSavingsAnalysis();
            });


            ['expenseFullAmount','myShare','partnerShare','expenseSplitProfile']
              .forEach(id => {
                  const el = document.getElementById(id);
                  if(el) el.addEventListener('input', validateExpenseForm)
                });
            
            initializePercentageInputs();
            initializeData();
            validateExpenseForm();
        });
    </script>
</body>
</html>
